# ğŸ‘¨â€ğŸ’» å¼€å‘è€…æŠ€æœ¯æ–‡æ¡£

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç±»ï¼šGenerationProgress

ä½ç½®ï¼š`js/generation-progress.js`

```javascript
class GenerationProgress {
    constructor() {
        this.currentBookId = null;          // å½“å‰ç»˜æœ¬ID
        this.currentStep = 0;               // å½“å‰æ­¥éª¤ (1-3)
        this.isGenerating = false;          // æ˜¯å¦æ­£åœ¨ç”Ÿæˆ
        this.onCancelCallback = null;       // å–æ¶ˆå›è°ƒ
        
        // è„šæœ¬ç”Ÿæˆè¯¦ç»†è¿›åº¦
        this.scriptProgress = {
            phase: 'pending',               // å½“å‰é˜¶æ®µ
            currentPage: 0,                 // å½“å‰é¡µç 
            totalPages: 0                   // æ€»é¡µæ•°
        };
        
        // å›¾ç‰‡ç”Ÿæˆè¯¦ç»†è¿›åº¦
        this.imageProgress = {
            current: 0,                     // å½“å‰å·²ç”Ÿæˆæ•°
            total: 0                        // æ€»æ•°
        };
    }
}
```

---

## æ ¸å¿ƒæ–¹æ³•

### 1. æ˜¾ç¤ºè¿›åº¦çª—å£

```javascript
show(bookId, currentStep = 1)
```

**å‚æ•°ï¼š**
- `bookId`: ç»˜æœ¬ID
- `currentStep`: èµ·å§‹æ­¥éª¤ï¼ˆ1-3ï¼‰

**ç¤ºä¾‹ï¼š**
```javascript
const progress = new GenerationProgress();
progress.show('book-123', 1);
```

---

### 2. æ›´æ–°è„šæœ¬ç”Ÿæˆè¿›åº¦ï¼ˆå…³é”®æ–¹æ³•ï¼‰â­

```javascript
updateScriptProgress(streamContent)
```

**åŠŸèƒ½ï¼š**
é€šè¿‡è¯†åˆ«æµå¼è¾“å‡ºçš„å†…å®¹æ¥åˆ¤æ–­å½“å‰é˜¶æ®µå¹¶æ›´æ–°UI

**è¯†åˆ«è§„åˆ™ï¼š**
| å…³é”®è¯ | åŒ¹é…é€»è¾‘ | æ›´æ–°çŠ¶æ€ | æ˜¾ç¤ºæ–‡æœ¬ |
|-------|---------|---------|---------|
| `"character_models"` | åŒ…å«åˆ¤æ–­ | `phase = 'character_models'` | "æ­£åœ¨ç”Ÿæˆè§’è‰²æ¨¡å‹..." |
| `"scene_models"` | åŒ…å«åˆ¤æ–­ | `phase = 'scene_models'` | "æ­£åœ¨æ„å»ºåœºæ™¯æè¿°..." |
| `"cover"` | åŒ…å«åˆ¤æ–­ | `phase = 'cover'` | "æ­£åœ¨è®¾è®¡å°é¢..." |
| `"page_number": N` | æ­£åˆ™æå– | `phase = 'pages'`<br>`currentPage = N` | "æ­£åœ¨ç”Ÿæˆç¬¬ N é¡µ..." |

**ä»£ç å®ç°ï¼š**
```javascript
updateScriptProgress(streamContent) {
    // è¯†åˆ« character_models
    if (streamContent.includes('"character_models"')) {
        this.scriptProgress.phase = 'character_models';
        this.updateStep(2, 'active');
    }
    // è¯†åˆ« scene_models
    else if (streamContent.includes('"scene_models"')) {
        this.scriptProgress.phase = 'scene_models';
        this.updateStep(2, 'active');
    }
    // è¯†åˆ« cover
    else if (streamContent.includes('"cover"')) {
        this.scriptProgress.phase = 'cover';
        this.updateStep(2, 'active');
    }
    // è¯†åˆ« page_numberï¼ˆæå–é¡µç ï¼‰
    else if (streamContent.includes('"page_number"')) {
        this.scriptProgress.phase = 'pages';
        const match = streamContent.match(/"page_number":\s*(\d+)/);
        if (match) {
            this.scriptProgress.currentPage = parseInt(match[1]);
        }
        this.updateStep(2, 'active');
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```javascript
// åœ¨æ¥æ”¶æµå¼æ•°æ®æ—¶è°ƒç”¨
const reader = response.body.getReader();
const decoder = new TextDecoder();

while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    
    const chunk = decoder.decode(value);
    progress.updateScriptProgress(chunk);  // ğŸ”¥ æ¯æ¬¡éƒ½è°ƒç”¨
}
```

---

### 3. æ›´æ–°å›¾ç‰‡ç”Ÿæˆè¿›åº¦

```javascript
updateImageProgress(current, total)
```

**å‚æ•°ï¼š**
- `current`: å½“å‰å·²ç”Ÿæˆçš„å›¾ç‰‡æ•°é‡
- `total`: æ€»å›¾ç‰‡æ•°é‡

**ç¤ºä¾‹ï¼š**
```javascript
const totalPages = 20;
for (let i = 1; i <= totalPages; i++) {
    await generateImage(i);
    progress.updateImageProgress(i, totalPages);
    // æ˜¾ç¤ºï¼šæ­£åœ¨ç”Ÿæˆæ’å›¾ 5/20
}
```

---

### 4. å®Œæˆæ­¥éª¤

```javascript
completeStep(stepNumber)
```

**å‚æ•°ï¼š**
- `stepNumber`: æ­¥éª¤ç¼–å·ï¼ˆ1-3ï¼‰

**ç¤ºä¾‹ï¼š**
```javascript
// æ­¥éª¤1å®Œæˆ
progress.completeStep(1);

// å¼€å§‹æ­¥éª¤2
progress.setCurrentStep(2);
```

---

### 5. å®Œæˆå…¨éƒ¨æµç¨‹

```javascript
complete(callback)
```

**å‚æ•°ï¼š**
- `callback`: å®Œæˆåçš„å›è°ƒå‡½æ•°

**åŠŸèƒ½ï¼š**
- æ ‡è®°æ‰€æœ‰æ­¥éª¤ä¸ºå®Œæˆ
- 2ç§’åè‡ªåŠ¨å…³é—­çª—å£
- æ‰§è¡Œå›è°ƒå‡½æ•°

**ç¤ºä¾‹ï¼š**
```javascript
progress.complete(() => {
    console.log('å…¨éƒ¨å®Œæˆï¼');
    window.location.href = '/storybook/' + bookId;
});
```

---

## å®Œæ•´é›†æˆç¤ºä¾‹

### åœºæ™¯ï¼šçœŸå®çš„ç»˜æœ¬ç”Ÿæˆæµç¨‹

```javascript
class StorybookGenerator {
    constructor() {
        this.progress = new GenerationProgress();
    }
    
    async generate(outline, bookId) {
        // æ˜¾ç¤ºè¿›åº¦çª—å£
        this.progress.show(bookId, 1);
        
        try {
            // ========== æ­¥éª¤1ï¼šåˆ†æå¤§çº² ==========
            await this.analyzeOutline(outline);
            this.progress.completeStep(1);
            this.progress.setCurrentStep(2);
            
            // ========== æ­¥éª¤2ï¼šç”Ÿæˆè„šæœ¬ ==========
            const script = await this.generateScript(outline);
            this.progress.completeStep(2);
            this.progress.setCurrentStep(3);
            
            // ========== æ­¥éª¤3ï¼šç”Ÿæˆå›¾ç‰‡ ==========
            await this.generateImages(script);
            this.progress.completeStep(3);
            
            // å®Œæˆ
            this.progress.complete(() => {
                window.location.href = `/storybook/${bookId}`;
            });
            
        } catch (error) {
            console.error('ç”Ÿæˆå¤±è´¥:', error);
            this.progress.close();
            alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    
    // åˆ†æå¤§çº²
    async analyzeOutline(outline) {
        const response = await fetch('/api/analyze-outline', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(outline)
        });
        
        return await response.json();
    }
    
    // ç”Ÿæˆè„šæœ¬ï¼ˆæµå¼è¾“å‡ºï¼‰
    async generateScript(outline) {
        const response = await fetch('/api/generate-script', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(outline)
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let scriptData = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            scriptData += chunk;
            
            // ğŸ”¥ å…³é”®ï¼šæ¯æ¬¡æ¥æ”¶æ•°æ®éƒ½æ›´æ–°è¿›åº¦
            this.progress.updateScriptProgress(chunk);
        }
        
        return JSON.parse(scriptData);
    }
    
    // ç”Ÿæˆå›¾ç‰‡
    async generateImages(script) {
        const pages = script.pages;
        const total = pages.length;
        
        for (let i = 0; i < total; i++) {
            const page = pages[i];
            
            // è°ƒç”¨å›¾ç‰‡ç”ŸæˆAPI
            const response = await fetch('/api/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: this.buildPrompt(page, script),
                    style: script.style
                })
            });
            
            const imageData = await response.json();
            page.imageUrl = imageData.url;
            
            // ğŸ”¥ æ›´æ–°å›¾ç‰‡ç”Ÿæˆè¿›åº¦
            this.progress.updateImageProgress(i + 1, total);
        }
        
        return script;
    }
    
    // æ„å»ºå›¾ç‰‡ç”Ÿæˆæç¤ºè¯
    buildPrompt(page, script) {
        let prompt = '';
        
        // æ·»åŠ è§’è‰²æè¿°
        if (page.assets.characters) {
            page.assets.characters.forEach(charName => {
                const char = script.character_models.find(c => c.name === charName);
                if (char) {
                    prompt += `${char.name}ï¼š${char.description}\n`;
                }
            });
        }
        
        // æ·»åŠ åœºæ™¯æè¿°
        if (page.assets.scene) {
            const scene = script.scene_models.find(s => s.name === page.assets.scene);
            if (scene) {
                prompt += `åœºæ™¯ï¼š${scene.description}\n`;
            }
        }
        
        // æ·»åŠ åŠ¨ä½œæè¿°
        if (page.directing.action_description) {
            prompt += `ç”»é¢ï¼š${page.directing.action_description}\n`;
        }
        
        // æ·»åŠ é£æ ¼
        prompt += `é‡‡ç”¨${script.style.name}ï¼š${script.style.description}`;
        
        return prompt;
    }
}

// ä½¿ç”¨
const generator = new StorybookGenerator();
generator.generate(outlineData, 'book-123');
```

---

## çŠ¶æ€ç®¡ç†

### æ­¥éª¤çŠ¶æ€

```javascript
updateStep(stepNumber, status, customDetail = null)
```

**çŠ¶æ€å€¼ï¼š**
- `'pending'` - ç­‰å¾…ä¸­ï¼ˆç°è‰²ï¼‰
- `'active'` - è¿›è¡Œä¸­ï¼ˆè“è‰²ï¼Œæ—‹è½¬å›¾æ ‡ï¼‰
- `'completed'` - å·²å®Œæˆï¼ˆç»¿è‰²ï¼Œå¯¹å‹¾ï¼‰

**UI æ˜ å°„ï¼š**

| çŠ¶æ€ | èƒŒæ™¯è‰² | è¾¹æ¡†è‰² | å›¾æ ‡ | å›¾æ ‡é¢œè‰² | æ ‡ç­¾ |
|-----|--------|--------|------|---------|------|
| pending | `bg-gray-50` | `border-gray-200` | `clock` | `text-gray-500` | ç­‰å¾…ä¸­ |
| active | `bg-blue-50` | `border-blue-300` | `loader-2` (æ—‹è½¬) | `text-white` | è¿›è¡Œä¸­ |
| completed | `bg-green-50` | `border-green-300` | `check-circle` | `text-white` | å·²å®Œæˆ |

---

## è¿›åº¦æ–‡æœ¬ç”Ÿæˆé€»è¾‘

### è„šæœ¬ç”Ÿæˆé˜¶æ®µ

```javascript
getScriptProgressText() {
    const phase = this.scriptProgress.phase;
    
    switch(phase) {
        case 'character_models':
            return 'æ­£åœ¨ç”Ÿæˆè§’è‰²æ¨¡å‹...';
        case 'scene_models':
            return 'æ­£åœ¨æ„å»ºåœºæ™¯æè¿°...';
        case 'cover':
            return 'æ­£åœ¨è®¾è®¡å°é¢...';
        case 'pages':
            if (this.scriptProgress.currentPage > 0) {
                return `æ­£åœ¨ç”Ÿæˆç¬¬ ${this.scriptProgress.currentPage} é¡µ...`;
            }
            return 'æ­£åœ¨ç¼–å†™æ•…äº‹é¡µé¢...';
        default:
            return 'æ­£åœ¨ç¼–å†™è¯¦ç»†çš„æ•…äº‹å†…å®¹...';
    }
}
```

### å›¾ç‰‡ç”Ÿæˆé˜¶æ®µ

```javascript
getImageProgressText() {
    if (this.imageProgress.total > 0 && this.imageProgress.current > 0) {
        return `æ­£åœ¨ç”Ÿæˆæ’å›¾ ${this.imageProgress.current}/${this.imageProgress.total}`;
    }
    return 'æ­£åœ¨ç”Ÿæˆç²¾ç¾æ’å›¾...';
}
```

---

## äº‹ä»¶å¤„ç†

### å–æ¶ˆç”Ÿæˆ

```javascript
// è®¾ç½®å–æ¶ˆå›è°ƒ
progress.onCancel((bookId) => {
    console.log('ç”¨æˆ·å–æ¶ˆäº†ç”Ÿæˆ:', bookId);
    // æ¸…ç†èµ„æºã€ç»ˆæ­¢è¯·æ±‚ç­‰
});

// ç”¨æˆ·ç‚¹å‡»"å–æ¶ˆç”Ÿæˆ"æŒ‰é’®æ—¶ä¼šè§¦å‘æ­¤å›è°ƒ
```

### åå°ç»§ç»­

```javascript
// ç”¨æˆ·ç‚¹å‡»"åœ¨åå°ç»§ç»­"æŒ‰é’®
progress.close(); // å…³é—­çª—å£ï¼Œä½†ä¸ç»ˆæ­¢ç”Ÿæˆ
```

---

## æ¨¡æ‹ŸåŠŸèƒ½ï¼ˆæµ‹è¯•ç”¨ï¼‰

### å®Œæ•´æ¨¡æ‹Ÿæµç¨‹

```javascript
async simulateGeneration()
```

**åŠŸèƒ½ï¼š**
æ¨¡æ‹Ÿå®Œæ•´çš„ç»˜æœ¬ç”Ÿæˆæµç¨‹ï¼Œç”¨äºå¼€å‘å’Œæµ‹è¯•

**æ—¶é—´åˆ†é…ï¼š**
- æ­¥éª¤1ï¼š3ç§’
- æ­¥éª¤2ï¼š
  - character_models: 800ms
  - scene_models: 800ms
  - cover: 600ms
  - 20é¡µ Ã— 300ms = 6ç§’
- æ­¥éª¤3ï¼š20å¼  Ã— 500ms = 10ç§’
- **æ€»è®¡ï¼šçº¦19ç§’**

**è°ƒç”¨æ–¹å¼ï¼š**
```javascript
const progress = new GenerationProgress();
progress.show('test-123', 1);
await progress.simulateGeneration();
```

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. èŠ‚æµæ›´æ–°

é¿å…è¿‡äºé¢‘ç¹çš„UIæ›´æ–°ï¼š

```javascript
class ThrottledProgress extends GenerationProgress {
    constructor() {
        super();
        this.lastUpdateTime = 0;
        this.minUpdateInterval = 100; // æœ€å°æ›´æ–°é—´éš”ï¼š100ms
    }
    
    updateScriptProgress(streamContent) {
        const now = Date.now();
        if (now - this.lastUpdateTime < this.minUpdateInterval) {
            return; // è·³è¿‡æœ¬æ¬¡æ›´æ–°
        }
        
        this.lastUpdateTime = now;
        super.updateScriptProgress(streamContent);
    }
}
```

### 2. æ‰¹é‡æ›´æ–°

ç´¯ç§¯å¤šä¸ªæ›´æ–°ï¼Œä¸€æ¬¡æ€§åº”ç”¨ï¼š

```javascript
class BatchedProgress extends GenerationProgress {
    constructor() {
        super();
        this.updateQueue = [];
        this.batchTimer = null;
    }
    
    updateScriptProgress(streamContent) {
        this.updateQueue.push(streamContent);
        
        if (!this.batchTimer) {
            this.batchTimer = setTimeout(() => {
                // å¤„ç†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ›´æ–°
                const latestContent = this.updateQueue.join('');
                super.updateScriptProgress(latestContent);
                
                this.updateQueue = [];
                this.batchTimer = null;
            }, 100);
        }
    }
}
```

---

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åœºæ™¯

```javascript
async function generateWithErrorHandling() {
    const progress = new GenerationProgress();
    progress.show('book-123', 1);
    
    try {
        // æ­¥éª¤1
        await step1();
        progress.completeStep(1);
        
        // æ­¥éª¤2
        progress.setCurrentStep(2);
        await step2();
        progress.completeStep(2);
        
        // æ­¥éª¤3
        progress.setCurrentStep(3);
        await step3();
        progress.completeStep(3);
        
        progress.complete(() => {
            console.log('æˆåŠŸï¼');
        });
        
    } catch (error) {
        console.error('ç”Ÿæˆå¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        progress.updateStep(progress.currentStep, 'active', 
            `ç”Ÿæˆå¤±è´¥ï¼š${error.message}`);
        
        // 3ç§’åå…³é—­
        setTimeout(() => progress.close(), 3000);
    }
}
```

---

## æµ‹è¯•ç”¨ä¾‹

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```javascript
describe('GenerationProgress', () => {
    let progress;
    
    beforeEach(() => {
        progress = new GenerationProgress();
    });
    
    test('è¯†åˆ« character_models', () => {
        const chunk = '{"character_models": [';
        progress.updateScriptProgress(chunk);
        expect(progress.scriptProgress.phase).toBe('character_models');
    });
    
    test('æå–é¡µç ', () => {
        const chunk = '"page_number": 5';
        progress.updateScriptProgress(chunk);
        expect(progress.scriptProgress.phase).toBe('pages');
        expect(progress.scriptProgress.currentPage).toBe(5);
    });
    
    test('å›¾ç‰‡è¿›åº¦æ–‡æœ¬', () => {
        progress.updateImageProgress(3, 20);
        const text = progress.getImageProgressText();
        expect(text).toBe('æ­£åœ¨ç”Ÿæˆæ’å›¾ 3/20');
    });
});
```

---

## API å‚è€ƒ

### å…¬å¼€æ–¹æ³•

| æ–¹æ³• | å‚æ•° | è¿”å›å€¼ | è¯´æ˜ |
|-----|------|--------|------|
| `show(bookId, step)` | bookId: string<br>step: number | void | æ˜¾ç¤ºè¿›åº¦çª—å£ |
| `close()` | - | void | å…³é—­è¿›åº¦çª—å£ |
| `updateScriptProgress(content)` | content: string | void | æ›´æ–°è„šæœ¬è¿›åº¦ |
| `updateImageProgress(current, total)` | current: number<br>total: number | void | æ›´æ–°å›¾ç‰‡è¿›åº¦ |
| `completeStep(step)` | step: number | void | å®ŒæˆæŸæ­¥éª¤ |
| `setCurrentStep(step)` | step: number | void | è®¾ç½®å½“å‰æ­¥éª¤ |
| `complete(callback)` | callback: Function | void | å®Œæˆå…¨éƒ¨æµç¨‹ |
| `simulateGeneration()` | - | Promise<void> | æ¨¡æ‹Ÿç”Ÿæˆæµç¨‹ |
| `isInProgress()` | - | boolean | æ˜¯å¦æ­£åœ¨ç”Ÿæˆ |
| `getCurrentBookId()` | - | string\|null | è·å–å½“å‰ç»˜æœ¬ID |
| `getCurrentStep()` | - | number | è·å–å½“å‰æ­¥éª¤ |

### å…¬å¼€å±æ€§

| å±æ€§ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `currentBookId` | string\|null | å½“å‰ç»˜æœ¬ID |
| `currentStep` | number | å½“å‰æ­¥éª¤ (1-3) |
| `isGenerating` | boolean | æ˜¯å¦æ­£åœ¨ç”Ÿæˆ |
| `scriptProgress` | Object | è„šæœ¬ç”Ÿæˆè¿›åº¦ |
| `imageProgress` | Object | å›¾ç‰‡ç”Ÿæˆè¿›åº¦ |

---

## æµè§ˆå™¨å…¼å®¹æ€§

- âœ… Chrome 90+
- âœ… Firefox 88+
- âœ… Safari 14+
- âœ… Edge 90+

**ä¾èµ–ï¼š**
- Fetch API
- Async/Await
- Promise
- ReadableStream (æµå¼å“åº”)

---

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-11-03)
- âœ¨ æ–°å¢åŠ¨æ€è¿›åº¦è¿½è¸ªåŠŸèƒ½
- âœ¨ æ–°å¢å…³é”®è¯è¯†åˆ«æœºåˆ¶
- âœ¨ æ–°å¢å›¾ç‰‡ç”Ÿæˆè¿›åº¦æ˜¾ç¤º
- ğŸ”§ ç§»é™¤å›ºå®šç­‰å¾…æ—¶é—´
- ğŸ¨ ä¼˜åŒ–UIè¿‡æ¸¡åŠ¨ç”»

### v1.0.0
- åŸºç¡€è¿›åº¦çª—å£åŠŸèƒ½
- ä¸‰é˜¶æ®µå›ºå®šæ˜¾ç¤º
- å›ºå®šæ—¶é—´ç­‰å¾…

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0.0  
**æœ€åæ›´æ–°**ï¼š2025-11-03

