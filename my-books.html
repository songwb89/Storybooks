<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç»˜æœ¬ - AIç»˜æœ¬</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- ç»˜æœ¬é˜…è¯»å™¨æ¨¡å— -->
    <script src="js/storybook-reader.js"></script>
    
    <!-- å¤§çº²ç¡®è®¤æ¨¡æ€çª—å£ç»„ä»¶ -->
    <link rel="stylesheet" href="css/outline-modal.css">
    <script src="js/outline-modal.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f3ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨åŠ¨ç”» */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* ç”Ÿæˆä¸­çš„æ—‹è½¬åŠ¨ç”» */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .book-card {
            transition: all 0.3s ease;
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* çŠ¶æ€å¾½ç« æ ·å¼ */
        .status-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
        }

        /* å ä½å›¾ç‰‡æ ·å¼ */
        .placeholder-image {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </div>
                <span class="text-base font-semibold text-gray-800">å¥•å…†ç§‘æŠ€</span>
            </div>

            <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors">
                <div class="w-7 h-7 bg-gray-100 rounded-full flex items-center justify-center">
                    <i data-lucide="user" class="w-3.5 h-3.5 text-gray-600"></i>
                </div>
                <span class="text-sm text-gray-600 font-medium">Admin</span>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
            </div>
        </div>
    </header>

    <!-- è¿”å›æŒ‰é’® -->
    <div class="fixed left-6 top-20 z-40">
        <button onclick="goBack()" class="w-11 h-11 bg-primary-500 hover:bg-primary-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:-translate-x-1 flex items-center justify-center group">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
        </button>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-6xl mx-auto px-6 py-4 relative">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="text-center mt-4 mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2 bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">
                æˆ‘çš„ç»˜æœ¬
            </h1>
            <p class="text-gray-500 text-sm">ç®¡ç†æ‚¨åˆ›ä½œçš„æ‰€æœ‰ç»˜æœ¬ä½œå“</p>
        </div>

        <!-- æ“ä½œæ  -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <span class="text-sm text-gray-600">å…± <span class="font-semibold text-gray-800" id="totalCount">6</span> æœ¬ç»˜æœ¬</span>
                
                <!-- çŠ¶æ€ç­›é€‰ -->
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">ç­›é€‰ï¼š</span>
                    <select id="statusFilter" onchange="filterByStatus()" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm focus:border-primary-400 focus:ring-2 focus:ring-primary-100 outline-none">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="draft">å¤§çº²ç¡®è®¤</option>
                        <option value="generating">ç”Ÿæˆä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="failed">ç”Ÿæˆå¤±è´¥</option>
                    </select>
                </div>
            </div>

            <button onclick="createNewBook()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span>åˆ›å»ºæ–°ç»˜æœ¬</span>
            </button>
        </div>

        <!-- ç»˜æœ¬ç½‘æ ¼ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="booksGrid">
            <!-- ç»˜æœ¬å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="emptyState" class="text-center py-16 hidden">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="book-open" class="w-12 h-12 text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">è¿˜æ²¡æœ‰ç»˜æœ¬</h3>
            <p class="text-gray-500 mb-6">å¼€å§‹åˆ›ä½œæ‚¨çš„ç¬¬ä¸€æœ¬AIç»˜æœ¬å§ï¼</p>
            <button onclick="createNewBook()" class="px-6 py-3 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all">
                åˆ›å»ºç»˜æœ¬
            </button>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] opacity-0 transition-opacity pointer-events-none"></div>

    <script>
        // é€šç”¨æ¨¡æ€çª—å£ç»„ä»¶
        class ModalComponent {
            constructor(modalId, options = {}) {
                this.modalId = modalId;
                this.options = {
                    title: options.title || 'æ ‡é¢˜',
                    headerClass: options.headerClass || 'bg-gradient-to-r from-primary-500 to-purple-600',
                    maxWidth: options.maxWidth || 'max-w-2xl',
                    closable: options.closable !== false,
                    ...options
                };
                this.isOpen = false;
                this.onClose = options.onClose || (() => {});
                this.onCreate = options.onCreate || (() => {});
            }

            // åˆ›å»ºæ¨¡æ€çª—å£HTML
            createModal() {
                const modalHtml = `
                    <div id="${this.modalId}" class="fixed inset-0 bg-black bg-opacity-50 z-[200] hidden flex items-center justify-center">
                        <div class="bg-white rounded-2xl shadow-2xl ${this.options.maxWidth} w-full mx-4 max-h-[90vh] overflow-hidden">
                            <!-- å¼¹çª—å¤´éƒ¨ -->
                            <div class="${this.options.headerClass} px-6 py-4 text-white">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-xl font-bold" id="${this.modalId}Title">${this.options.title}</h3>
                                    ${this.options.closable ? `
                                        <button onclick="window.modalInstances['${this.modalId}'].close()" class="w-8 h-8 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center transition-all">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- å¼¹çª—å†…å®¹ -->
                            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                                <div id="${this.modalId}Content">
                                    <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // å¦‚æœæ¨¡æ€çª—å£ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå®ƒ
                if (!document.getElementById(this.modalId)) {
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    this.setupEventListeners();
                    this.onCreate();
                }
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                const modal = document.getElementById(this.modalId);
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal && this.options.closable) {
                        this.close();
                    }
                });
            }

            // æ‰“å¼€æ¨¡æ€çª—å£
            open(title, content) {
                this.createModal();
                
                const modal = document.getElementById(this.modalId);
                const titleElement = document.getElementById(`${this.modalId}Title`);
                const contentElement = document.getElementById(`${this.modalId}Content`);

                if (title) titleElement.textContent = title;
                if (content) contentElement.innerHTML = content;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                this.isOpen = true;
                
                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                lucide.createIcons();
            }

            // å…³é—­æ¨¡æ€çª—å£
            close() {
                const modal = document.getElementById(this.modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                    this.isOpen = false;
                    this.onClose();
                }
            }

            // æ›´æ–°å†…å®¹
            updateContent(content) {
                const contentElement = document.getElementById(`${this.modalId}Content`);
                if (contentElement) {
                    contentElement.innerHTML = content;
                    lucide.createIcons();
                }
            }

            // æ›´æ–°æ ‡é¢˜
            updateTitle(title) {
                const titleElement = document.getElementById(`${this.modalId}Title`);
                if (titleElement) {
                    titleElement.textContent = title;
                }
            }
        }

        // å…¨å±€æ¨¡æ€çª—å£å®ä¾‹ç®¡ç†
        window.modalInstances = {};

        // åˆ›å»ºæ¨¡æ€çª—å£å®ä¾‹
        function initializeModals() {
            // ç»˜æœ¬è¯¦æƒ…æ¨¡æ€çª—å£
            window.modalInstances.bookDetailModal = new ModalComponent('bookDetailModal', {
                title: 'ç»˜æœ¬è¯¦æƒ…',
                headerClass: 'bg-gradient-to-r from-primary-500 to-purple-600',
                maxWidth: 'max-w-2xl'
            });

            // åˆå§‹åŒ–å¤§çº²ç¡®è®¤æ¨¡æ€çª—å£ç»„ä»¶
            window.myBooksOutlineModal = initOutlineModal({
                onSave: saveBookOutlineDraft,
                onGenerate: generateBookFromOutline,
                onClose: () => {
                    console.log('å¤§çº²æ¨¡æ€çª—å£å·²å…³é—­');
                }
            });
        }

        // åˆå§‹åŒ– Lucide å›¾æ ‡
        lucide.createIcons();

        // åˆå§‹åŒ–æ¨¡æ€çª—å£
        initializeModals();

        // æ¨¡æ‹Ÿç»˜æœ¬æ•°æ®
        const booksData = [
            {
                id: 1,
                title: "å°å…”å­çš„å†’é™©",
                status: "completed", // draft, generating, completed, failed
                createdAt: "2024-01-15",
                updatedAt: "2024-01-16",
                coverImage: "images/1.png", // åªæœ‰completedçŠ¶æ€æ‰æœ‰å›¾ç‰‡
                pages: 12,
                progress: 100
            },
            {
                id: 2,
                title: "æ˜Ÿç©ºä¸‹çš„å°çŒ«",
                status: "draft",
                createdAt: "2024-01-14",
                updatedAt: "2024-01-14",
                coverImage: null,
                pages: 8,
                progress: 0
            },
            {
                id: 3,
                title: "é­”æ³•æ£®æ—çš„ç§˜å¯†",
                status: "generating",
                createdAt: "2024-01-13",
                updatedAt: "2024-01-13",
                coverImage: null,
                pages: 15,
                progress: 0
            },
            {
                id: 4,
                title: "å‹‡æ•¢çš„å°é¸­å­",
                status: "completed",
                createdAt: "2024-01-12",
                updatedAt: "2024-01-12",
                coverImage: "images/2.png",
                pages: 10,
                progress: 100
            },
            {
                id: 5,
                title: "å½©è™¹æ¡¥çš„ä¼ è¯´",
                status: "failed",
                createdAt: "2024-01-11",
                updatedAt: "2024-01-11",
                coverImage: null,
                pages: 0,
                progress: 0,
                errorMessage: "å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•"
            },
            {
                id: 6,
                title: "æœˆäº®ä¸Šçš„å…”å­",
                status: "completed",
                createdAt: "2024-01-10",
                updatedAt: "2024-01-10",
                coverImage: "images/3.png",
                pages: 14,
                progress: 100
            }
        ];

        let currentFilter = 'all';

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“ç»˜æœ¬
        document.addEventListener('DOMContentLoaded', function() {
            renderBooks();
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰æ›´å¤šæ“ä½œèœå•
            document.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ›´å¤šæ“ä½œæŒ‰é’®æˆ–èœå•ï¼Œåˆ™å…³é—­æ‰€æœ‰èœå•
                if (!e.target.closest('[id^="moreOptions-"]') && !e.target.closest('button[onclick*="toggleMoreOptions"]')) {
                    const allMenus = document.querySelectorAll('[id^="moreOptions-"]');
                    allMenus.forEach(menu => {
                        menu.style.opacity = '0';
                        menu.style.visibility = 'hidden';
                    });
                }
            });
        });

        // æ¸²æŸ“ç»˜æœ¬ç½‘æ ¼
        function renderBooks() {
            const grid = document.getElementById('booksGrid');
            const emptyState = document.getElementById('emptyState');
            
            // æ ¹æ®ç­›é€‰æ¡ä»¶è¿‡æ»¤æ•°æ®
            const filteredBooks = currentFilter === 'all' 
                ? booksData 
                : booksData.filter(book => book.status === currentFilter);

            // æ›´æ–°æ€»æ•°
            document.getElementById('totalCount').textContent = filteredBooks.length;

            if (filteredBooks.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            grid.innerHTML = filteredBooks.map(book => createBookCard(book)).join('');
            lucide.createIcons();
        }

        // åˆ›å»ºç»˜æœ¬å¡ç‰‡
        function createBookCard(book) {
            const statusConfig = getStatusConfig(book.status);
            
            // æ ¹æ®çŠ¶æ€å†³å®šç‚¹å‡»è¡Œä¸º
            let clickHandler;
            switch (book.status) {
                case 'completed':
                    clickHandler = `onclick="readBookDirectly(${book.id})"`;
                    break;
                case 'draft':
                    clickHandler = `onclick="openOutlineConfirm(${book.id})"`;
                    break;
                default:
                    clickHandler = `onclick="openBookDetail(${book.id})"`;
            }
            
            return `
                <div class="book-card bg-white rounded-2xl overflow-hidden shadow-md border border-gray-200 relative cursor-pointer group hover:shadow-lg transition-all" ${clickHandler}>
                    <!-- çŠ¶æ€å¾½ç« ï¼ˆå·²å®ŒæˆçŠ¶æ€ä¸æ˜¾ç¤ºï¼‰ -->
                    ${book.status !== 'completed' ? `
                        <div class="status-badge">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusConfig.badgeClass}">
                                ${statusConfig.icon ? `<i data-lucide="${statusConfig.icon}" class="w-3 h-3 inline mr-1 ${statusConfig.iconClass || ''}"></i>` : ''}
                                ${statusConfig.text}
                            </span>
                        </div>
                    ` : ''}

                    <!-- æ›´å¤šæ“ä½œæŒ‰é’®ï¼ˆä»…å·²å®ŒæˆçŠ¶æ€æ˜¾ç¤ºï¼‰ -->
                    ${book.status === 'completed' ? `
                        <div class="absolute top-3 right-3 z-10">
                            <div class="relative" onmouseenter="showMoreOptions(${book.id})" onmouseleave="hideMoreOptions(${book.id})">
                                <button onclick="event.stopPropagation(); toggleMoreOptions(${book.id})" class="w-8 h-8 bg-white/80 backdrop-blur-sm hover:bg-white rounded-full flex items-center justify-center shadow-md transition-all opacity-0 group-hover:opacity-100">
                                    <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-600"></i>
                                </button>
                                
                                <!-- æ›´å¤šæ“ä½œèœå• -->
                                <div id="moreOptions-${book.id}" class="absolute top-full right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 py-1 min-w-[100px] opacity-0 invisible transition-all duration-200 z-20">
                                    <button onclick="event.stopPropagation(); confirmDeleteBook(${book.id})" class="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
                                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                                        åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- å°é¢å›¾ç‰‡åŒºåŸŸ -->
                    <div class="w-full aspect-[4/3] ${book.coverImage ? '' : 'placeholder-image'}">
                        ${book.coverImage 
                            ? `<img src="${book.coverImage}" alt="${book.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">`
                            : `<div class="text-gray-400">
                                <i data-lucide="${getPlaceholderIcon(book.status)}" class="w-16 h-16"></i>
                               </div>`
                        }
                    </div>

                    <!-- å†…å®¹åŒºåŸŸ -->
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-800 mb-3 line-clamp-1">${book.title}</h3>
                        
                        <!-- è¿›åº¦æ¡ï¼ˆä»…ç”Ÿæˆä¸­çŠ¶æ€ä¸”æœ‰è¿›åº¦æ—¶æ˜¾ç¤ºï¼‰ -->
                        ${book.status === 'generating' && book.progress > 0 ? `
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs text-gray-500">ç”Ÿæˆè¿›åº¦</span>
                                    <span class="text-xs text-gray-500">${book.progress}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: ${book.progress}%"></div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- åº•éƒ¨ä¿¡æ¯ -->
                        <div class="flex justify-between items-center text-xs text-gray-500">
                            <span>${formatDate(book.updatedAt)}</span>
                            ${book.pages > 0 ? `<span>${book.pages}é¡µ</span>` : '<span>-</span>'}
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’®ï¼ˆéå·²å®ŒæˆçŠ¶æ€ï¼‰ -->
                    ${book.status !== 'completed' ? `
                        <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                            ${getActionButton(book)}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // è·å–çŠ¶æ€é…ç½®
        function getStatusConfig(status) {
            const configs = {
                draft: {
                    text: 'å¤§çº²ç¡®è®¤',
                    badgeClass: 'bg-yellow-100 text-yellow-800',
                    icon: 'edit-3'
                },
                generating: {
                    text: 'ç”Ÿæˆä¸­',
                    badgeClass: 'bg-blue-100 text-blue-800',
                    icon: 'loader-2',
                    iconClass: 'animate-spin'
                },
                completed: {
                    text: 'å·²å®Œæˆ',
                    badgeClass: 'bg-green-100 text-green-800',
                    icon: 'check-circle'
                },
                failed: {
                    text: 'ç”Ÿæˆå¤±è´¥',
                    badgeClass: 'bg-red-100 text-red-800',
                    icon: 'alert-circle'
                }
            };
            return configs[status] || configs.draft;
        }

        // è·å–å ä½å›¾æ ‡
        function getPlaceholderIcon(status) {
            const icons = {
                draft: 'file-text',
                generating: 'loader-2',
                completed: 'book-open',
                failed: 'alert-triangle'
            };
            return icons[status] || 'book-open';
        }

        // è·å–æ“ä½œæŒ‰é’®
        function getActionButton(book) {
            switch (book.status) {
                case 'draft':
                    return `<button onclick="event.stopPropagation(); editDraft(${book.id})" class="px-3 py-1.5 bg-yellow-500 hover:bg-yellow-600 text-white text-xs rounded-lg transition-all">ç¼–è¾‘å¤§çº²</button>`;
                case 'generating':
                    return `<button onclick="event.stopPropagation(); viewProgress(${book.id})" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition-all">æŸ¥çœ‹è¿›åº¦</button>`;
                case 'completed':
                    return `<button onclick="event.stopPropagation(); readBook(${book.id})" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-all">é˜…è¯»</button>`;
                case 'failed':
                    return `<button onclick="event.stopPropagation(); retryGeneration(${book.id})" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs rounded-lg transition-all">é‡è¯•</button>`;
                default:
                    return '';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'ä»Šå¤©';
            if (diffDays === 2) return 'æ˜¨å¤©';
            if (diffDays <= 7) return `${diffDays}å¤©å‰`;
            
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }

        // çŠ¶æ€ç­›é€‰
        function filterByStatus() {
            currentFilter = document.getElementById('statusFilter').value;
            renderBooks();
        }

        // æ‰“å¼€ç»˜æœ¬è¯¦æƒ…
        function openBookDetail(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;

            const modal = window.modalInstances.bookDetailModal;
            modal.open(book.title, createDetailContent(book));
        }

        // å…³é—­ç»˜æœ¬è¯¦æƒ…
        function closeBookDetail() {
            window.modalInstances.bookDetailModal.close();
        }

        // æ‰“å¼€å¤§çº²ç¡®è®¤çª—å£
        function openOutlineConfirm(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;

            // è½¬æ¢ä¹¦ç±æ•°æ®ä¸ºå¤§çº²æ¨¡æ€çª—å£éœ€è¦çš„æ ¼å¼
            const storyData = convertBookToStoryData(book);
            
            if (window.myBooksOutlineModal) {
                window.myBooksOutlineModal.open(storyData);
            }
        }

        // å…³é—­å¤§çº²ç¡®è®¤çª—å£
        function closeOutlineConfirm() {
            if (window.myBooksOutlineModal) {
                window.myBooksOutlineModal.close();
            }
        }

        // è½¬æ¢ä¹¦ç±æ•°æ®ä¸ºæ•…äº‹æ•°æ®æ ¼å¼
        function convertBookToStoryData(book) {
            return {
                "core_elements": {
                    "title": book.title,
                    "characters": book.characters || [
                        {"name": "å°å…”å­", "description": "å‹‡æ•¢å–„è‰¯çš„ä¸»è§’ï¼Œå–œæ¬¢æ¢é™©"},
                        {"name": "å°ç†Š", "description": "å‹å–„çš„ä¼™ä¼´ï¼Œæ€»æ˜¯ä¹äºåŠ©äºº"},
                        {"name": "å°é¸Ÿ", "description": "èªæ˜çš„å‘å¯¼ï¼Œç†Ÿæ‚‰æ£®æ—çš„æ¯ä¸€ä¸ªè§’è½"}
                    ],
                    "theme": book.theme || "å‹è°Šä¸å†’é™©çš„æ¸©æš–æ•…äº‹",
                    "settings": book.settings || [
                        {"name": "ç¥ç§˜æ£®æ—", "description": "å……æ»¡æœªçŸ¥å’ŒæƒŠå–œçš„å†’é™©ä¹‹åœ°"},
                        {"name": "æ¸©æš–å°å±‹", "description": "å®‰å…¨èˆ’é€‚çš„å®¶å›­"},
                        {"name": "å½©è™¹æ¡¥", "description": "è¿æ¥æ¢¦æƒ³ä¸ç°å®çš„ç¥å¥‡ä¹‹æ¡¥"}
                    ],
                    "page_count": book.pages || 8
                },
                "outline": book.outline || [
                    {"page_number": 1, "scene": "ç¥ç§˜æ£®æ—", "plot_summary": "å°å…”å­åœ¨æ£®æ—é‡Œè¿·è·¯äº†ï¼Œå››å‘¨éƒ½æ˜¯é™Œç”Ÿçš„æ ‘æœ¨å’Œå£°éŸ³"},
                    {"page_number": 2, "scene": "ç¥ç§˜æ£®æ—", "plot_summary": "é‡åˆ°äº†å‹å–„çš„å°ç†Šï¼Œå°ç†Šä¸»åŠ¨æå‡ºè¦å¸®åŠ©å°å…”å­"},
                    {"page_number": 3, "scene": "ç¥ç§˜æ£®æ—", "plot_summary": "å°é¸Ÿé£æ¥åŠ å…¥ä»–ä»¬ï¼Œç”¨æ­Œå£°æŒ‡å¼•æ–¹å‘"},
                    {"page_number": 4, "scene": "å½©è™¹æ¡¥", "plot_summary": "ä¸‰ä¸ªæœ‹å‹ä¸€èµ·èµ°è¿‡ç¾ä¸½çš„å½©è™¹æ¡¥"},
                    {"page_number": 5, "scene": "æ¸©æš–å°å±‹", "plot_summary": "ç»ˆäºåˆ°è¾¾äº†æ¸©æš–çš„å®¶ï¼Œä¸‰ä¸ªå¥½æœ‹å‹æˆä¸ºäº†æœ€å¥½çš„ä¼™ä¼´"}
                ]
            };
        }

        // ä¿å­˜ä¹¦ç±å¤§çº²è‰ç¨¿
        function saveBookOutlineDraft(storyData) {
            console.log('ä¿å­˜ä¹¦ç±å¤§çº²è‰ç¨¿ï¼š', storyData);
            showToast('âœ… å¤§çº²è‰ç¨¿å·²ä¿å­˜');
        }

        // ä»å¤§çº²ç”Ÿæˆç»˜æœ¬
        function generateBookFromOutline(storyData) {
            console.log('ä»å¤§çº²ç”Ÿæˆç»˜æœ¬ï¼š', storyData);
            showToast('ğŸ¨ å¼€å§‹ç”Ÿæˆç»˜æœ¬...');
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„ç”Ÿæˆé€»è¾‘
            setTimeout(() => {
                showToast('âœ… ç»˜æœ¬ç”Ÿæˆå®Œæˆï¼');
            }, 3000);
        }

        // åˆ›å»ºè¯¦æƒ…å†…å®¹
        function createDetailContent(book) {
            const statusConfig = getStatusConfig(book.status);
            
            return `
                <div class="space-y-6">
                    <!-- çŠ¶æ€å’ŒåŸºæœ¬ä¿¡æ¯ -->
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 text-sm font-medium rounded-full ${statusConfig.badgeClass}">
                                    ${statusConfig.icon ? `<i data-lucide="${statusConfig.icon}" class="w-4 h-4 inline mr-1 ${statusConfig.iconClass || ''}"></i>` : ''}
                                    ${statusConfig.text}
                                </span>
                            </div>
                        </div>
                        ${book.coverImage ? `
                            <div class="w-24 h-18 rounded-lg overflow-hidden shadow-md flex-shrink-0">
                                <img src="${book.coverImage}" alt="${book.title}" class="w-full h-full object-cover">
                            </div>
                        ` : ''}
                    </div>

                    <!-- è¯¦ç»†ä¿¡æ¯ -->
                    <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <span class="text-sm text-gray-500">åˆ›å»ºæ—¶é—´</span>
                            <p class="font-medium">${new Date(book.createdAt).toLocaleDateString('zh-CN')}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">æ›´æ–°æ—¶é—´</span>
                            <p class="font-medium">${new Date(book.updatedAt).toLocaleDateString('zh-CN')}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">é¡µæ•°</span>
                            <p class="font-medium">${book.pages > 0 ? `${book.pages}é¡µ` : 'æœªè®¾ç½®'}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">è¿›åº¦</span>
                            <p class="font-medium">${book.progress}%</p>
                        </div>
                    </div>

                    <!-- è¿›åº¦æ¡ï¼ˆç”Ÿæˆä¸­çŠ¶æ€ä¸”æœ‰è¿›åº¦æ—¶æ˜¾ç¤ºï¼‰ -->
                    ${book.status === 'generating' && book.progress > 0 ? `
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-blue-800">ç”Ÿæˆè¿›åº¦</span>
                                <span class="text-sm text-blue-600">${book.progress}%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${book.progress}%"></div>
                            </div>
                            <p class="text-xs text-blue-600 mt-2">AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„ç»˜æœ¬ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
                        </div>
                    ` : book.status === 'generating' ? `
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800 font-medium">AIæ­£åœ¨ç”Ÿæˆæ‚¨çš„ç»˜æœ¬ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
                        </div>
                    ` : ''}

                    <!-- é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥çŠ¶æ€ï¼‰ -->
                    ${book.status === 'failed' ? `
                        <div class="p-4 bg-red-50 rounded-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm font-medium text-red-800">ç”Ÿæˆå¤±è´¥</span>
                            </div>
                            <p class="text-sm text-red-600">${book.errorMessage || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•'}</p>
                        </div>
                    ` : ''}

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-3 pt-4 border-t">
                        ${getDetailActionButtons(book)}
                    </div>
                </div>
            `;
        }

        // è·å–è¯¦æƒ…é¡µæ“ä½œæŒ‰é’®
        function getDetailActionButtons(book) {
            let buttons = '';
            
            switch (book.status) {
                case 'draft':
                    buttons = `
                        <button onclick="editDraft(${book.id})" class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                            ç¼–è¾‘å¤§çº²
                        </button>
                        <button onclick="generateFromDraft(${book.id})" class="flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="wand-2" class="w-4 h-4 inline mr-2"></i>
                            ç”Ÿæˆç»˜æœ¬
                        </button>
                    `;
                    break;
                case 'generating':
                    buttons = `
                        <button onclick="cancelGeneration(${book.id})" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            å–æ¶ˆç”Ÿæˆ
                        </button>
                    `;
                    break;
                case 'completed':
                    buttons = `
                        <button onclick="readBook(${book.id})" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="book-open" class="w-4 h-4 inline mr-2"></i>
                            é˜…è¯»ç»˜æœ¬
                        </button>
                        <button onclick="shareBook(${book.id})" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                            <i data-lucide="share-2" class="w-4 h-4 inline mr-2"></i>
                            åˆ†äº«
                        </button>
                    `;
                    break;
                case 'failed':
                    buttons = `
                        <button onclick="retryGeneration(${book.id})" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                            é‡æ–°ç”Ÿæˆ
                        </button>
                        <button onclick="editDraft(${book.id})" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                            <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                            ç¼–è¾‘å¤§çº²
                        </button>
                    `;
                    break;
            }

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            buttons += `
                <button onclick="deleteBook(${book.id})" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg font-medium hover:bg-red-50 transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                    åˆ é™¤
                </button>
            `;

            return buttons;
        }

        // å„ç§æ“ä½œå‡½æ•°
        function createNewBook() {
            showToast('è·³è½¬åˆ°åˆ›å»ºæ–°ç»˜æœ¬é¡µé¢');
            // window.location.href = 'index.html';
        }

        function editDraft(bookId) {
            closeBookDetail();
            showToast('æ‰“å¼€å¤§çº²ç¼–è¾‘å™¨');
            // å®é™…é¡¹ç›®ä¸­åº”è¯¥æ‰“å¼€å¤§çº²ç¼–è¾‘å¼¹çª—
        }

        function generateFromDraft(bookId) {
            closeBookDetail();
            showToast('å¼€å§‹ç”Ÿæˆç»˜æœ¬');
            // æ›´æ–°çŠ¶æ€ä¸ºç”Ÿæˆä¸­
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                book.status = 'generating';
                book.progress = 0;
                renderBooks();
            }
        }

        function viewProgress(bookId) {
            showToast('æŸ¥çœ‹ç”Ÿæˆè¿›åº¦');
        }

        function readBook(bookId) {
            closeBookDetail();
            showToast('æ‰“å¼€ç»˜æœ¬é˜…è¯»å™¨');
            // window.location.href = `reader.html?id=${bookId}`;
        }

        // ç›´æ¥é˜…è¯»ç»˜æœ¬ï¼ˆç‚¹å‡»å¡ç‰‡æ—¶è°ƒç”¨ï¼‰
        function readBookDirectly(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (book && book.status === 'completed') {
                // ä½¿ç”¨é»˜è®¤çš„ç»˜æœ¬æ•°æ®æ‰“å¼€é˜…è¯»å™¨
                window.storybookReader.open(window.defaultStorybookData);
            }
        }

        // æ˜¾ç¤ºæ›´å¤šæ“ä½œèœå•
        function showMoreOptions(bookId) {
            const menu = document.getElementById(`moreOptions-${bookId}`);
            if (menu) {
                menu.style.opacity = '1';
                menu.style.visibility = 'visible';
            }
        }

        // éšè—æ›´å¤šæ“ä½œèœå•
        function hideMoreOptions(bookId) {
            const menu = document.getElementById(`moreOptions-${bookId}`);
            if (menu) {
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
            }
        }

        // åˆ‡æ¢æ›´å¤šæ“ä½œèœå•
        function toggleMoreOptions(bookId) {
            const menu = document.getElementById(`moreOptions-${bookId}`);
            if (menu) {
                const isVisible = menu.style.opacity === '1';
                if (isVisible) {
                    hideMoreOptions(bookId);
                } else {
                    showMoreOptions(bookId);
                }
            }
        }

        // ç¡®è®¤åˆ é™¤ç»˜æœ¬
        function confirmDeleteBook(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                if (confirm(`ç¡®å®šè¦åˆ é™¤ã€Š${book.title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                    deleteBook(bookId);
                }
            }
        }

        // åˆ é™¤ç»˜æœ¬
        function deleteBook(bookId) {
            const index = booksData.findIndex(b => b.id === bookId);
            if (index !== -1) {
                const book = booksData[index];
                booksData.splice(index, 1);
                renderBooks();
                showToast(`ã€Š${book.title}ã€‹å·²åˆ é™¤`);
            }
        }

        function retryGeneration(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                book.status = 'generating';
                book.progress = 0;
                closeBookDetail();
                renderBooks();
                showToast('é‡æ–°å¼€å§‹ç”Ÿæˆ');
            }
        }

        function cancelGeneration(bookId) {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç”Ÿæˆå—ï¼Ÿ')) {
                const book = booksData.find(b => b.id === bookId);
                if (book) {
                    book.status = 'draft';
                    book.progress = 0;
                    closeBookDetail();
                    renderBooks();
                    showToast('å·²å–æ¶ˆç”Ÿæˆ');
                }
            }
        }

        function shareBook(bookId) {
            showToast('åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­');
        }

        function deleteBook(bookId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æœ¬ç»˜æœ¬å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                const index = booksData.findIndex(b => b.id === bookId);
                if (index > -1) {
                    booksData.splice(index, 1);
                    closeBookDetail();
                    renderBooks();
                    showToast('ç»˜æœ¬å·²åˆ é™¤');
                }
            }
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            window.history.back();
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            
            toast.className = `fixed top-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[100] transition-opacity ${
                type === 'error' ? 'bg-red-500' : 'bg-gray-900'
            } text-white opacity-100`;
            
            toast.classList.remove('pointer-events-none');
            
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                
                setTimeout(() => {
                    toast.classList.add('pointer-events-none');
                }, 300);
            }, 3000);
        }


        // ESCé”®å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // æ£€æŸ¥å“ªä¸ªæ¨¡æ€çª—å£æ˜¯æ‰“å¼€çš„å¹¶å…³é—­å®ƒ
                if (window.myBooksOutlineModal && window.myBooksOutlineModal.isOpen) {
                    closeOutlineConfirm();
                } else if (window.modalInstances.bookDetailModal.isOpen) {
                    closeBookDetail();
                }
            }
        });
    </script>
</body>
</html>
