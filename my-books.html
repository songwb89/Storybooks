<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的绘本 - AI绘本</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- 侧边栏菜单组件 -->
    <link rel="stylesheet" href="css/sidebar-menu.css">
    <script src="js/sidebar-menu.js"></script>
    
    <!-- 绘本阅读器模块 -->
    <script src="js/storybook-reader.js"></script>
    
    <!-- 大纲确认模态窗口组件 -->
    <link rel="stylesheet" href="css/outline-modal.css">
    <script src="js/outline-modal.js"></script>
    
    <!-- 生成进度窗口组件 -->
    <script src="js/generation-progress.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f3ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81',
                        },
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        /* 状态指示器动画 */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* 生成中的旋转动画 */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        /* 首页风格样式 - 图片和文字分离 */
        
        /* 面包屑导航样式 */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #9ca3af;
        }
        
        .breadcrumb a {
            color: #6b7280;
            text-decoration: none;
            transition: all 0.2s;
            border-bottom: 1px solid transparent;
        }
        
        .breadcrumb a:hover {
            color: #374151;
            border-bottom-color: #374151;
        }
        
        .breadcrumb .separator {
            color: #d1d5db;
            margin: 0 4px;
        }
        
        .breadcrumb .current {
            color: #1f2937;
            font-weight: 600;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div class="px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                </div>
                <span class="text-base font-semibold text-gray-800">兆涵科技</span>
            </div>

            <!-- 用户信息/登录入口 -->
            <div id="userSection">
                <!-- 未登录状态 -->
                <div id="notLoggedIn">
                    <button onclick="goToLogin()" class="px-5 py-2 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white text-sm rounded-lg font-medium shadow-sm hover:shadow-md transition-all">
                        登录
                    </button>
                </div>
                
                <!-- 已登录状态（默认隐藏） -->
                <div id="loggedIn" class="hidden relative">
                    <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors" onclick="toggleUserMenu()">
                        <div class="w-7 h-7 bg-gradient-to-br from-primary-500 to-purple-600 rounded-full flex items-center justify-center text-white text-xs font-semibold" id="userAvatar">
                            A
                        </div>
                        <span class="text-sm text-gray-700 font-medium" id="userNickname">Admin</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
                    </div>
                    
                    <!-- 用户菜单下拉 -->
                    <div id="userMenu" class="hidden absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 py-2 z-50">
                        <a href="#" class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors">
                            <i data-lucide="settings" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-700">账号设置</span>
                        </a>
                        <div class="border-t border-gray-100 my-2"></div>
                        <a href="#" onclick="handleLogout(event)" class="flex items-center gap-3 px-4 py-2.5 hover:bg-red-50 transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4 text-red-500"></i>
                            <span class="text-sm text-red-600">退出登录</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 侧边栏菜单（隐藏） -->
    <!-- <div id="sidebarMenu"></div> -->

    <!-- 主容器 -->
    <div class="px-6 py-4 relative">
        <div class="max-w-[1400px] mx-auto">
        <!-- 面包屑导航 -->
        <div class="breadcrumb mb-3">
            <a href="home.html">AI绘本</a>
            <span class="separator">›</span>
            <span class="current">我的绘本</span>
        </div>

        <!-- 页面标题 -->
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-2xl font-semibold text-gray-900">
                我的绘本
            </h1>
            <button onclick="createNewBook()" class="px-4 py-2 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i>
                创建新绘本
            </button>
        </div>

        <!-- 绘本网格 -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6" id="booksGrid">
            <!-- 绘本卡片将通过JavaScript动态生成 -->
        </div>

        <!-- 空状态 -->
        <div id="emptyState" class="text-center py-16 hidden">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="book-open" class="w-12 h-12 text-gray-400"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">还没有绘本</h3>
            <p class="text-gray-500 mb-6">开始创作您的第一本AI绘本吧！</p>
            <button onclick="createNewBook()" class="px-6 py-3 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all">
                创建绘本
            </button>
        </div>

        <!-- 分页组件 -->
        <div id="paginationContainer" class="flex justify-center items-center gap-2 mt-8 mb-4">
            <!-- 分页按钮将通过JavaScript动态生成 -->
        </div>
        </div>
    </div>

    <!-- Toast 提示 -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] opacity-0 transition-all duration-300 pointer-events-none flex items-center gap-3">
        <i id="toastIcon" data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toastMessage">操作成功</span>
    </div>

    <!-- Confirm 确认对话框 -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 z-[300] hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="confirmDialog">
            <div class="p-6">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-amber-600"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2" id="confirmTitle">确认操作</h3>
                        <p class="text-gray-600 text-sm leading-relaxed" id="confirmMessage">确定要执行此操作吗？</p>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-100 p-4 flex gap-3 justify-end">
                <button onclick="closeConfirm(false)" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                    取消
                </button>
                <button onclick="closeConfirm(true)" class="px-5 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all" id="confirmButton">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== 自定义对话框组件 ==========
        
        let confirmCallback = null;
        
        // 自定义 Confirm 对话框
        function showConfirm(message, title = '确认操作', confirmText = '确定') {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const dialog = document.getElementById('confirmDialog');
                const titleEl = document.getElementById('confirmTitle');
                const messageEl = document.getElementById('confirmMessage');
                const confirmBtn = document.getElementById('confirmButton');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                
                confirmCallback = resolve;
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    dialog.classList.remove('scale-95', 'opacity-0');
                    dialog.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                lucide.createIcons();
            });
        }
        
        function closeConfirm(result) {
            const modal = document.getElementById('confirmModal');
            const dialog = document.getElementById('confirmDialog');
            
            dialog.classList.add('scale-95', 'opacity-0');
            dialog.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                if (confirmCallback) {
                    confirmCallback(result);
                    confirmCallback = null;
                }
            }, 200);
        }

        // 通用模态窗口组件
        class ModalComponent {
            constructor(modalId, options = {}) {
                this.modalId = modalId;
                this.options = {
                    title: options.title || '标题',
                    headerClass: options.headerClass || 'bg-gradient-to-r from-primary-500 to-purple-600',
                    maxWidth: options.maxWidth || 'max-w-2xl',
                    closable: options.closable !== false,
                    ...options
                };
                this.isOpen = false;
                this.onClose = options.onClose || (() => {});
                this.onCreate = options.onCreate || (() => {});
            }

            // 创建模态窗口HTML
            createModal() {
                const modalHtml = `
                    <div id="${this.modalId}" class="fixed inset-0 bg-black bg-opacity-50 z-[200] hidden flex items-center justify-center">
                        <div class="bg-white rounded-2xl shadow-2xl ${this.options.maxWidth} w-full mx-4 max-h-[90vh] overflow-hidden">
                            <!-- 弹窗头部 -->
                            <div class="${this.options.headerClass} px-6 py-4 text-white">
                                <div class="flex justify-between items-center">
                                    <h3 class="text-xl font-bold" id="${this.modalId}Title">${this.options.title}</h3>
                                    ${this.options.closable ? `
                                        <button onclick="window.modalInstances['${this.modalId}'].close()" class="w-8 h-8 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center transition-all">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- 弹窗内容 -->
                            <div class="p-6 overflow-y-auto max-h-[calc(90vh-80px)]">
                                <div id="${this.modalId}Content">
                                    <!-- 内容将通过JavaScript动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // 如果模态窗口不存在，则创建它
                if (!document.getElementById(this.modalId)) {
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    this.setupEventListeners();
                    this.onCreate();
                }
            }

            // 设置事件监听器
            setupEventListeners() {
                const modal = document.getElementById(this.modalId);
                
                // 点击外部关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal && this.options.closable) {
                        this.close();
                    }
                });
            }

            // 打开模态窗口
            open(title, content) {
                this.createModal();
                
                const modal = document.getElementById(this.modalId);
                const titleElement = document.getElementById(`${this.modalId}Title`);
                const contentElement = document.getElementById(`${this.modalId}Content`);

                if (title) titleElement.textContent = title;
                if (content) contentElement.innerHTML = content;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                this.isOpen = true;
                
                // 重新初始化图标
                lucide.createIcons();
            }

            // 关闭模态窗口
            close() {
                const modal = document.getElementById(this.modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                    this.isOpen = false;
                    this.onClose();
                }
            }

            // 更新内容
            updateContent(content) {
                const contentElement = document.getElementById(`${this.modalId}Content`);
                if (contentElement) {
                    contentElement.innerHTML = content;
                    lucide.createIcons();
                }
            }

            // 更新标题
            updateTitle(title) {
                const titleElement = document.getElementById(`${this.modalId}Title`);
                if (titleElement) {
                    titleElement.textContent = title;
                }
            }
        }

        // 全局模态窗口实例管理
        window.modalInstances = {};

        // 创建模态窗口实例
        function initializeModals() {
            // 绘本详情模态窗口
            window.modalInstances.bookDetailModal = new ModalComponent('bookDetailModal', {
                title: '绘本详情',
                headerClass: 'bg-gradient-to-r from-primary-500 to-purple-600',
                maxWidth: 'max-w-2xl'
            });

            // 初始化大纲确认模态窗口组件
            window.myBooksOutlineModal = initOutlineModal({
                onSave: saveBookOutlineDraft,
                onGenerate: generateBookFromOutline,
                onClose: () => {
                    console.log('大纲模态窗口已关闭');
                }
            });
        }

        // 初始化侧边栏菜单（已隐藏）
        // initSidebarMenu('ai-storybook');

        // 初始化 Lucide 图标
        lucide.createIcons();

        // ========== 登录状态管理 ==========
        
        // 检查登录状态（写死为已登录状态）
        function checkLoginStatus() {
            // 强制显示已登录状态
            document.getElementById('notLoggedIn').classList.add('hidden');
            document.getElementById('loggedIn').classList.remove('hidden');
            
            // 使用固定的用户信息
            const nickname = '张三';
            
            // 更新用户信息
            document.getElementById('userNickname').textContent = nickname;
            
            // 更新头像（取昵称首字母）
            const firstLetter = nickname.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = firstLetter;
            
            lucide.createIcons();
        }
        
        // 页面加载时检查登录状态
        checkLoginStatus();
        
        // 跳转到登录页
        function goToLogin() {
            window.location.href = 'login.html?return=' + encodeURIComponent(window.location.pathname);
        }
        
        // 切换用户菜单
        function toggleUserMenu() {
            const userMenu = document.getElementById('userMenu');
            userMenu.classList.toggle('hidden');
        }
        
        // 点击其他地方关闭用户菜单
        document.addEventListener('click', function(e) {
            const userMenu = document.getElementById('userMenu');
            const loggedIn = document.getElementById('loggedIn');
            
            if (loggedIn && !loggedIn.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        });
        
        // 退出登录（原型中禁用此功能）
        function handleLogout(event) {
            event.preventDefault();
            // 原型中不需要退出登录功能，什么也不做
            return false;
        }

        // 初始化模态窗口
        initializeModals();

        // 初始化生成进度窗口组件
        const generationProgress = new GenerationProgress();
        
        // 设置取消回调
        generationProgress.onCancel((bookId) => {
            console.log('用户取消了生成，绘本 ID:', bookId);
            if (bookId) {
                const book = booksData.find(b => b.id === bookId);
                if (book) {
                    book.status = 'draft';
                    book.progress = 0;
                    renderBooks();
                }
            }
        });

        // 模拟绘本数据
        const booksData = [
            // 第1本 - 已完成
            {
                id: 1,
                title: "丑小鸭的春天",
                status: "completed",
                createdAt: "2024-01-15",
                updatedAt: "2024-01-16",
                coverImage: "images/丑小鸭的春天.png",
                pages: 12,
                progress: 100
            },
            // 第2本 - 异常状态：大纲确认
            {
                id: 11,
                title: "小兔子的冒险",
                status: "draft",
                createdAt: "2024-01-05",
                updatedAt: "2024-01-05",
                coverImage: null,
                pages: 8,
                progress: 0
            },
            // 第3本 - 异常状态：生成中
            {
                id: 12,
                title: "魔法森林的秘密",
                status: "generating",
                createdAt: "2024-01-04",
                updatedAt: "2024-01-04",
                coverImage: null,
                pages: 15,
                progress: 45
            },
            // 第4本 - 异常状态：生成失败
            {
                id: 13,
                title: "彩虹桥的传说",
                status: "failed",
                createdAt: "2024-01-03",
                updatedAt: "2024-01-03",
                coverImage: null,
                pages: 0,
                progress: 0,
                errorMessage: "图片生成失败，请重试"
            },
            // 第5-13本 - 已完成（剩余9本第一轮）
            {
                id: 2,
                title: "亡羊补牢",
                status: "completed",
                createdAt: "2024-01-14",
                updatedAt: "2024-01-14",
                coverImage: "images/亡羊补牢.png",
                pages: 8,
                progress: 100
            },
            {
                id: 3,
                title: "卖火柴的小女孩",
                status: "completed",
                createdAt: "2024-01-13",
                updatedAt: "2024-01-13",
                coverImage: "images/卖火柴的小女孩.png",
                pages: 10,
                progress: 100
            },
            {
                id: 4,
                title: "守株待兔",
                status: "completed",
                createdAt: "2024-01-12",
                updatedAt: "2024-01-12",
                coverImage: "images/守株待兔.png",
                pages: 6,
                progress: 100
            },
            // 第5本 - 异常状态：已取消
            {
                id: 14,
                title: "星空下的梦想",
                status: "cancelled",
                createdAt: "2024-01-02",
                updatedAt: "2024-01-02",
                coverImage: null,
                pages: 0,
                progress: 0
            },
            {
                id: 5,
                title: "海的女儿",
                status: "completed",
                createdAt: "2024-01-11",
                updatedAt: "2024-01-11",
                coverImage: "images/海的女儿.png",
                pages: 15,
                progress: 100
            },
            {
                id: 6,
                title: "灰姑娘",
                status: "completed",
                createdAt: "2024-01-10",
                updatedAt: "2024-01-10",
                coverImage: "images/灰姑娘.png",
                pages: 14,
                progress: 100
            },
            {
                id: 7,
                title: "狐假虎威",
                status: "completed",
                createdAt: "2024-01-09",
                updatedAt: "2024-01-09",
                coverImage: "images/狐假虎威.png",
                pages: 8,
                progress: 100
            },
            {
                id: 8,
                title: "狼来了",
                status: "completed",
                createdAt: "2024-01-08",
                updatedAt: "2024-01-08",
                coverImage: "images/狼来了.png",
                pages: 6,
                progress: 100
            },
            {
                id: 9,
                title: "青蛙王子",
                status: "completed",
                createdAt: "2024-01-07",
                updatedAt: "2024-01-07",
                coverImage: "images/青蛙王子.png",
                pages: 12,
                progress: 100
            },
            {
                id: 10,
                title: "龟兔赛跑",
                status: "completed",
                createdAt: "2024-01-06",
                updatedAt: "2024-01-06",
                coverImage: "images/龟兔赛跑.png",
                pages: 8,
                progress: 100
            },
            // 第14-23本 - 已完成（第二轮重复10本）
            {
                id: 24,
                title: "丑小鸭的春天",
                status: "completed",
                createdAt: "2024-01-15",
                updatedAt: "2024-01-16",
                coverImage: "images/丑小鸭的春天.png",
                pages: 12,
                progress: 100
            },
            {
                id: 25,
                title: "亡羊补牢",
                status: "completed",
                createdAt: "2024-01-14",
                updatedAt: "2024-01-14",
                coverImage: "images/亡羊补牢.png",
                pages: 8,
                progress: 100
            },
            {
                id: 26,
                title: "卖火柴的小女孩",
                status: "completed",
                createdAt: "2024-01-13",
                updatedAt: "2024-01-13",
                coverImage: "images/卖火柴的小女孩.png",
                pages: 10,
                progress: 100
            },
            {
                id: 27,
                title: "守株待兔",
                status: "completed",
                createdAt: "2024-01-12",
                updatedAt: "2024-01-12",
                coverImage: "images/守株待兔.png",
                pages: 6,
                progress: 100
            },
            {
                id: 28,
                title: "海的女儿",
                status: "completed",
                createdAt: "2024-01-11",
                updatedAt: "2024-01-11",
                coverImage: "images/海的女儿.png",
                pages: 15,
                progress: 100
            },
            {
                id: 29,
                title: "灰姑娘",
                status: "completed",
                createdAt: "2024-01-10",
                updatedAt: "2024-01-10",
                coverImage: "images/灰姑娘.png",
                pages: 14,
                progress: 100
            },
            {
                id: 30,
                title: "狐假虎威",
                status: "completed",
                createdAt: "2024-01-09",
                updatedAt: "2024-01-09",
                coverImage: "images/狐假虎威.png",
                pages: 8,
                progress: 100
            },
            {
                id: 31,
                title: "狼来了",
                status: "completed",
                createdAt: "2024-01-08",
                updatedAt: "2024-01-08",
                coverImage: "images/狼来了.png",
                pages: 6,
                progress: 100
            },
            {
                id: 32,
                title: "青蛙王子",
                status: "completed",
                createdAt: "2024-01-07",
                updatedAt: "2024-01-07",
                coverImage: "images/青蛙王子.png",
                pages: 12,
                progress: 100
            },
            {
                id: 33,
                title: "龟兔赛跑",
                status: "completed",
                createdAt: "2024-01-06",
                updatedAt: "2024-01-06",
                coverImage: "images/龟兔赛跑.png",
                pages: 8,
                progress: 100
            }
        ];

        // 分页相关变量
        let currentPage = 1;
        const itemsPerPage = 20;

        // 页面加载时渲染绘本
        document.addEventListener('DOMContentLoaded', function() {
            renderBooks();
            
            // 点击外部关闭所有更多操作菜单
            document.addEventListener('click', function(e) {
                // 如果点击的不是更多操作按钮或菜单，则关闭所有菜单
                if (!e.target.closest('[id^="moreOptions-"]') && !e.target.closest('button[onclick*="toggleMoreOptions"]')) {
                    const allMenus = document.querySelectorAll('[id^="moreOptions-"]');
                    allMenus.forEach(menu => {
                        menu.style.opacity = '0';
                        menu.style.visibility = 'hidden';
                    });
                }
            });
        });

        // 渲染绘本网格
        function renderBooks() {
            const grid = document.getElementById('booksGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (booksData.length === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
                document.getElementById('paginationContainer').classList.add('hidden');
                return;
            }

            grid.classList.remove('hidden');
            emptyState.classList.add('hidden');

            // 计算分页
            const totalPages = Math.ceil(booksData.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentBooks = booksData.slice(startIndex, endIndex);

            // 渲染当前页的绘本
            grid.innerHTML = currentBooks.map(book => createBookCard(book)).join('');
            lucide.createIcons();

            // 渲染分页组件
            renderPagination(totalPages);
        }

        // 渲染分页组件
        function renderPagination(totalPages) {
            const container = document.getElementById('paginationContainer');
            
            if (totalPages <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            
            let paginationHTML = '';

            // 上一页按钮
            paginationHTML += `
                <button 
                    onclick="changePage(${currentPage - 1})" 
                    ${currentPage === 1 ? 'disabled' : ''}
                    class="px-3 py-2 rounded-lg border ${currentPage === 1 ? 'border-gray-200 text-gray-300 cursor-not-allowed' : 'border-gray-300 text-gray-700 hover:bg-gray-50'} transition-all"
                >
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                </button>
            `;

            // 页码按钮
            for (let i = 1; i <= totalPages; i++) {
                // 显示逻辑：始终显示第1页、最后一页、当前页及其前后各1页
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button 
                            onclick="changePage(${i})" 
                            class="px-4 py-2 rounded-lg border transition-all ${i === currentPage 
                                ? 'bg-gradient-to-r from-primary-500 to-purple-600 text-white border-primary-500' 
                                : 'border-gray-300 text-gray-700 hover:bg-gray-50'}"
                        >
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="px-2 text-gray-400">...</span>`;
                }
            }

            // 下一页按钮
            paginationHTML += `
                <button 
                    onclick="changePage(${currentPage + 1})" 
                    ${currentPage === totalPages ? 'disabled' : ''}
                    class="px-3 py-2 rounded-lg border ${currentPage === totalPages ? 'border-gray-200 text-gray-300 cursor-not-allowed' : 'border-gray-300 text-gray-700 hover:bg-gray-50'} transition-all"
                >
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            `;

            container.innerHTML = paginationHTML;
            lucide.createIcons();
        }

        // 切换页码
        function changePage(page) {
            const totalPages = Math.ceil(booksData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderBooks();
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 创建绘本卡片（首页风格）
        function createBookCard(book) {
            const statusConfig = getStatusConfig(book.status);
            
            // 根据状态决定点击行为
            let clickHandler;
            const isClickable = !(book.status === 'failed' || book.status === 'cancelled');
            switch (book.status) {
                case 'completed':
                    clickHandler = `onclick="readBookDirectly(${book.id})"`;
                    break;
                case 'draft':
                    clickHandler = `onclick="openOutlineConfirm(${book.id})"`;
                    break;
                case 'failed':
                case 'cancelled':
                    // 失败和已取消状态点击无效
                    clickHandler = '';
                    break;
                case 'generating':
                    clickHandler = `onclick="viewProgress(${book.id})"`;
                    break;
                default:
                    clickHandler = `onclick="openBookDetail(${book.id})"`;
            }
            
            return `
                <div class="group ${isClickable ? 'cursor-pointer' : 'cursor-default'}" ${isClickable ? clickHandler : ''}>
                    <!-- 图片容器 -->
                    <div class="relative">
                        <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">
                            ${book.coverImage 
                                ? `<img src="${book.coverImage}" alt="${book.title}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">`
                                : `<div class="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                    <i data-lucide="${getPlaceholderIcon(book.status)}" class="w-16 h-16 text-gray-400"></i>
                                   </div>`
                            }
                        </div>

                        <!-- 状态徽章（叠加在图片上，已完成状态不显示） -->
                        ${book.status !== 'completed' ? `
                            <div class="absolute top-3 left-3 z-10">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusConfig.badgeClass} shadow-sm backdrop-blur-sm">
                                    ${statusConfig.icon ? `<i data-lucide="${statusConfig.icon}" class="w-3 h-3 inline mr-1 ${statusConfig.iconClass || ''}"></i>` : ''}
                                    ${statusConfig.text}
                                </span>
                            </div>
                        ` : ''}

                        <!-- 更多操作按钮（叠加在图片上） -->
                        <div class="absolute top-3 right-3 z-10">
                            <div class="relative" onmouseenter="showMoreOptions(${book.id})" onmouseleave="hideMoreOptions(${book.id})">
                                <button onclick="event.stopPropagation(); toggleMoreOptions(${book.id})" class="w-8 h-8 bg-white/90 backdrop-blur-sm hover:bg-white rounded-full flex items-center justify-center shadow-md transition-all opacity-0 group-hover:opacity-100">
                                    <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-600"></i>
                                </button>
                                
                                <!-- 更多操作菜单 -->
                                <div id="moreOptions-${book.id}" class="absolute top-full right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 py-1 min-w-[120px] opacity-0 invisible transition-all duration-200 z-20">
                                    ${getMoreOptionsMenu(book)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 标题和信息（图片外部） -->
                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors line-clamp-1">${book.title}</h3>
                    
                    <!-- 次要信息 -->
                    <div class="mt-1 flex items-center gap-3 text-xs text-gray-500">
                        <span class="flex items-center gap-1">
                            <i data-lucide="calendar" class="w-3 h-3"></i>
                            ${formatDate(book.updatedAt)}
                        </span>
                        ${book.pages > 0 ? `
                            <span class="flex items-center gap-1">
                                <i data-lucide="book-open" class="w-3 h-3"></i>
                                ${book.pages}页
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // 获取状态配置
        function getStatusConfig(status) {
            const configs = {
                draft: {
                    text: '大纲确认',
                    badgeClass: 'bg-yellow-100 text-yellow-800',
                    icon: 'edit-3'
                },
                generating: {
                    text: '生成中',
                    badgeClass: 'bg-blue-100 text-blue-800',
                    icon: 'loader-2',
                    iconClass: 'animate-spin'
                },
                completed: {
                    text: '已完成',
                    badgeClass: 'bg-green-100 text-green-800',
                    icon: 'check-circle'
                },
                failed: {
                    text: '生成失败',
                    badgeClass: 'bg-red-100 text-red-800',
                    icon: 'alert-circle'
                },
                cancelled: {
                    text: '已取消',
                    badgeClass: 'bg-gray-100 text-gray-800',
                    icon: 'x-circle'
                }
            };
            return configs[status] || configs.draft;
        }

        // 获取占位图标
        function getPlaceholderIcon(status) {
            const icons = {
                draft: 'file-text',
                generating: 'loader-2',
                completed: 'book-open',
                failed: 'alert-triangle',
                cancelled: 'ban'
            };
            return icons[status] || 'book-open';
        }

        // 获取更多操作菜单
        function getMoreOptionsMenu(book) {
            let menuItems = [];

            // 根据状态添加不同的操作
            switch (book.status) {
                case 'completed':
                    // 已完成状态不显示额外操作，只保留删除按钮
                    break;

                case 'draft':
                    // 草稿状态不显示编辑大纲按钮，只保留删除按钮
                    break;

                case 'generating':
                    menuItems.push(`
                        <button onclick="event.stopPropagation(); cancelGeneration(${book.id})" class="w-full px-3 py-2 text-left text-sm text-orange-600 hover:bg-orange-50 transition-colors flex items-center gap-2">
                            <i data-lucide="x-circle" class="w-3 h-3"></i>
                            取消生成
                        </button>
                    `);
                    break;

                case 'failed':
                case 'cancelled':
                    menuItems.push(`
                        <button onclick="event.stopPropagation(); openOutlineConfirm(${book.id})" class="w-full px-3 py-2 text-left text-sm text-primary-600 hover:bg-primary-50 transition-colors flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                            重新生成
                        </button>
                    `);
                    break;
            }

            // 所有状态都有删除按钮
            if (menuItems.length > 0) {
                menuItems.push(`<div class="border-t border-gray-100 my-1"></div>`);
            }
            menuItems.push(`
                <button onclick="event.stopPropagation(); confirmDeleteBook(${book.id})" class="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                    删除
                </button>
            `);

            return menuItems.join('');
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return '今天';
            if (diffDays === 2) return '昨天';
            if (diffDays <= 7) return `${diffDays}天前`;
            
            return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }

        // 打开绘本详情
        function openBookDetail(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;

            const modal = window.modalInstances.bookDetailModal;
            modal.open(book.title, createDetailContent(book));
        }

        // 关闭绘本详情
        function closeBookDetail() {
            window.modalInstances.bookDetailModal.close();
        }

        // 当前正在编辑的书籍 ID
        let currentEditingBookId = null;

        // 打开大纲确认窗口
        function openOutlineConfirm(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;

            // 保存当前正在编辑的书籍 ID
            currentEditingBookId = bookId;

            // 转换书籍数据为大纲模态窗口需要的格式
            const storyData = convertBookToStoryData(book);
            
            if (window.myBooksOutlineModal) {
                window.myBooksOutlineModal.open(storyData, 'edit'); // 我的绘本页面编辑模式
            }
        }

        // 关闭大纲确认窗口
        function closeOutlineConfirm() {
            if (window.myBooksOutlineModal) {
                window.myBooksOutlineModal.close();
            }
            // 清空当前编辑的书籍 ID
            currentEditingBookId = null;
        }

        // 转换书籍数据为故事数据格式
        function convertBookToStoryData(book) {
            return {
                "bookId": book.id, // 保存原始的 bookId，方便后续查找
                "core_elements": {
                    "title": book.title,
                    "characters": book.characters || [
                        {"name": "小兔子", "description": "勇敢善良的主角，喜欢探险"},
                        {"name": "小熊", "description": "友善的伙伴，总是乐于助人"},
                        {"name": "小鸟", "description": "聪明的向导，熟悉森林的每一个角落"}
                    ],
                    "theme": book.theme || "友谊与冒险的温暖故事",
                    "settings": book.settings || [
                        {"name": "神秘森林", "description": "充满未知和惊喜的冒险之地"},
                        {"name": "温暖小屋", "description": "安全舒适的家园"},
                        {"name": "彩虹桥", "description": "连接梦想与现实的神奇之桥"}
                    ],
                    "page_count": book.pages || 8
                },
                "outline": book.outline || [
                    {"page_number": 1, "scene": "神秘森林", "plot_summary": "小兔子在森林里迷路了，四周都是陌生的树木和声音"},
                    {"page_number": 2, "scene": "神秘森林", "plot_summary": "遇到了友善的小熊，小熊主动提出要帮助小兔子"},
                    {"page_number": 3, "scene": "神秘森林", "plot_summary": "小鸟飞来加入他们，用歌声指引方向"},
                    {"page_number": 4, "scene": "彩虹桥", "plot_summary": "三个朋友一起走过美丽的彩虹桥"},
                    {"page_number": 5, "scene": "温暖小屋", "plot_summary": "终于到达了温暖的家，三个好朋友成为了最好的伙伴"}
                ]
            };
        }

        // 保存书籍大纲草稿
        function saveBookOutlineDraft(storyData) {
            console.log('保存书籍大纲草稿：', storyData);
            showToast('✅ 大纲草稿已保存', 'success');
        }

        // 从大纲生成绘本
        function generateBookFromOutline(storyData) {
            console.log('从大纲生成绘本：', storyData);
            
            // 使用保存的 bookId，如果没有则从 storyData 中获取
            let bookId = currentEditingBookId || storyData.bookId;
            
            console.log('准备生成绘本，bookId:', bookId);
            console.log('currentEditingBookId:', currentEditingBookId);
            console.log('storyData.bookId:', storyData.bookId);
            
            // 关闭大纲确认窗口
            closeOutlineConfirm();
            
            // 找到对应的书籍
            const book = booksData.find(b => b.id === bookId);
            if (!book) {
                console.error('未找到对应的书籍，bookId:', bookId);
                console.error('所有书籍:', booksData.map(b => ({id: b.id, title: b.title})));
                showToast('生成失败：未找到对应的绘本', 'error');
                return;
            }
            
            console.log('找到书籍:', book);
            
            // 更新书籍状态为生成中
            book.status = 'generating';
            book.progress = 0;
            book.generationStep = 1;
            renderBooks();
            
            console.log('书籍状态已更新为 generating，准备显示进度窗口');
            
            // 显示进度窗口
            generationProgress.show(bookId, 1);
            
            console.log('进度窗口已显示，开始模拟生成过程');
            
            // 模拟生成过程（实际项目中应调用后端 API）
            simulateBookGeneration(bookId);
        }

        // 创建详情内容
        function createDetailContent(book) {
            const statusConfig = getStatusConfig(book.status);
            
            return `
                <div class="space-y-6">
                    <!-- 状态和基本信息 -->
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 text-sm font-medium rounded-full ${statusConfig.badgeClass}">
                                    ${statusConfig.icon ? `<i data-lucide="${statusConfig.icon}" class="w-4 h-4 inline mr-1 ${statusConfig.iconClass || ''}"></i>` : ''}
                                    ${statusConfig.text}
                                </span>
                            </div>
                        </div>
                        ${book.coverImage ? `
                            <div class="w-24 h-18 rounded-lg overflow-hidden shadow-md flex-shrink-0">
                                <img src="${book.coverImage}" alt="${book.title}" class="w-full h-full object-cover">
                            </div>
                        ` : ''}
                    </div>

                    <!-- 详细信息 -->
                    <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <span class="text-sm text-gray-500">创建时间</span>
                            <p class="font-medium">${new Date(book.createdAt).toLocaleDateString('zh-CN')}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">更新时间</span>
                            <p class="font-medium">${new Date(book.updatedAt).toLocaleDateString('zh-CN')}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">页数</span>
                            <p class="font-medium">${book.pages > 0 ? `${book.pages}页` : '未设置'}</p>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">进度</span>
                            <p class="font-medium">${book.progress}%</p>
                        </div>
                    </div>

                    <!-- 进度条（生成中状态且有进度时显示） -->
                    ${book.status === 'generating' && book.progress > 0 ? `
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-blue-800">生成进度</span>
                                <span class="text-sm text-blue-600">${book.progress}%</span>
                            </div>
                            <div class="w-full bg-blue-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: ${book.progress}%"></div>
                            </div>
                            <p class="text-xs text-blue-600 mt-2">AI正在生成您的绘本，请耐心等待...</p>
                        </div>
                    ` : book.status === 'generating' ? `
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800 font-medium">AI正在生成您的绘本，请耐心等待...</p>
                        </div>
                    ` : ''}

                    <!-- 错误信息（失败状态） -->
                    ${book.status === 'failed' ? `
                        <div class="p-4 bg-red-50 rounded-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <i data-lucide="alert-circle" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm font-medium text-red-800">生成失败</span>
                            </div>
                            <p class="text-sm text-red-600">${book.errorMessage || '生成过程中出现错误，请重试'}</p>
                        </div>
                    ` : ''}

                    <!-- 操作按钮 -->
                    <div class="flex gap-3 pt-4 border-t">
                        ${getDetailActionButtons(book)}
                    </div>
                </div>
            `;
        }

        // 获取详情页操作按钮
        function getDetailActionButtons(book) {
            let buttons = '';
            
            switch (book.status) {
                case 'draft':
                    buttons = `
                        <button onclick="editDraft(${book.id})" class="flex-1 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                            编辑大纲
                        </button>
                        <button onclick="generateFromDraft(${book.id})" class="flex-1 px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="wand-2" class="w-4 h-4 inline mr-2"></i>
                            生成绘本
                        </button>
                    `;
                    break;
                case 'generating':
                    buttons = `
                        <button onclick="viewProgress(${book.id})" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                            查看进度
                        </button>
                        <button onclick="cancelGeneration(${book.id})" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            取消生成
                        </button>
                    `;
                    break;
                case 'completed':
                    buttons = `
                        <button onclick="readBook(${book.id})" class="flex-1 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="book-open" class="w-4 h-4 inline mr-2"></i>
                            阅读绘本
                        </button>
                        <button onclick="shareBook(${book.id})" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                            <i data-lucide="share-2" class="w-4 h-4 inline mr-2"></i>
                            分享
                        </button>
                    `;
                    break;
                case 'failed':
                case 'cancelled':
                    buttons = `
                        <button onclick="retryGeneration(${book.id})" class="flex-1 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all">
                            <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                            重新生成
                        </button>
                        <button onclick="editDraft(${book.id})" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">
                            <i data-lucide="edit-3" class="w-4 h-4 inline mr-2"></i>
                            编辑大纲
                        </button>
                    `;
                    break;
            }

            // 添加删除按钮
            buttons += `
                <button onclick="confirmDeleteBook(${book.id})" class="px-4 py-2 border border-red-300 text-red-600 rounded-lg font-medium hover:bg-red-50 transition-all">
                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                    删除
                </button>
            `;

            return buttons;
        }

        // 各种操作函数
        function createNewBook() {
            window.location.href = 'home.html';
        }

        function editDraft(bookId) {
            closeBookDetail();
            showToast('打开大纲编辑器', 'info');
            // 实际项目中应该打开大纲编辑弹窗
        }

        function generateFromDraft(bookId) {
            closeBookDetail();
            showToast('开始生成绘本', 'info');
            // 更新状态为生成中
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                book.status = 'generating';
                book.progress = 0;
                renderBooks();
            }
        }

        function viewProgress(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;
            
            // 获取当前生成步骤（默认为1）
            const currentStep = book.generationStep || 1;
            
            // 显示进度窗口
            generationProgress.show(bookId, currentStep);
        }

        function readBook(bookId) {
            closeBookDetail();
            showToast('打开绘本阅读器', 'info');
            // window.location.href = `reader.html?id=${bookId}`;
        }

        // 直接阅读绘本（点击卡片时调用）
        function readBookDirectly(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (book && book.status === 'completed') {
                // 使用默认的绘本数据打开阅读器
                window.storybookReader.open(window.defaultStorybookData);
            }
        }

        // 显示更多操作菜单
        function showMoreOptions(bookId) {
            const menu = document.getElementById(`moreOptions-${bookId}`);
            if (menu) {
                menu.style.opacity = '1';
                menu.style.visibility = 'visible';
            }
        }

        // 隐藏更多操作菜单
        function hideMoreOptions(bookId) {
            const menu = document.getElementById(`moreOptions-${bookId}`);
            if (menu) {
                menu.style.opacity = '0';
                menu.style.visibility = 'hidden';
            }
        }

        // 切换更多操作菜单
        function toggleMoreOptions(bookId) {
            const menu = document.getElementById(`moreOptions-${bookId}`);
            if (menu) {
                const isVisible = menu.style.opacity === '1';
                if (isVisible) {
                    hideMoreOptions(bookId);
                } else {
                    showMoreOptions(bookId);
                }
            }
        }

        // 确认删除绘本
        async function confirmDeleteBook(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                const confirmed = await showConfirm(`确定要删除《${book.title}》吗？此操作不可撤销。`, '删除确认', '删除');
                if (confirmed) {
                    deleteBook(bookId);
                }
            }
        }

        // 删除绘本
        function deleteBook(bookId) {
            const index = booksData.findIndex(b => b.id === bookId);
            if (index !== -1) {
                const book = booksData[index];
                booksData.splice(index, 1);
                renderBooks();
                showToast(`《${book.title}》已删除`, 'success');
            }
        }

        function retryGeneration(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (book) {
                // 回到大纲确认状态
                book.status = 'draft';
                book.progress = 0;
                renderBooks();
                
                // 显示提示信息
                showToast('已恢复到大纲确认状态，请检查大纲后重新生成', 'info');
                
                // 自动打开大纲确认窗口
                setTimeout(() => {
                    openOutlineConfirm(bookId);
                }, 500);
            }
        }

        // 重新生成绘本（从更多菜单调用）
        function retryGenerateBook(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book) return;
            
            // 更新状态为生成中
            book.status = 'generating';
            book.progress = 0;
            book.generationStep = 1;
            renderBooks();
            
            // 显示进度窗口
            generationProgress.show(bookId, 1);
            
            // 模拟生成过程
            simulateBookGeneration(bookId);
        }

        async function cancelGeneration(bookId) {
            const confirmed = await showConfirm('确定要取消生成吗？', '取消确认', '确定');
            if (confirmed) {
                const book = booksData.find(b => b.id === bookId);
                if (book) {
                    book.status = 'draft';
                    book.progress = 0;
                    closeBookDetail();
                    renderBooks();
                    showToast('已取消生成', 'info');
                }
            }
        }

        function editBook(bookId) {
            showToast('编辑功能开发中', 'info');
        }

        function shareBook(bookId) {
            showToast('分享功能开发中', 'info');
        }

        function downloadBook(bookId) {
            showToast('下载功能开发中', 'info');
        }

        // 模拟绘本生成过程
        async function simulateBookGeneration(bookId) {
            console.log('开始模拟生成（使用新的详细进度追踪），bookId:', bookId);
            const book = booksData.find(b => b.id === bookId);
            if (!book) {
                console.error('simulateBookGeneration: 未找到书籍，bookId:', bookId);
                return;
            }

            console.log('找到书籍，使用新的模拟生成流程:', book);

            // 使用新的模拟生成方法（带详细进度追踪）
            try {
                await generationProgress.simulateGeneration();
                
                // 生成完成后更新书籍状态
                if (book && book.status === 'generating') {
                    book.status = 'completed';
                    book.progress = 100;
                    book.generationStep = 0;
                    book.completedAt = new Date().toISOString();
                    renderBooks();
                    
                    showToast('✅ 绘本生成完成！', 'success');
                    
                    // 自动打开绘本阅读器
                    setTimeout(() => {
                        if (window.storybookReader && window.defaultStorybookData) {
                            window.storybookReader.open(window.defaultStorybookData);
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('生成过程出错:', error);
                if (book) {
                    book.status = 'failed';
                    book.progress = 0;
                    renderBooks();
                }
                showToast('生成失败，请重试', 'error');
            }
        }

        function deleteBook(bookId) {
            const index = booksData.findIndex(b => b.id === bookId);
            if (index > -1) {
                booksData.splice(index, 1);
                closeBookDetail();
                renderBooks();
                showToast('绘本已删除', 'success');
            }
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            // 根据类型设置图标和背景色
            let bgColor = 'bg-green-500'; // 默认成功是绿色
            let iconName = 'check-circle';
            
            if (type === 'error') {
                bgColor = 'bg-amber-500';
                iconName = 'alert-circle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
                iconName = 'info';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-500';
                iconName = 'alert-triangle';
            }

            // 重置类名并显示
            toast.className = `fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[100] transition-all duration-300 ${bgColor} text-white opacity-100 transform translate-y-0 flex items-center gap-3`;

            // 更新图标
            toastIcon.setAttribute('data-lucide', iconName);
            lucide.createIcons();
            
            toast.classList.remove('pointer-events-none');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', '-translate-y-2');
                
                setTimeout(() => {
                    toast.classList.add('pointer-events-none');
                }, 300);
            }, 3000);
        }

        // 大纲预览功能（失败状态）
        let currentPreviewBookId = null;

        function showOutlinePreview(bookId) {
            const book = booksData.find(b => b.id === bookId);
            if (!book || !book.outline) {
                showToast('未找到大纲信息', 'error');
                return;
            }

            currentPreviewBookId = bookId;
            
            // 更新标题
            document.getElementById('outlinePreviewTitle').textContent = `《${book.title}》 - 大纲预览`;
            
            // 渲染大纲内容
            const content = document.getElementById('outlinePreviewContent');
            content.innerHTML = book.outline.map((page, index) => `
                <div class="mb-4 p-4 bg-gray-50 border-l-4 border-primary-500 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2.5 py-1 text-xs font-semibold rounded-full bg-primary-100 text-primary-700">
                            第 ${index + 1} 页
                        </span>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed">${page}</p>
                </div>
            `).join('');
            
            // 显示弹窗
            const modal = document.getElementById('outlinePreviewModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // 重新渲染图标
            setTimeout(() => {
                lucide.createIcons();
            }, 50);
        }

        function closeOutlinePreview() {
            const modal = document.getElementById('outlinePreviewModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentPreviewBookId = null;
        }

        function editOutlineFromPreview() {
            if (!currentPreviewBookId) return;
            
            closeOutlinePreview();
            editDraft(currentPreviewBookId);
        }

        function retryFromPreview() {
            if (!currentPreviewBookId) return;
            
            closeOutlinePreview();
            retryGeneration(currentPreviewBookId);
        }


        // ESC键关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // 检查哪个模态窗口是打开的并关闭它
                const outlinePreviewModal = document.getElementById('outlinePreviewModal');
                if (outlinePreviewModal && !outlinePreviewModal.classList.contains('hidden')) {
                    closeOutlinePreview();
                } else if (window.myBooksOutlineModal && window.myBooksOutlineModal.isOpen) {
                    closeOutlineConfirm();
                } else if (window.modalInstances.bookDetailModal.isOpen) {
                    closeBookDetail();
                }
            }
        });
    </script>

    <!-- 大纲预览弹窗（失败状态查看大纲） -->
    <div id="outlinePreviewModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] flex flex-col transform transition-all">
            <!-- 弹窗头部 -->
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <h2 id="outlinePreviewTitle" class="text-xl font-semibold text-gray-800">大纲预览</h2>
                    <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                        <i data-lucide="alert-circle" class="w-3 h-3 inline mr-1"></i>
                        生成失败
                    </span>
                </div>
                <button onclick="closeOutlinePreview()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>

            <!-- 大纲内容 -->
            <div id="outlinePreviewContent" class="flex-1 overflow-y-auto p-6">
                <!-- 内容将通过 JS 动态填充 -->
            </div>

            <!-- 弹窗底部操作按钮 -->
            <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
                <button onclick="editOutlineFromPreview()" class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                    编辑大纲
                </button>
                <button onclick="retryFromPreview()" class="px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-primary-500 to-purple-600 rounded-lg hover:shadow-lg transition-all flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    重新生成
                </button>
            </div>
        </div>
    </div>
</body>
</html>
