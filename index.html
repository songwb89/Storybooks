

<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>AIç»˜æœ¬ - å¥•å…†ç§‘æŠ€</title>

    

    <!-- Tailwind CSS -->

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    

    <script>

        tailwind.config = {

            theme: {

                extend: {

                    colors: {

                        primary: {

                            50: '#f0f3ff',

                            100: '#e0e7ff',

                            200: '#c7d2fe',

                            300: '#a5b4fc',

                            400: '#818cf8',

                            500: '#6366f1',

                            600: '#4f46e5',

                            700: '#4338ca',

                            800: '#3730a3',

                            900: '#312e81',

                        },

                    }

                }

            }

        }

    </script>

    

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        

        body {

            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;

        }



        /* æ–°é¡µé¢é«˜äº®åŠ¨ç”» */

        @keyframes slideInAndPulse {

            0% {

                transform: translateY(-10px);

                opacity: 0;

            }

            100% {

                transform: translateY(0);

                opacity: 1;

            }

        }



        .page-highlight {

            background-color: #dbeafe !important;

            border-color: #60a5fa !important;

            animation: slideInAndPulse 0.4s ease-out;

            transition: background-color 0.5s ease, border-color 0.5s ease;

        }



        .page-highlight-remove {

            background-color: white !important;

            border-color: #e5e7eb !important;

        }


        /* AIåŠ è½½åŠ¨ç”» */
        @keyframes spin-slow {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }

        /* ç»˜æœ¬ç¿»é¡µè¿‡æ¸¡åŠ¨ç”» */
        .storybook-fade-enter {
            opacity: 0;
            transform: scale(0.98);
        }

        .storybook-fade-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        .storybook-fade-exit {
            opacity: 1;
            transform: scale(1);
        }

        .storybook-fade-exit-active {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.3s ease-in, transform 0.3s ease-in;
        }

        /* å›¾ç‰‡åŠ è½½æŒ‡ç¤ºå™¨ */
        .image-loading {
            position: relative;
        }

        .image-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            border: 3px solid #e5e7eb;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* è¿›åº¦å¼¹çª—æ ·å¼ */
        .step-icon {
            display: inline-block;
            width: 20px;
            text-align: center;
        }

        .rotating {
            animation: spin 1s linear infinite;
        }

        .step-completed {
            color: #10B981;
        }

        .step-active {
            color: #3B82F6;
        }

        .step-pending {
            color: #6B7280;
        }
    </style>

</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">

        <div class="px-6 py-3 flex justify-between items-center">

            <div class="flex items-center gap-3">

                <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">

                    <i data-lucide="sparkles" class="w-4 h-4"></i>

                </div>

                <span class="text-base font-semibold text-gray-800">å¥•å…†ç§‘æŠ€</span>

            </div>

            <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors">

                <div class="w-7 h-7 bg-gray-100 rounded-full flex items-center justify-center">

                    <i data-lucide="user" class="w-3.5 h-3.5 text-gray-600"></i>

                </div>

                <span class="text-sm text-gray-600 font-medium">Admin</span>

                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>

            </div>

        </div>

    </header>



    <!-- è¿”å›æŒ‰é’®å’Œæˆ‘çš„ç»˜æœ¬æŒ‰é’® -->

    <div class="fixed left-6 top-20 z-40">

        <button onclick="goBack()" class="w-11 h-11 bg-primary-500 hover:bg-primary-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:-translate-x-1 flex items-center justify-center group">

            <i data-lucide="arrow-left" class="w-4 h-4"></i>

        </button>

    </div>

    <div class="fixed right-6 top-20 z-40">

        <button onclick="goToMyBooks()" title="æˆ‘çš„ç»˜æœ¬" class="w-11 h-11 bg-amber-500 hover:bg-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center">

            <i data-lucide="book-open" class="w-4 h-4"></i>

        </button>

    </div>



    <!-- ä¸»å®¹å™¨ -->

    <div class="max-w-6xl mx-auto px-6 py-4 relative">



        <!-- é¡µé¢æ ‡é¢˜ -->

        <div class="text-center mt-4 mb-6">

            <h1 class="text-4xl font-bold text-gray-800 mb-2 bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">

                AIç»˜æœ¬

            </h1>

            <p class="text-gray-500 text-sm">ç”¨AIåˆ›é€ å±äºä½ çš„ç²¾å½©æ•…äº‹</p>

        </div>



        <!-- è¾“å…¥åŒºåŸŸ -->

        <div class="max-w-4xl mx-auto mb-5">

            <div class="relative">

                <textarea 

                    id="storyInput"

                    class="w-full h-28 px-5 py-3 border-2 border-gray-200 rounded-2xl focus:border-primary-400 focus:ring-4 focus:ring-primary-50 outline-none transition-all resize-none text-gray-700 placeholder-gray-400 shadow-sm hover:border-gray-300"

                    placeholder="è¾“å…¥æ‚¨æƒ³åˆ›ä½œçš„ç»˜æœ¬æ•…äº‹ï¼ˆå¦‚ï¼šä¸€åªå¯»æ‰¾æ˜Ÿæ˜Ÿçš„å‹‡æ•¢å°ç‹ç‹¸ï¼‰"

                ></textarea>

            </div>

        </div>



        <!-- ç”ŸæˆæŒ‰é’® -->

        <div class="text-center mb-8">

            <button onclick="generateOutline()" class="px-10 py-3 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-full font-medium shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5 inline-flex items-center gap-2">

                <i data-lucide="wand-2" class="w-5 h-5"></i>

                <span>ç”Ÿæˆå¤§çº²</span>

            </button>

        </div>



        <!-- ç²¾é€‰ç»˜æœ¬åŒºåŸŸ -->

        <div class="mt-6 max-w-[1400px] mx-auto">

            <div class="flex items-center gap-2 mb-5">

                <i data-lucide="star" class="w-5 h-5 text-amber-500"></i>

                <h2 class="text-xl font-semibold text-gray-800">ç²¾é€‰ç»˜æœ¬</h2>

            </div>

            

            <div class="grid grid-cols-5 gap-6">

                <!-- æ•…äº‹å¡ç‰‡ - çœŸå®å›¾ç‰‡ 4:3æ¯”ä¾‹ -->

                <div onclick="selectStory('ä¸‘å°é¸­çš„æ˜¥å¤©')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/ä¸‘å°é¸­çš„æ˜¥å¤©.png" alt="ä¸‘å°é¸­çš„æ˜¥å¤©" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">ä¸‘å°é¸­çš„æ˜¥å¤©</h3>

                </div>



                <div onclick="selectStory('ç‹¼æ¥äº†')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/ç‹¼æ¥äº†.png" alt="ç‹¼æ¥äº†" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">ç‹¼æ¥äº†</h3>

                </div>



                <div onclick="selectStory('é’è›™ç‹å­')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/é’è›™ç‹å­.png" alt="é’è›™ç‹å­" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">é’è›™ç‹å­</h3>

                </div>



                <div onclick="selectStory('äº¡ç¾Šè¡¥ç‰¢')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/äº¡ç¾Šè¡¥ç‰¢.png" alt="äº¡ç¾Šè¡¥ç‰¢" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">äº¡ç¾Šè¡¥ç‰¢</h3>

                </div>



                <div onclick="selectStory('å®ˆæ ªå¾…å…”')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/å®ˆæ ªå¾…å…”.png" alt="å®ˆæ ªå¾…å…”" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">å®ˆæ ªå¾…å…”</h3>

                </div>



                <div onclick="selectStory('ç°å§‘å¨˜')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/ç°å§‘å¨˜.png" alt="ç°å§‘å¨˜" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">ç°å§‘å¨˜</h3>

                </div>



                <div onclick="selectStory('å–ç«æŸ´çš„å°å¥³å­©')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/å–ç«æŸ´çš„å°å¥³å­©.png" alt="å–ç«æŸ´çš„å°å¥³å­©" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">å–ç«æŸ´çš„å°å¥³å­©</h3>

                </div>



                <div onclick="selectStory('æµ·çš„å¥³å„¿')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/æµ·çš„å¥³å„¿.png" alt="æµ·çš„å¥³å„¿" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">æµ·çš„å¥³å„¿</h3>

                </div>



                <div onclick="selectStory('ç‹å‡è™å¨')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/ç‹å‡è™å¨.png" alt="ç‹å‡è™å¨" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">ç‹å‡è™å¨</h3>

                </div>



                <div onclick="selectStory('é¾Ÿå…”èµ›è·‘')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/é¾Ÿå…”èµ›è·‘.png" alt="é¾Ÿå…”èµ›è·‘" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-medium text-gray-800 group-hover:text-primary-600 transition-colors">é¾Ÿå…”èµ›è·‘</h3>

                </div>

            </div>

        </div>

    </div>



    <!-- å…¨å±å¤§çº²ç¡®è®¤å¼¹çª— -->

    <div id="outlineModal" class="fixed inset-0 bg-white z-[60] hidden">

        <!-- é¡¶éƒ¨æ“ä½œæ  -->

        <div class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm">

            <button onclick="closeOutlineModal()" class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">

                <i data-lucide="x" class="w-5 h-5"></i>

                <span class="font-medium">å–æ¶ˆ</span>

            </button>

            

            <h2 class="text-xl font-bold text-gray-800">ç¡®è®¤æ•…äº‹å¤§çº²</h2>

            

            <div class="flex items-center gap-3">

                <button onclick="saveOutlineDraft()" class="flex items-center gap-2 px-5 py-2 border-2 border-primary-500 text-primary-600 bg-white rounded-lg font-medium hover:bg-primary-50 transition-all">

                    <i data-lucide="save" class="w-4 h-4"></i>

                    <span>ä¿å­˜è‰ç¨¿</span>

                </button>

                <button onclick="generateStorybookFromModal()" class="flex items-center gap-2 px-5 py-2 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all">

                    <i data-lucide="wand-2" class="w-4 h-4"></i>

                    <span>ç”Ÿæˆç»˜æœ¬</span>

                </button>

            </div>

        </div>



        <!-- ä¸»å†…å®¹åŒº -->

        <div class="flex h-[calc(100vh-73px)] overflow-hidden">

            <!-- å·¦ä¾§ä¾§è¾¹æ  -->

            <aside class="w-[350px] bg-white border-r border-gray-200 overflow-y-auto p-5" style="scrollbar-width: thin;">

                <!-- æ ‡é¢˜åŒº -->

                <div class="mb-5">

                    <div id="modalStoryTitle" contenteditable="false" 

                         class="text-2xl font-bold text-gray-800 px-3 py-2 rounded-lg border-2 border-transparent hover:bg-gray-50 hover:border-gray-200 cursor-pointer transition-all outline-none focus:border-primary-400 focus:ring-4 focus:ring-primary-50 focus:bg-white">

                        ä¸‘å°é¸­çš„æ˜¥å¤©

                    </div>

                </div>



                <!-- æ ¸å¿ƒä¸»é¢˜åŒº -->

                <div class="mb-5">

                    <div class="flex items-center gap-2 mb-2.5">

                        <i data-lucide="lightbulb" class="w-4 h-4 text-amber-500"></i>

                        <h3 class="text-sm font-semibold text-gray-700">æ ¸å¿ƒä¸»é¢˜</h3>

                    </div>

                    <div id="modalThemeContent" contenteditable="false"

                         class="px-3 py-3 bg-primary-50 border-l-3 border-primary-400 rounded-lg text-sm text-gray-700 leading-relaxed cursor-pointer hover:bg-primary-100 transition-all outline-none focus:ring-2 focus:ring-primary-300 focus:bg-white min-h-[50px]">

                        æ¥çº³è‡ªæˆ‘ï¼Œå‘ç°å†…åœ¨ä»·å€¼ï¼ŒçœŸæ­£çš„ç¾ä¸½æºäºèº«ä»½è®¤åŒä¸æˆé•¿ã€‚

                    </div>

                </div>



                <!-- ä¸»è¦è§’è‰²åŒº -->

                <div class="mb-5">

                    <div class="flex justify-between items-center mb-2.5">

                        <div class="flex items-center gap-2">

                            <i data-lucide="users" class="w-4 h-4 text-primary-500"></i>

                            <h3 class="text-sm font-semibold text-gray-700">ä¸»è¦è§’è‰²</h3>

                        </div>

                        <button onclick="modalAddCharacter()" 

                                class="flex items-center gap-1.5 px-2.5 py-1.5 bg-primary-500 hover:bg-primary-600 text-white text-xs rounded-lg transition-all hover:-translate-y-0.5 shadow-sm hover:shadow">

                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>

                            <span>æ·»åŠ </span>

                        </button>

                    </div>

                    <div id="modalCharactersList"></div>

                </div>



                <!-- ä¸»è¦åœºæ™¯åŒº -->

                <div class="mb-5">

                    <div class="flex justify-between items-center mb-2.5">

                        <div class="flex items-center gap-2">

                            <i data-lucide="map-pin" class="w-4 h-4 text-emerald-500"></i>

                            <h3 class="text-sm font-semibold text-gray-700">ä¸»è¦åœºæ™¯</h3>

                        </div>

                        <button onclick="modalAddSetting()" 

                                class="flex items-center gap-1.5 px-2.5 py-1.5 bg-primary-500 hover:bg-primary-600 text-white text-xs rounded-lg transition-all hover:-translate-y-0.5 shadow-sm hover:shadow">

                            <i data-lucide="plus" class="w-3.5 h-3.5"></i>

                            <span>æ·»åŠ </span>

                        </button>

                    </div>

                    <div id="modalSettingsList"></div>

                </div>

            </aside>



            <!-- å³ä¾§å†…å®¹åŒº -->

            <main class="flex-1 overflow-y-auto px-8 py-6" style="scrollbar-width: thin;">

                <!-- å¤§çº²æ ‡é¢˜ -->

                <div class="flex items-center justify-center gap-3 mb-6">

                    <i data-lucide="file-text" class="w-6 h-6 text-primary-500"></i>

                    <h2 class="text-2xl font-bold text-gray-800">æ•…äº‹å¤§çº²</h2>

                </div>

                

                <div id="modalOutlineList" class="max-w-4xl mx-auto"></div>

            </main>

        </div>

    </div>



    <!-- Toast æç¤º -->

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] opacity-0 transition-opacity pointer-events-none"></div>

    

    <!-- ç”ŸæˆçŠ¶æ€å¼¹çª— -->

    <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] hidden">

        <div class="bg-white rounded-2xl p-8 max-w-3xl w-full mx-4 shadow-2xl">

            <div class="text-center">


                <!-- ä¸»æ ‡é¢˜ -->
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">AI æ­£åœ¨ç”Ÿæˆæ‚¨çš„ç»˜æœ¬</h2>

                

                <!-- å››é˜¶æ®µçŠ¶æ€åŒº -->
                <div class="space-y-4 mb-8">
                    <!-- æ­¥éª¤1 -->
                    <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="step1">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                            <i id="step1-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-700 mb-1">åˆ†ææ•…äº‹å¤§çº²</div>
                            <p id="step1-detail" class="text-sm text-gray-500">å‡†å¤‡è§£ææ•…äº‹ç»“æ„å’Œè§’è‰²å…³ç³»...</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span id="step1-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                        </div>
                    </div>

                    <!-- æ­¥éª¤2 -->
                    <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="step2">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                            <i id="step2-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-700 mb-1">ç”Ÿæˆæ•…äº‹è„šæœ¬</div>
                            <p id="step2-detail" class="text-sm text-gray-500">ç­‰å¾…ç¼–å†™è¯¦ç»†çš„æ•…äº‹å†…å®¹...</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span id="step2-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                        </div>
                    </div>

                    <!-- æ­¥éª¤3 -->
                    <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="step3">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                            <i id="step3-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-700 mb-1">è®¾è®¡é¡µé¢å¸ƒå±€</div>
                            <p id="step3-detail" class="text-sm text-gray-500">ç­‰å¾…é¡µé¢å¸ƒå±€è®¾è®¡...</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span id="step3-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                        </div>
                    </div>

                    <!-- æ­¥éª¤4 -->
                    <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="step4">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                            <i id="step4-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-700 mb-1">ç”Ÿæˆæ’å›¾</div>
                            <p id="step4-detail" class="text-sm text-gray-500">ç­‰å¾…AIç»˜åˆ¶ç²¾ç¾æ’å›¾...</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span id="step4-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                        </div>
                    </div>

                </div>

                

                

                <!-- æç¤ºä¿¡æ¯ -->

                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-6">
                    <div class="flex items-center space-x-2">
                        <span class="text-amber-600">ğŸ’¡</span>
                        <span class="text-sm text-amber-700">æ‚¨å¯ä»¥å…³é—­çª—å£ï¼Œç”Ÿæˆä¼šåœ¨åå°ç»§ç»­</span>
                    </div>
                </div>

                

                <!-- æŒ‰é’® -->

                <div class="flex space-x-3">

                    <button onclick="closeProgressModal()" class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium">

                        åœ¨åå°ç»§ç»­

                    </button>

                    <button onclick="cancelGeneration()" class="flex-1 px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all duration-200 font-medium">

                        å–æ¶ˆç”Ÿæˆ

                    </button>

                </div>

            </div>

        </div>

    </div>



    <!-- Confirm ç¡®è®¤å¯¹è¯æ¡† -->

    <div id="confirmModal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center">

        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="confirmDialog">

            <div class="p-6">

                <div class="flex items-start gap-4">

                    <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">

                        <i data-lucide="alert-circle" class="w-6 h-6 text-amber-600"></i>

                    </div>

                    <div class="flex-1">

                        <h3 class="text-lg font-semibold text-gray-900 mb-2" id="confirmTitle">ç¡®è®¤æ“ä½œ</h3>

                        <p class="text-gray-600 text-sm leading-relaxed" id="confirmMessage">ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>

                    </div>

                </div>

            </div>

            <div class="border-t border-gray-100 p-4 flex gap-3 justify-end">

                <button onclick="closeConfirm(false)" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">

                    å–æ¶ˆ

                </button>

                <button onclick="closeConfirm(true)" class="px-5 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all" id="confirmButton">

                    ç¡®å®š

                </button>

            </div>

        </div>

    </div>



    <!-- Alert æç¤ºå¯¹è¯æ¡† -->

    <div id="alertModal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center">

        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="alertDialog">

            <div class="p-6">

                <div class="flex items-start gap-4">

                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">

                        <i data-lucide="info" class="w-6 h-6 text-blue-600"></i>

                    </div>

                    <div class="flex-1">

                        <h3 class="text-lg font-semibold text-gray-900 mb-2">æç¤º</h3>

                        <p class="text-gray-600 text-sm leading-relaxed" id="alertMessage">è¿™æ˜¯ä¸€æ¡æç¤ºä¿¡æ¯</p>

                    </div>

                </div>

            </div>

            <div class="border-t border-gray-100 p-4 flex justify-end">

                <button onclick="closeAlert()" class="px-6 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all">

                    ç¡®å®š

                </button>

            </div>

        </div>

    </div>


    <!-- ç»˜æœ¬é˜…è¯»å™¨å…¨å±å¼¹çª— -->
    <div id="storybookViewer" class="fixed inset-0 bg-black/90 z-[200] hidden">
        <!-- é¡¶éƒ¨å·¥å…·æ  -->
        <header class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm">
            <button onclick="closeStorybookViewer()" class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-all">
                <i data-lucide="x" class="w-5 h-5"></i>
                <span class="font-medium">å…³é—­</span>
            </button>
            
            <h2 id="storybookTitle" class="text-xl font-bold text-gray-800">ä¸‘å°é¸­çš„æ˜¥å¤©</h2>
            
            <div class="flex items-center gap-2 text-sm text-gray-600">
                <span id="currentPageNum">1</span>
                <span>/</span>
                <span id="totalPageNum">12</span>
            </div>
        </header>

        <!-- ä¸»é˜…è¯»åŒº -->
        <main class="h-[calc(100vh-136px)] flex items-center justify-center px-8 py-6">
            <div class="flex gap-8 h-full">
                <!-- å·¦ä¾§å›¾ç‰‡åŒº - ä¿æŒå›¾ç‰‡åŸå§‹æ¯”ä¾‹ -->
                <div id="imageContainer" class="h-full flex items-center justify-center bg-white rounded-2xl shadow-2xl overflow-hidden">
                    <img id="storybookImage" src="" alt="ç»˜æœ¬æ’å›¾" class="h-full w-auto object-contain" style="opacity: 1; transition: opacity 0.4s ease-out, transform 0.4s ease-out;">
                </div>

                <!-- å³ä¾§æ–‡å­—åŒº - ä¸å›¾ç‰‡ç­‰é«˜ -->
<div id="textContainer" class="h-full rounded-2xl shadow-2xl p-12 flex flex-col justify-center relative" style="aspect-ratio: 1 / 1; opacity: 1; transition: opacity 0.4s ease-out, transform 0.4s ease-out; 
background: 
  /* ä¸»èƒŒæ™¯è‰² */
  linear-gradient(135deg, #faf9f7 0%, #f0ede8 100%),
  /* çº¸å¼ çº¹ç† - ç»†å¯†çš„ç‚¹çŠ¶çº¹ç† */
  radial-gradient(circle at 1px 1px, rgba(0,0,0,0.15) 1px, transparent 0),
  /* äº¤å‰ç»‡çº¹ */
  repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0,0,0,0.03) 1px, rgba(0,0,0,0.03) 2px),
  repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(0,0,0,0.03) 1px, rgba(0,0,0,0.03) 2px),
  /* å¤§èŒƒå›´çš„è‰²å½©å˜åŒ– */
  radial-gradient(circle at 20% 20%, rgba(255,248,220,0.4) 0%, transparent 50%),
  radial-gradient(circle at 80% 80%, rgba(245,245,220,0.3) 0%, transparent 50%);
background-size: 
  100% 100%,
  20px 20px,
  2px 2px,
  2px 2px,
  200px 200px,
  300px 300px;">
                    <div id="storybookText" class="text-gray-800 text-2xl leading-relaxed space-y-4">
                        æ˜¥å¤©æ¥äº†ï¼Œåœ¨æ¸©æš–çš„èŠ¦è‹‡ä¸›é‡Œï¼Œé¸­å¦ˆå¦ˆæ­£åœ¨å­µè›‹ã€‚çªé‡Œçš„å°å®¶ä¼™ä»¬éƒ½å‡ºæ¥äº†ï¼Œåªæœ‰é‚£é¢—æœ€å¤§ã€æœ€ç‰¹åˆ«çš„è›‹è¿˜é™æ‚„æ‚„çš„ã€‚
                    </div>
                    <!-- é‡æ–°å¼€å§‹æŒ‰é’® - åªåœ¨æœ€åä¸€é¡µæ˜¾ç¤º -->
                    <div id="restartButton" class="mt-8 text-center hidden">
                        <button onclick="restartStorybook()" class="px-4 py-2 border border-gray-300 rounded-full text-gray-500 hover:text-primary-600 hover:border-primary-600 transition-colors duration-200 flex items-center gap-2 mx-auto">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                            <span>é‡æ–°å¼€å§‹</span>
                        </button>
                    </div>
                    <!-- é¡µç  - å³ä¸‹è§’ -->
                    <div class="absolute bottom-8 right-8 text-2xl font-medium text-gray-400">
                        <span id="pageNumberDisplay">1</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- åº•éƒ¨ç¿»é¡µæ§åˆ¶ -->
        <footer class="bg-white border-t border-gray-200 px-6 py-4 shadow-sm">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <button id="prevPageBtn" onclick="previousPage()" class="flex items-center gap-2 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-primary-500">
                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    <span>ä¸Šä¸€é¡µ</span>
                </button>

                <!-- é¡µç æŒ‡ç¤ºå™¨ -->
                <div class="flex items-center gap-2">
                    <div id="pageIndicators" class="flex gap-2"></div>
                </div>

                <button id="nextPageBtn" onclick="nextPage()" class="flex items-center gap-2 px-6 py-3 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-primary-500">
                    <span>ä¸‹ä¸€é¡µ</span>
                    <i data-lucide="chevron-right" class="w-5 h-5"></i>
                </button>
            </div>
        </footer>
    </div>

    <!-- AIç”ŸæˆåŠ è½½é®ç½© -->
    <div id="aiLoadingModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[150] hidden flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-full mx-4 p-8 transform transition-all scale-95 opacity-0" id="aiLoadingCard">
            

            <!-- ä¸»æ ‡é¢˜ -->
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">AIæ­£åœ¨ç”Ÿæˆæ•…äº‹å¤§çº²</h2>

            <!-- å››é˜¶æ®µçŠ¶æ€åŒº -->
            <div class="space-y-4 mb-8">
                <!-- é˜¶æ®µ1 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage1-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage1-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">åˆ†ææ•…äº‹ä¸»é¢˜</div>
                        <p id="stage1-detail" class="text-sm text-gray-500">å‡†å¤‡åˆ†ææ‚¨çš„æ•…äº‹åˆ›æ„å’Œæ ¸å¿ƒä¸»é¢˜...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage1-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                    </div>
                </div>

                <!-- é˜¶æ®µ2 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage2-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage2-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">ç”Ÿæˆè§’è‰²è®¾å®š</div>
                        <p id="stage2-detail" class="text-sm text-gray-500">ç­‰å¾…åˆ›å»ºæ•…äº‹ä¸­çš„ä¸»è¦è§’è‰²...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage2-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                    </div>
                </div>

                <!-- é˜¶æ®µ3 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage3-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage3-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">ç”Ÿæˆåœºæ™¯è®¾å®š</div>
                        <p id="stage3-detail" class="text-sm text-gray-500">ç­‰å¾…æ„å»ºæ•…äº‹å‘ç”Ÿçš„åœºæ™¯...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage3-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                    </div>
                </div>

                <!-- é˜¶æ®µ4 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage4-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage4-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">ç”Ÿæˆæ•…äº‹å¤§çº²</div>
                        <p id="stage4-detail" class="text-sm text-gray-500">ç­‰å¾…ç¼–å†™å®Œæ•´çš„æ•…äº‹å¤§çº²...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage4-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">ç­‰å¾…ä¸­</span>
                    </div>
                </div>
            </div>

            <!-- æ€»ä½“è¿›åº¦æ¡ -->
            <div class="mb-6">
                <div class="flex items-center justify-center">
                    <div class="text-lg font-medium text-gray-600" id="overall-status">å‡†å¤‡å¼€å§‹åˆ›ä½œ...</div>
                </div>
            </div>

            <!-- åº•éƒ¨æç¤º -->
            <div class="text-center">
                <p id="loading-tip" class="text-sm text-gray-500 flex items-center justify-center gap-2">
                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                    <span>AIæ­£åœ¨å‘æŒ¥åˆ›æ„ï¼Œè¯·ç¨å€™...</span>
                </p>
            </div>

        </div>

    </div>



    <script>

        // åˆå§‹åŒ– Lucide å›¾æ ‡

        lucide.createIcons();



        // ========== è‡ªå®šä¹‰å¯¹è¯æ¡†ç»„ä»¶ ==========

        

        let confirmCallback = null;

        

        // è‡ªå®šä¹‰ Confirm å¯¹è¯æ¡†

        function showConfirm(message, title = 'ç¡®è®¤æ“ä½œ', confirmText = 'ç¡®å®š') {

            return new Promise((resolve) => {

                const modal = document.getElementById('confirmModal');

                const dialog = document.getElementById('confirmDialog');

                const titleEl = document.getElementById('confirmTitle');

                const messageEl = document.getElementById('confirmMessage');

                const confirmBtn = document.getElementById('confirmButton');

                

                titleEl.textContent = title;

                messageEl.textContent = message;

                confirmBtn.textContent = confirmText;

                

                confirmCallback = resolve;

                

                modal.classList.remove('hidden');

                setTimeout(() => {

                    dialog.classList.remove('scale-95', 'opacity-0');

                    dialog.classList.add('scale-100', 'opacity-100');

                }, 10);

                

                lucide.createIcons();

            });

        }

        

        function closeConfirm(result) {

            const modal = document.getElementById('confirmModal');

            const dialog = document.getElementById('confirmDialog');

            

            dialog.classList.add('scale-95', 'opacity-0');

            dialog.classList.remove('scale-100', 'opacity-100');

            

            setTimeout(() => {

                modal.classList.add('hidden');

                if (confirmCallback) {

                    confirmCallback(result);

                    confirmCallback = null;

                }

            }, 200);

        }

        

        // è‡ªå®šä¹‰ Alert å¯¹è¯æ¡†

        function showAlert(message, title = 'æç¤º') {

            return new Promise((resolve) => {

                const modal = document.getElementById('alertModal');

                const dialog = document.getElementById('alertDialog');

                const messageEl = document.getElementById('alertMessage');

                

                messageEl.textContent = message;

                

                window.alertCallback = resolve;

                

                modal.classList.remove('hidden');

                setTimeout(() => {

                    dialog.classList.remove('scale-95', 'opacity-0');

                    dialog.classList.add('scale-100', 'opacity-100');

                }, 10);

                

                lucide.createIcons();

            });

        }

        

        function closeAlert() {

            const modal = document.getElementById('alertModal');

            const dialog = document.getElementById('alertDialog');

            

            dialog.classList.add('scale-95', 'opacity-0');

            dialog.classList.remove('scale-100', 'opacity-100');

            

            setTimeout(() => {

                modal.classList.add('hidden');

                if (window.alertCallback) {

                    window.alertCallback();

                    window.alertCallback = null;

                }

            }, 200);

        }



        // è¿”å›ä¸Šä¸€é¡µ

        async function goBack() {

            const confirmed = await showConfirm('ç¡®å®šè¦è¿”å›å—ï¼Ÿ', 'è¿”å›ç¡®è®¤');

            if (confirmed) {

                window.history.back();

            }

        }



        // è¿›å…¥æˆ‘çš„ç»˜æœ¬é¡µé¢

        async function goToMyBooks() {

            await showAlert('è·³è½¬åˆ°æˆ‘çš„ç»˜æœ¬é¡µé¢');

            // window.location.href = 'my-books.html';

        }



        // ç”Ÿæˆå¤§çº²

        async function generateOutline() {

            const storyInput = document.getElementById('storyInput').value.trim();

            

            if (!storyInput) {

                await showAlert('è¯·å…ˆè¾“å…¥æ•…äº‹åˆ›æ„ï¼');

                return;

            }



            // æ˜¾ç¤ºAIåŠ è½½åŠ¨ç”»
            showAILoading();
        }

        // æ˜¾ç¤ºAIåŠ è½½åŠ¨ç”»
        function showAILoading() {
            const modal = document.getElementById('aiLoadingModal');
            const card = document.getElementById('aiLoadingCard');
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
            
            setTimeout(() => {
                card.classList.remove('scale-95', 'opacity-0');
                card.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            lucide.createIcons();
            
            // å¼€å§‹è¿›åº¦æ¨¡æ‹Ÿ
            startAILoadingProgress();
        }

        // å…³é—­AIåŠ è½½åŠ¨ç”»
        function closeAILoading() {
            const modal = document.getElementById('aiLoadingModal');
            const card = document.getElementById('aiLoadingCard');
            
            card.classList.add('scale-95', 'opacity-0');
            card.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // æ›´æ–°é˜¶æ®µçŠ¶æ€
        function updateStageStatus(stage, status, detail = '') {
            const container = document.getElementById(`stage${stage}-container`);
            const icon = document.getElementById(`stage${stage}-icon`);
            const statusText = document.getElementById(`stage${stage}-status`);
            const detailText = document.getElementById(`stage${stage}-detail`);
            
            // æ›´æ–°å®¹å™¨æ ·å¼å’Œå›¾æ ‡
            if (status === 'waiting') {
                container.className = 'flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300';
                container.querySelector('.w-10').className = 'flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center';
                icon.outerHTML = '<i id="stage' + stage + '-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>';
                statusText.textContent = 'ç­‰å¾…ä¸­';
                statusText.className = 'text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full';
            } else if (status === 'processing') {
                container.className = 'flex items-center gap-4 p-4 rounded-xl bg-blue-50 border border-blue-300 transition-all duration-300';
                container.querySelector('.w-10').className = 'flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center';
                icon.outerHTML = '<i id="stage' + stage + '-icon" data-lucide="loader-2" class="w-5 h-5 text-white animate-spin"></i>';
                statusText.textContent = 'è¿›è¡Œä¸­';
                statusText.className = 'text-sm font-medium text-blue-600 px-3 py-1 bg-blue-200 rounded-full';
            } else if (status === 'completed') {
                container.className = 'flex items-center gap-4 p-4 rounded-xl bg-green-50 border border-green-300 transition-all duration-300';
                container.querySelector('.w-10').className = 'flex-shrink-0 w-10 h-10 rounded-full bg-green-500 flex items-center justify-center';
                icon.outerHTML = '<i id="stage' + stage + '-icon" data-lucide="check-circle" class="w-5 h-5 text-white"></i>';
                statusText.textContent = 'å·²å®Œæˆ';
                statusText.className = 'text-sm font-medium text-green-600 px-3 py-1 bg-green-200 rounded-full';
            }
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            if (detail) {
                detailText.textContent = detail;
            }
            
            lucide.createIcons();
        }

        // æ›´æ–°æ€»ä½“çŠ¶æ€
        function updateOverallStatus(message) {
            const statusElement = document.getElementById('overall-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // æ›´æ–°æç¤ºæ–‡æ¡ˆ
        function updateLoadingTip(tip) {
            const tipElement = document.getElementById('loading-tip');
            tipElement.innerHTML = `<i data-lucide="lightbulb" class="w-4 h-4"></i><span>${tip}</span>`;
            lucide.createIcons();
        }

        // å¼€å§‹è¿›åº¦æ¨¡æ‹Ÿï¼ˆ10ç§’æ¼”ç¤ºç‰ˆï¼‰
        function startAILoadingProgress() {
            const totalDuration = 10000; // æ€»æ—¶é•¿10ç§’
            const startTime = Date.now();
            
            const tips = [
                'âœ¨ AIæ­£åœ¨å‘æŒ¥åˆ›æ„ï¼Œä¸ºæ‚¨é‡èº«å®šåˆ¶æ•…äº‹...',
                'ğŸ“ ç”Ÿæˆçš„å¤§çº²å®Œå…¨å¯ä»¥è‡ªç”±ç¼–è¾‘å’Œè°ƒæ•´',
                'ğŸ­ ç²¾å½©çš„è§’è‰²å’Œæƒ…èŠ‚å³å°†è¯ç”Ÿ...',
                'ğŸ¨ æ‚¨å¯ä»¥éšæ—¶ä¿®æ”¹æ•…äº‹çš„ä»»ä½•ç»†èŠ‚',
                'ğŸ“š æ¯ä¸ªæ•…äº‹éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„åˆ›ä½œ'
            ];
            
            let currentTipIndex = 0;
            
            // æç¤ºæ–‡æ¡ˆè½®æ’­ï¼ˆæ¯2.5ç§’åˆ‡æ¢ï¼‰
            const tipInterval = setInterval(() => {
                currentTipIndex = (currentTipIndex + 1) % tips.length;
                updateLoadingTip(tips[currentTipIndex]);
            }, 2500);
            
            // ä½¿ç”¨setIntervalä»£æ›¿requestAnimationFrameï¼Œæ¯50msæ›´æ–°ä¸€æ¬¡
            const updateInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                
                // é˜¶æ®µ1: 0-1s
                if (elapsed < 1000) {
                    updateStageStatus(1, 'processing', 'æ­£åœ¨æ·±å…¥åˆ†ææ‚¨çš„æ•…äº‹åˆ›æ„å’Œæ ¸å¿ƒä¸»é¢˜...');
                    updateOverallStatus('æ­£åœ¨åˆ†æä¸»é¢˜å†…å®¹...');
                } 
                // é˜¶æ®µ1å®Œæˆ
                else if (elapsed >= 1000 && elapsed < 1050) {
                    updateStageStatus(1, 'completed', 'âœ“ å·²è¯†åˆ«æ ¸å¿ƒä¸»é¢˜å’Œæƒ…æ„ŸåŸºè°ƒ');
                    updateOverallStatus('ä¸»é¢˜åˆ†æå®Œæˆï¼Œå¼€å§‹åˆ›å»ºè§’è‰²...');
                }
                
                // é˜¶æ®µ2: 1-3.5s
                else if (elapsed >= 1050 && elapsed < 3500) {
                    updateStageStatus(2, 'processing', 'æ­£åœ¨ç²¾å¿ƒè®¾è®¡ä¸»è¦è§’è‰²çš„æ€§æ ¼å’ŒèƒŒæ™¯...');
                    updateOverallStatus('æ­£åœ¨è®¾è®¡ä¸»è¦è§’è‰²...');
                }
                // é˜¶æ®µ2å®Œæˆ
                else if (elapsed >= 3500 && elapsed < 3550) {
                    updateStageStatus(2, 'completed', 'âœ“ å·²åˆ›å»ºç”ŸåŠ¨çš„è§’è‰²å½¢è±¡å’Œä¸°å¯ŒèƒŒæ™¯');
                    updateOverallStatus('è§’è‰²åˆ›å»ºå®Œæˆï¼Œå¼€å§‹è®¾è®¡åœºæ™¯...');
                }
                
                // é˜¶æ®µ3: 3.5-6s
                else if (elapsed >= 3550 && elapsed < 6000) {
                    updateStageStatus(3, 'processing', 'æ­£åœ¨æ„å»ºå¼•äººå…¥èƒœçš„æ•…äº‹åœºæ™¯...');
                    updateOverallStatus('æ­£åœ¨æ„å»ºæ•…äº‹åœºæ™¯...');
                }
                // é˜¶æ®µ3å®Œæˆ
                else if (elapsed >= 6000 && elapsed < 6050) {
                    updateStageStatus(3, 'completed', 'âœ“ å·²æ„å»ºè¯¦ç»†è€Œå¯Œæœ‰æƒ³è±¡åŠ›çš„åœºæ™¯');
                    updateOverallStatus('åœºæ™¯è®¾è®¡å®Œæˆï¼Œå¼€å§‹ç¼–å†™æ•…äº‹...');
                }
                
                // é˜¶æ®µ4: 6-10s - ä¸»è¦æ—¶é—´
                else if (elapsed >= 6050 && elapsed < 10000) {
                    const stage4Progress = ((elapsed - 6050) / 3950) * 100;
                    
                    // è®¡ç®—å½“å‰ç« èŠ‚è¿›åº¦
                    const currentChapter = Math.min(Math.ceil(stage4Progress / 100 * 8), 8);
                    updateStageStatus(4, 'processing', `æ­£åœ¨ç¼–å†™æ•…äº‹å¤§çº²ç¬¬ ${currentChapter} ç« èŠ‚...`);
                    updateOverallStatus(`æ­£åœ¨ç¼–å†™æ•…äº‹å¤§çº²... (ç¬¬ ${currentChapter} ç« èŠ‚)`);
                }
                // é˜¶æ®µ4å®Œæˆ
                else if (elapsed >= 10000) {
                    updateStageStatus(4, 'completed', 'âœ“ å·²ç”Ÿæˆå®Œæ•´çš„æ•…äº‹å¤§çº²å’Œç« èŠ‚å®‰æ’');
                    updateOverallStatus('ğŸ‰ å¤§çº²åˆ›ä½œå®Œæˆï¼');
                    
                    clearInterval(tipInterval);
                    clearInterval(updateInterval); // åœæ­¢æ›´æ–°
                    
                    // å»¶è¿Ÿ500msåå…³é—­åŠ è½½åŠ¨ç”»ï¼Œæ‰“å¼€å¤§çº²ç¡®è®¤å¼¹çª—
                    setTimeout(() => {
                        closeAILoading();
            setTimeout(() => {

                openOutlineModal();

                        }, 300);
            }, 500);

                }
            }, 50); // æ¯50msæ›´æ–°ä¸€æ¬¡
        }



        // é€‰æ‹©ç²¾é€‰æ•…äº‹

        async function selectStory(storyName) {

            // å¦‚æœæ˜¯"ä¸‘å°é¸­çš„æ˜¥å¤©"ï¼Œç›´æ¥æ‰“å¼€é˜…è¯»å™¨
            if (storyName === 'ä¸‘å°é¸­çš„æ˜¥å¤©') {
                openStorybookViewer();
                return;
            }
            
            // å…¶ä»–ç»˜æœ¬æš‚æ—¶æ²¡æœ‰æ•ˆæœï¼ˆåŸå‹é˜¶æ®µï¼‰
            return;
        }

        // ========== ç»˜æœ¬é˜…è¯»å™¨åŠŸèƒ½ ==========
        
        // ç»˜æœ¬æ•°æ®
        const storybookData = {
            title: "ä¸‘å°é¸­çš„æ˜¥å¤©",
            pages: [
                {
                    pageNumber: 1,
                    image: "images/1.png",
                    text: "æ˜¥å¤©æ¥äº†ï¼Œåœ¨æ¸©æš–çš„èŠ¦è‹‡ä¸›é‡Œï¼Œé¸­å¦ˆå¦ˆæ­£åœ¨å­µè›‹ã€‚çªé‡Œçš„å°å®¶ä¼™ä»¬éƒ½å‡ºæ¥äº†ï¼Œåªæœ‰é‚£é¢—æœ€å¤§ã€æœ€ç‰¹åˆ«çš„è›‹è¿˜é™æ‚„æ‚„çš„ã€‚"
                },
                {
                    pageNumber: 2,
                    image: "images/2.png",
                    text: "\"å’”åš“ï¼\"ä¸€å£°ï¼Œè›‹å£³ç»ˆäºè£‚å¼€äº†ã€‚é‡Œé¢é’»å‡ºæ¥ä¸€åªæ¯›èŒ¸èŒ¸çš„å°å®¶ä¼™ï¼Œå¯ä»–é•¿å¾—åˆå¤§åˆç°ï¼Œä¸€ç‚¹ä¹Ÿä¸åƒå…¶ä»–çš„å°é¸­å­ã€‚"
                },
                {
                    pageNumber: 3,
                    image: "images/3.png",
                    text: "å†œåœºé‡Œçš„å…¶ä»–å°åŠ¨ç‰©çœ‹è§äº†ä»–ï¼Œéƒ½å›´è¿‡æ¥æŒ‡æŒ‡ç‚¹ç‚¹ã€‚\"çœ‹å•Šï¼Œä»–é•¿å¾—çœŸå¥‡æ€ªï¼\"å°é¸¡å’Œå°çŒ«ä¹Ÿéƒ½è·Ÿç€å˜²ç¬‘ä»–ã€‚"
                },
                {
                    pageNumber: 4,
                    image: "images/4.png",
                    text: "å°ç°å¿ƒé‡Œéš¾è¿‡æäº†ã€‚ä»–çœ‹ç€æ°´é‡Œè‡ªå·±ç°è‰²çš„å€’å½±ï¼Œè§‰å¾—è‡ªå·±æ˜¯ä¸–ç•Œä¸Šæœ€å­¤å•çš„\"é¸­å­\"ã€‚"
                },
                {
                    pageNumber: 5,
                    image: "images/5.png",
                    text: "ç»ˆäºï¼Œä»–å†ä¹Ÿå—ä¸äº†äº†ã€‚åœ¨ä¸€ä¸ªæ¸…æ™¨ï¼Œä»–æ‚„æ‚„åœ°ç¦»å¼€äº†æ± å¡˜ï¼Œå†³å®šå»å¯»æ‰¾ä¸€ä¸ªèƒ½æ¥çº³ä»–çš„åœ°æ–¹ã€‚"
                },
                {
                    pageNumber: 6,
                    image: "images/6.png",
                    text: "ä»–æ¥åˆ°ä¸€ç‰‡è’å‡‰çš„æ²¼æ³½ã€‚ç§‹é£ç‘Ÿç‘Ÿï¼Œä»–å®³æ€•åœ°èº²åœ¨æ¯é»„çš„èŠ¦è‹‡é‡Œï¼Œåˆå†·åˆé¥¿ï¼Œåªèƒ½æŠŠè‡ªå·±ç¼©æˆä¸€å›¢ã€‚"
                },
                {
                    pageNumber: 7,
                    image: "images/7.png",
                    text: "å¯’å†·çš„å†¬å¤©æ¥ä¸´äº†ï¼Œæ²¼æ³½ç»“äº†åšåšçš„å†°ã€‚å¯æ€œçš„å°ç°åœ¨æ°´é‡Œæ¸¸ç€ï¼Œæœ€åè¢«ç‰¢ç‰¢åœ°å†»åœ¨äº†å†°é¢ä¸Šï¼ŒåŠ¨å¼¹ä¸å¾—ã€‚"
                },
                {
                    pageNumber: 8,
                    image: "images/8.png",
                    text: "ä¸€ä½å–„è‰¯çš„å†œå¤«å‘ç°äº†ä»–ï¼Œå°å¿ƒç¿¼ç¿¼åœ°å‡¿å¼€å†°å—ï¼ŒæŠŠä»–å¸¦å›äº†è‡ªå·±æ¸©æš–çš„å°å±‹é‡Œï¼Œæ”¾åœ¨å£ç‚‰æ—è¾¹ã€‚"
                },
                {
                    pageNumber: 9,
                    image: "images/9.png",
                    text: "å±‹å­é‡Œçš„åµé—¹å£°æŠŠä»–æƒŠé†’äº†ã€‚æƒŠæ…Œå¤±æªçš„å°ç°è·Œè·Œæ’æ’ï¼Œæ‰“ç¿»äº†åœ°ä¸Šçš„ç‰›å¥¶ç›†ï¼Œåˆä¸€æ¬¡ä»“çš‡åœ°é€ƒäº†å‡ºå»ã€‚"
                },
                {
                    pageNumber: 10,
                    image: "images/10.png",
                    text: "ä¸çŸ¥ä¸è§‰ï¼Œæ˜¥å¤©åˆæ¥äº†ã€‚å°ç°æ¥åˆ°ä¸€ä¸ªç¾ä¸½çš„æ¹–è¾¹ï¼Œä»–çœ‹åˆ°ä¸€ç¾¤æ´ç™½ä¼˜é›…çš„é¸Ÿå„¿åœ¨æ°´ä¸­æ¸¸å¼‹ï¼Œç¾å¾—è®©ä»–çœ‹å‘†äº†ã€‚"
                },
                {
                    pageNumber: 11,
                    image: "images/11.png",
                    text: "ä»–è‡ªå‘åœ°ä½ä¸‹å¤´ï¼Œå´åœ¨æ¸…æ¾ˆå¦‚é•œçš„æ¹–æ°´ä¸­ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå…¨æ–°çš„è‡ªå·±â€”â€”ä¸€åªåŒæ ·æ´ç™½ã€ç¾ä¸½çš„é’å¹´å¤©é¹…ï¼"
                },
                {
                    pageNumber: 12,
                    image: "images/12.png",
                    text: "å¤©é¹…ä»¬çƒ­æƒ…åœ°å‘ä»–æ¸¸æ¥ï¼Œæ¬¢è¿ä»–å›å®¶ã€‚å°ç°å±•å¼€ç¿…è†€ï¼Œæµä¸‹äº†å–œæ‚¦çš„æ³ªæ°´ã€‚ä»–ç»ˆäºæ˜ç™½ï¼Œè‡ªå·±ä¸æ˜¯ä¸‘å°é¸­ï¼Œè€Œæ˜¯ä¸€åªæœ€ç‰¹åˆ«çš„å°å¤©é¹…ã€‚"
                }
            ]
        };

        let currentPage = 1;
        let isPageTransitioning = false; // é˜²æ­¢å¿«é€Ÿç¿»é¡µ
        const imageCache = {}; // å›¾ç‰‡ç¼“å­˜

        // é¢„åŠ è½½å›¾ç‰‡
        function preloadImage(src) {
            return new Promise((resolve, reject) => {
                if (imageCache[src]) {
                    resolve(imageCache[src]);
                    return;
                }
                
                const img = new Image();
                img.onload = () => {
                    imageCache[src] = img;
                    resolve(img);
                };
                img.onerror = reject;
                img.src = src;
            });
        }

        // é¢„åŠ è½½ç›¸é‚»é¡µé¢çš„å›¾ç‰‡
        function preloadAdjacentPages(pageNum) {
            const prevPage = storybookData.pages[pageNum - 2];
            const nextPage = storybookData.pages[pageNum];
            
            if (prevPage) {
                preloadImage(prevPage.image).catch(() => {});
            }
            if (nextPage) {
                preloadImage(nextPage.image).catch(() => {});
            }
        }

        // æ‰“å¼€ç»˜æœ¬é˜…è¯»å™¨
        function openStorybookViewer(startPage = 1) {
            currentPage = startPage;
            const viewer = document.getElementById('storybookViewer');
            
            viewer.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // è®¾ç½®æ ‡é¢˜å’Œæ€»é¡µæ•°
            document.getElementById('storybookTitle').textContent = storybookData.title;
            document.getElementById('totalPageNum').textContent = storybookData.pages.length;
            
            // æ¸²æŸ“é¡µç æŒ‡ç¤ºå™¨
            renderPageIndicators();
            
            // æ˜¾ç¤ºå½“å‰é¡µ
            showPage(currentPage);
            
            // é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡(ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ)
            storybookData.pages.forEach(page => {
                preloadImage(page.image).catch(() => {});
            });
            
            lucide.createIcons();
        }

        // å…³é—­ç»˜æœ¬é˜…è¯»å™¨
        function closeStorybookViewer() {
            const viewer = document.getElementById('storybookViewer');
            viewer.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // æ˜¾ç¤ºæŒ‡å®šé¡µ(å¸¦å¹³æ»‘è¿‡æ¸¡)
        async function showPage(pageNum) {
            if (isPageTransitioning) return;
            
            const page = storybookData.pages[pageNum - 1];
            if (!page) return;
            
            isPageTransitioning = true;
            
            const imageEl = document.getElementById('storybookImage');
            const textEl = document.getElementById('storybookText');
            const imageContainer = document.getElementById('imageContainer');
            const textContainer = document.getElementById('textContainer');
            
            // æ­¥éª¤1: æ·¡å‡ºå½“å‰å†…å®¹
            imageEl.style.opacity = '0';
            imageEl.style.transform = 'scale(0.95)';
            textContainer.style.opacity = '0';
            textContainer.style.transform = 'translateY(10px)';
            
            // æ­¥éª¤2: æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            imageContainer.classList.add('image-loading');
            
            // æ­¥éª¤3: é¢„åŠ è½½æ–°å›¾ç‰‡
            try {
                await preloadImage(page.image);
                
                // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // æ­¥éª¤4: æ›´æ–°å†…å®¹
                imageEl.src = page.image;
                textEl.textContent = page.text;
                
                // æ›´æ–°é¡µç æ˜¾ç¤º
                document.getElementById('currentPageNum').textContent = pageNum;
                document.getElementById('pageNumberDisplay').textContent = pageNum;
                
                // æ­¥éª¤5: ç§»é™¤åŠ è½½çŠ¶æ€
                imageContainer.classList.remove('image-loading');
                
                // æ­¥éª¤6: æ·¡å…¥æ–°å†…å®¹
                await new Promise(resolve => setTimeout(resolve, 50));
                imageEl.style.opacity = '1';
                imageEl.style.transform = 'scale(1)';
                textContainer.style.opacity = '1';
                textContainer.style.transform = 'translateY(0)';
                
            } catch (error) {
                console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', error);
                imageContainer.classList.remove('image-loading');
                // å³ä½¿åŠ è½½å¤±è´¥ä¹Ÿè¦æ˜¾ç¤ºå†…å®¹
                imageEl.src = page.image;
                textEl.textContent = page.text;
                imageEl.style.opacity = '1';
                imageEl.style.transform = 'scale(1)';
                textContainer.style.opacity = '1';
                textContainer.style.transform = 'translateY(0)';
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            
            prevBtn.disabled = pageNum === 1;
            nextBtn.disabled = pageNum === storybookData.pages.length;
            
            // æ˜¾ç¤º/éšè—é‡æ–°å¼€å§‹æŒ‰é’®(æœ€åä¸€é¡µæ˜¾ç¤º)
            const restartBtn = document.getElementById('restartButton');
            if (pageNum === storybookData.pages.length) {
                restartBtn.classList.remove('hidden');
                // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
                lucide.createIcons();
            } else {
                restartBtn.classList.add('hidden');
            }
            
            // æ›´æ–°é¡µç æŒ‡ç¤ºå™¨
            updatePageIndicators(pageNum);
            
            // é¢„åŠ è½½ç›¸é‚»é¡µé¢
            preloadAdjacentPages(pageNum);
            
            // ç­‰å¾…è¿‡æ¸¡å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 400));
            isPageTransitioning = false;
        }

        // æ¸²æŸ“é¡µç æŒ‡ç¤ºå™¨
        function renderPageIndicators() {
            const container = document.getElementById('pageIndicators');
            const totalPages = storybookData.pages.length;
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <button onclick="goToPage(${i})" 
                            class="page-indicator w-2.5 h-2.5 rounded-full transition-all ${i === currentPage ? 'bg-primary-500 w-8' : 'bg-gray-300 hover:bg-gray-400'}" 
                            data-page="${i}">
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }

        // æ›´æ–°é¡µç æŒ‡ç¤ºå™¨
        function updatePageIndicators(pageNum) {
            const indicators = document.querySelectorAll('.page-indicator');
            indicators.forEach((indicator, index) => {
                if (index + 1 === pageNum) {
                    indicator.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'w-2.5');
                    indicator.classList.add('bg-primary-500', 'w-8');
                } else {
                    indicator.classList.remove('bg-primary-500', 'w-8');
                    indicator.classList.add('bg-gray-300', 'hover:bg-gray-400', 'w-2.5');
                }
            });
        }

        // ä¸Šä¸€é¡µ
        function previousPage() {
            if (isPageTransitioning) return;
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        }

        // ä¸‹ä¸€é¡µ
        function nextPage() {
            if (isPageTransitioning) return;
            if (currentPage < storybookData.pages.length) {
                currentPage++;
                showPage(currentPage);
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToPage(pageNum) {
            if (isPageTransitioning) return;
            if (pageNum === currentPage) return;
            currentPage = pageNum;
            showPage(currentPage);
        }

        // é‡æ–°å¼€å§‹(å›åˆ°ç¬¬ä¸€é¡µ)
        function restartStorybook() {
            if (isPageTransitioning) return;
            currentPage = 1;
            showPage(1);
        }

        // é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            const viewer = document.getElementById('storybookViewer');
            if (!viewer.classList.contains('hidden')) {
                if (e.key === 'ArrowLeft') {
                    previousPage();
                } else if (e.key === 'ArrowRight') {
                    nextPage();
                } else if (e.key === 'Escape') {
                    closeStorybookViewer();
                }
            }
        });


        // ç›‘å¬Enteré”®ï¼ˆCtrl+Enteræäº¤ï¼‰

        document.getElementById('storyInput').addEventListener('keydown', function(e) {

            if (e.ctrlKey && e.key === 'Enter') {

                generateOutline();

            }

        });



        // ========== å¤§çº²å¼¹çª—ç›¸å…³åŠŸèƒ½ ==========

        

        // æ•…äº‹æ•°æ®

        let modalStoryData = {

            "core_elements": {

                "title": "ä¸‘å°é¸­çš„æ˜¥å¤©",

                "characters": [

                    {"name": "ä¸‘å°é¸­ï¼ˆå°é¸­å­ï¼‰", "description": "å¤–è¡¨ä¸ä¼—ä¸åŒï¼Œç¾½æ¯›ç°æ‰‘æ‰‘ï¼Œæ€§æ ¼æ•æ„Ÿå–„è‰¯ï¼Œæ¸´æœ›è¢«æ¥çº³ï¼Œæœ€ç»ˆå‘ç°è‡ªå·±æ˜¯ä¸€åªç¾ä¸½çš„å¤©é¹…ã€‚"},

                    {"name": "å†œåœºåŠ¨ç‰©ä»¬ï¼ˆé¸¡ã€é¸­ã€é¹…ç­‰ï¼‰", "description": "èµ·åˆå˜²ç¬‘å’Œæ’æŒ¤ä¸‘å°é¸­ï¼Œä»£è¡¨å¤–ç•Œçš„åè§å’Œä¸ç†è§£ã€‚"},

                    {"name": "å¤©é¹…ç¾¤", "description": "ä¼˜é›…å‹å–„ï¼Œæœ€ç»ˆæ¥çº³ä¸‘å°é¸­ï¼Œè±¡å¾çœŸæ­£çš„å½’å±ä¸è‡ªæˆ‘è®¤åŒã€‚"}

                ],

                "theme": "æ¥çº³è‡ªæˆ‘ï¼Œå‘ç°å†…åœ¨ä»·å€¼ï¼ŒçœŸæ­£çš„ç¾ä¸½æºäºèº«ä»½è®¤åŒä¸æˆé•¿ã€‚",

                "settings": [

                    {"name": "å†œåœºæ± å¡˜", "description": "æ•…äº‹å¼€ç«¯ï¼Œå……æ»¡å–§é—¹ä¸æ’æ–¥ï¼Œæ˜¯ä¸‘å°é¸­æœ€åˆè¢«è¯¯è§£çš„åœ°æ–¹ã€‚"},

                    {"name": "è’é‡æ²¼æ³½", "description": "ä¸‘å°é¸­æµæµªçš„å­¤ç‹¬ä¹‹åœ°ï¼Œç»å†å¯’å†·ä¸å¯‚å¯ï¼Œè±¡å¾æˆé•¿çš„è€ƒéªŒã€‚"},

                    {"name": "æ˜¥æ—¥æ¹–æ³Š", "description": "æ•…äº‹ç»“å±€ï¼Œå®é™ç¾ä¸½ï¼Œä¸‘å°é¸­åœ¨æ­¤é‡è§å¤©é¹…ç¾¤å¹¶è®¤å‡ºè‡ªå·±çš„çœŸå®èº«ä»½ã€‚"}

                ],

                "page_count": 10

            },

            "outline": [

                {"page_number": 1, "scene": "å†œåœºæ± å¡˜", "plot_summary": "åœ¨ä¸€ä¸ªé˜³å…‰æ˜åªšçš„å†œåœºæ± å¡˜è¾¹ï¼Œé¸­å¦ˆå¦ˆå­µå‡ºäº†ä¸€çªå°é¸­ï¼Œå…¶ä¸­ä¸€åªç°æ‰‘æ‰‘çš„å°é¸­æ ¼å¤–ä¸ä¼—ä¸åŒã€‚"},

                {"page_number": 2, "scene": "å†œåœºæ± å¡˜", "plot_summary": "é¸¡ã€é¸­å’Œé¹…éƒ½å˜²ç¬‘ä»–'ä¸‘'ï¼Œä¸æ„¿å’Œä»–ç©è€ï¼Œä¸‘å°é¸­æ„Ÿåˆ°ä¼¤å¿ƒåˆå­¤å•ã€‚"},

                {"page_number": 3, "scene": "å†œåœºæ± å¡˜", "plot_summary": "æ— è®ºä»–æ€ä¹ˆåŠªåŠ›èå…¥ï¼Œå¤§å®¶è¿˜æ˜¯æ’æ–¥ä»–ï¼Œä¸‘å°é¸­å†³å®šç¦»å¼€å†œåœºï¼Œå»å¯»æ‰¾å±äºè‡ªå·±çš„åœ°æ–¹ã€‚"},

                {"page_number": 4, "scene": "è’é‡æ²¼æ³½", "plot_summary": "ä¸‘å°é¸­ç‹¬è‡ªæµæµªåˆ°å¯’å†·çš„æ²¼æ³½ï¼Œé£å¹é›¨æ‰“ï¼Œä»–åªèƒ½èº²åœ¨èŠ¦è‹‡ä¸›ä¸­ç‘Ÿç‘Ÿå‘æŠ–ã€‚"},

                {"page_number": 5, "scene": "è’é‡æ²¼æ³½", "plot_summary": "é‡é¸­å’Œå¤§é›å¯¹ä»–å¥½å¥‡å´å†·æ¼ ï¼Œä»–ä¾ç„¶æ‰¾ä¸åˆ°æœ‹å‹ï¼Œå†¬å¤©æ¥äº†ï¼Œä»–å‡ ä¹å†»åƒµã€‚"},

                {"page_number": 6, "scene": "è’é‡æ²¼æ³½", "plot_summary": "ä¸€ä½å†œå¤«å¥½å¿ƒæ”¶ç•™ä»–ï¼Œä½†å®¶é‡Œçš„çŒ«å’Œæ¯é¸¡ä¹Ÿå«Œå¼ƒä»–ï¼Œä¸‘å°é¸­å†æ¬¡é€‰æ‹©ç¦»å¼€ã€‚"},

                {"page_number": 7, "scene": "è’é‡æ²¼æ³½", "plot_summary": "æ¼«é•¿çš„å†¬å¤©è¿‡å»ï¼Œä¸‘å°é¸­åœ¨é›ªåœ°é‡ŒæŒ£æ‰æ±‚ç”Ÿï¼Œå¿ƒä¸­å§‹ç»ˆæ€€ç€ä¸€ä¸å¸Œæœ›ã€‚"},

                {"page_number": 8, "scene": "æ˜¥æ—¥æ¹–æ³Š", "plot_summary": "æ˜¥å¤©æ¥ä¸´ï¼Œå†°é›ªèåŒ–ï¼Œä¸‘å°é¸­æ¥åˆ°ä¸€ç‰‡æ¸…æ¾ˆå®é™çš„æ¹–æ³Šï¼Œæ°´é¢å€’æ˜ å‡ºä»–ä¿®é•¿çš„è„–é¢ˆå’Œæ´ç™½çš„ç¾½æ¯›ã€‚"},

                {"page_number": 9, "scene": "æ˜¥æ—¥æ¹–æ³Š", "plot_summary": "ä¸€ç¾¤ä¼˜é›…çš„å¤©é¹…æ¸¸å‘ä»–ï¼Œçƒ­æƒ…åœ°æ¬¢è¿ä»–åŠ å…¥ï¼Œä¸‘å°é¸­ç»ˆäºæ˜ç™½è‡ªå·±ä¸æ˜¯ä¸‘å°é¸­ï¼Œè€Œæ˜¯ä¸€åªå¤©é¹…ã€‚"},

                {"page_number": 10, "scene": "æ˜¥æ—¥æ¹–æ³Š", "plot_summary": "ä¸‘å°é¸­åœ¨å¤©é¹…ç¾¤ä¸­å¿«ä¹åœ°æ¸¸æ³³ã€é£ç¿”ï¼Œä»–ä¸å†è‡ªå‘ï¼Œå› ä¸ºä»–æ‰¾åˆ°äº†çœŸæ­£çš„è‡ªå·±å’Œæ¸©æš–çš„å®¶ã€‚"}

            ]

        };



        // æ‰“å¼€å¼¹çª—

        function openOutlineModal() {

            document.getElementById('outlineModal').classList.remove('hidden');

            document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨

            initModalContent();

            lucide.createIcons();

        }



        // å…³é—­å¼¹çª—

        async function closeOutlineModal() {

            const confirmed = await showConfirm(

                'ç¡®å®šè¦å…³é—­å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¼šä¸¢å¤±ã€‚',

                'å…³é—­ç¡®è®¤'

            );

            if (confirmed) {

                document.getElementById('outlineModal').classList.add('hidden');

                document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨

            }

        }



        // åˆå§‹åŒ–å¼¹çª—å†…å®¹

        function initModalContent() {

            modalRenderCharacters();

            modalRenderSettings();

            modalRenderOutline();

            modalSetupEditableElements();

            modalUpdatePageCount();

        }



        // è®¾ç½®å¯ç¼–è¾‘å…ƒç´ 

        function modalSetupEditableElements() {

            const title = document.getElementById('modalStoryTitle');

            const theme = document.getElementById('modalThemeContent');



            title.addEventListener('click', function() {

                this.contentEditable = 'true';

                this.focus();

            });

            title.addEventListener('blur', function() {

                this.contentEditable = 'false';

                modalStoryData.core_elements.title = this.textContent.trim();

            });



            theme.addEventListener('click', function() {

                this.contentEditable = 'true';

                this.focus();

            });

            theme.addEventListener('blur', function() {

                this.contentEditable = 'false';

                modalStoryData.core_elements.theme = this.textContent.trim();

            });

        }



        // æ›´æ–°é¡µæ•°

        function modalUpdatePageCount() {

            const count = modalStoryData.outline.length;

            modalStoryData.core_elements.page_count = count;

            // ç§»é™¤é¡µæ•°æ˜¾ç¤ºï¼Œå› ä¸ºä¸çŸ¥é“æ¨¡å‹ä¼šè¾“å‡ºå¤šå°‘é¡µ

        }



        // æ¸²æŸ“è§’è‰²åˆ—è¡¨

        function modalRenderCharacters() {

            const container = document.getElementById('modalCharactersList');

            if (modalStoryData.core_elements.characters.length === 0) {

                container.innerHTML = '<div class="text-center py-6 text-sm text-gray-400">æš‚æ— è§’è‰²</div>';

                return;

            }



            container.innerHTML = modalStoryData.core_elements.characters.map((char, index) => `

                <div class="group relative bg-white border border-gray-200 rounded-xl p-3 mb-2.5 hover:border-primary-300 hover:shadow-sm transition-all">

                    <button onclick="modalDeleteCharacter(${index})" 

                            class="absolute top-2 right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">

                        <i data-lucide="x" class="w-3.5 h-3.5"></i>

                    </button>

                    <div onclick="modalEditCardField(this, 'characters', ${index}, 'name')" 

                         class="text-sm font-semibold text-gray-800 mb-1.5 px-1.5 py-1 rounded border border-transparent hover:bg-gray-50 cursor-pointer">${char.name}</div>

                    <div onclick="modalEditCardField(this, 'characters', ${index}, 'description')" 

                         class="text-xs text-gray-600 leading-relaxed px-1.5 py-1 rounded border border-transparent hover:bg-gray-50 cursor-pointer min-h-[36px]">${char.description}</div>

                </div>

            `).join('');

            lucide.createIcons();

        }



        // æ¸²æŸ“åœºæ™¯åˆ—è¡¨

        function modalRenderSettings() {

            const container = document.getElementById('modalSettingsList');

            if (modalStoryData.core_elements.settings.length === 0) {

                container.innerHTML = '<div class="text-center py-6 text-sm text-gray-400">æš‚æ— åœºæ™¯</div>';

                return;

            }



            container.innerHTML = modalStoryData.core_elements.settings.map((setting, index) => `

                <div class="group relative bg-white border border-gray-200 rounded-xl p-3 mb-2.5 hover:border-emerald-300 hover:shadow-sm transition-all">

                    <button onclick="modalDeleteSetting(${index})" 

                            class="absolute top-2 right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center">

                        <i data-lucide="x" class="w-3.5 h-3.5"></i>

                    </button>

                    <div onclick="modalEditCardField(this, 'settings', ${index}, 'name')" 

                         class="text-sm font-semibold text-gray-800 mb-1.5 px-1.5 py-1 rounded border border-transparent hover:bg-gray-50 cursor-pointer">${setting.name}</div>

                    <div onclick="modalEditCardField(this, 'settings', ${index}, 'description')" 

                         class="text-xs text-gray-600 leading-relaxed px-1.5 py-1 rounded border border-transparent hover:bg-gray-50 cursor-pointer min-h-[36px]">${setting.description}</div>

                </div>

            `).join('');

            lucide.createIcons();

            modalRenderOutline();

        }



        // æ¸²æŸ“å¤§çº²

        function modalRenderOutline(highlightIndex = -1) {

            const container = document.getElementById('modalOutlineList');

            const settingNames = modalStoryData.core_elements.settings.map(s => s.name);

            const pageCount = modalStoryData.outline.length;

            const canAdd = pageCount < 20;

            const canDelete = pageCount > 6;



            let html = '';

            

            modalStoryData.outline.forEach((page, index) => {

                // åœ¨æ¯é¡µä¹‹å‰æ·»åŠ æ’å…¥åŒºåŸŸï¼ˆåŒ…æ‹¬ç¬¬ä¸€é¡µï¼‰

                const isFirst = index === 0;

                const insertText = isFirst ? 'åœ¨å¼€å¤´æ’å…¥æ–°é¡µ' : 'åœ¨æ­¤å¤„æ’å…¥æ–°é¡µ';

                const isDisabled = !canAdd;

                

                html += `

                <div class="group/insert relative h-6 flex items-center justify-center ${isDisabled ? 'cursor-not-allowed' : 'cursor-pointer'} my-3" 

                     onclick="${isDisabled ? 'handleInsertDisabled()' : `modalInsertPageBefore(${index})`}">

                    <!-- ç»†çº¿ -->

                    <div class="absolute inset-0 flex items-center">

                        <div class="w-full border-t border-dashed ${isDisabled ? 'border-gray-200' : 'border-gray-200 group-hover/insert:border-primary-300'} transition-colors"></div>

                    </div>

                    <!-- ä¸­å¿ƒåœ†ç‚¹å’Œæ–‡å­— -->

                    <div class="relative bg-white px-3 flex items-center gap-2 ${isDisabled ? '' : 'group-hover/insert:bg-primary-50'} rounded-full transition-all">

                        <div class="w-1.5 h-1.5 rounded-full ${isDisabled ? 'bg-gray-300' : 'bg-gray-300 group-hover/insert:hidden'}"></div>

                        <div class="hidden ${isDisabled ? 'group-hover/insert:flex' : 'group-hover/insert:flex'} items-center gap-1.5 ${isDisabled ? 'text-gray-400' : 'text-primary-600'} text-xs font-medium">

                            <i data-lucide="${isDisabled ? 'alert-circle' : 'plus-circle'}" class="w-4 h-4"></i>

                            <span>${isDisabled ? 'å·²è¾¾æœ€å¤§é¡µæ•°(20é¡µ)' : insertText}</span>

                        </div>

                    </div>

                </div>`;

                

                // é¡µé¢å¡ç‰‡ï¼ˆæ·»åŠ é«˜äº®æ ‡è¯†ï¼‰

                const isHighlight = index === highlightIndex;

                html += `

                <div id="page-${index}" class="group relative bg-white border border-gray-200 rounded-xl p-5 mb-4 hover:border-primary-200 hover:shadow-md transition-all ${isHighlight ? 'page-highlight' : ''}">

                    ${canDelete ? `

                    <button onclick="event.stopPropagation(); modalDeletePage(${index})" 

                            class="absolute top-3 right-3 w-7 h-7 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center z-10">

                        <i data-lucide="x" class="w-4 h-4"></i>

                    </button>

                    ` : ''}

                    

                    <span class="inline-block px-4 py-1.5 bg-gradient-to-r from-primary-500 to-purple-600 text-white text-sm font-semibold rounded-full mb-3">

                        ç¬¬ ${page.page_number} é¡µ

                    </span>

                    

                    <div class="mb-3">

                        <label class="flex items-center gap-1.5 text-xs font-medium text-gray-600 mb-1.5">

                            <i data-lucide="map" class="w-3.5 h-3.5"></i>

                            <span>åœºæ™¯</span>

                        </label>

                        <select onchange="modalUpdateScene(${index}, this.value)" 

                                class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-700 focus:border-primary-400 focus:ring-2 focus:ring-primary-100 outline-none transition-all hover:border-gray-300 cursor-pointer">

                            <option value="">è¯·é€‰æ‹©åœºæ™¯</option>

                            ${settingNames.map(name => 

                                `<option value="${name}" ${page.scene === name ? 'selected' : ''}>${name}</option>`

                            ).join('')}

                        </select>

                    </div>



                    <div>

                        <label class="flex items-center gap-1.5 text-xs font-medium text-gray-600 mb-1.5">

                            <i data-lucide="file-text" class="w-3.5 h-3.5"></i>

                            <span>æƒ…èŠ‚å†…å®¹</span>

                        </label>

                        <textarea onblur="modalUpdatePlot(${index}, this.value)" 

                                  class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm text-gray-700 leading-relaxed resize-y min-h-[70px] focus:border-primary-400 focus:ring-2 focus:ring-primary-100 outline-none transition-all hover:border-gray-300">${page.plot_summary}</textarea>

                    </div>

                </div>`;

            });

            

            // åœ¨æœ€åä¸€é¡µä¹‹åæ·»åŠ æ’å…¥åŒºåŸŸï¼ˆå’Œä¸Šé¢æ ·å¼ä¸€è‡´ï¼‰
            const endBtnDisabled = !canAdd;

            html += `

            <div class="group/insert relative h-6 flex items-center justify-center ${endBtnDisabled ? 'cursor-not-allowed' : 'cursor-pointer'} my-3" 
                 onclick="${endBtnDisabled ? 'handleInsertDisabled()' : `modalInsertPageAfter(${pageCount - 1})`}">
                <!-- ç»†çº¿ -->
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-dashed ${endBtnDisabled ? 'border-gray-200' : 'border-gray-200 group-hover/insert:border-primary-300'} transition-colors"></div>
                </div>
                <!-- ä¸­å¿ƒåœ†ç‚¹å’Œæ–‡å­— -->
                <div class="relative bg-white px-3 flex items-center gap-2 ${endBtnDisabled ? '' : 'group-hover/insert:bg-primary-50'} rounded-full transition-all">
                    <div class="w-1.5 h-1.5 rounded-full ${endBtnDisabled ? 'bg-gray-300' : 'bg-gray-300 group-hover/insert:hidden'}"></div>
                    <div class="hidden ${endBtnDisabled ? 'group-hover/insert:flex' : 'group-hover/insert:flex'} items-center gap-1.5 ${endBtnDisabled ? 'text-gray-400' : 'text-primary-600'} text-xs font-medium">
                        <i data-lucide="${endBtnDisabled ? 'alert-circle' : 'plus-circle'}" class="w-4 h-4"></i>
                    <span>${endBtnDisabled ? 'å·²è¾¾æœ€å¤§é¡µæ•°(20é¡µ)' : 'åœ¨æœ«å°¾æ·»åŠ æ–°é¡µ'}</span>

                    </div>
                </div>
            </div>`;

            

            container.innerHTML = html;

            lucide.createIcons();

            

            // å¦‚æœæœ‰é«˜äº®é¡µé¢ï¼Œæ»šåŠ¨åˆ°è¯¥ä½ç½®å¹¶è®¾ç½®3ç§’åç§»é™¤é«˜äº®

            if (highlightIndex >= 0) {

                setTimeout(() => {

                    const highlightElement = document.getElementById(`page-${highlightIndex}`);

                    if (highlightElement) {

                        highlightElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        

                        // 3ç§’åç§»é™¤é«˜äº®

                        setTimeout(() => {

                            highlightElement.classList.remove('page-highlight');

                            highlightElement.classList.add('page-highlight-remove');

                            

                            // å†è¿‡0.5ç§’ç§»é™¤è¿‡æ¸¡ç±»

                            setTimeout(() => {

                                highlightElement.classList.remove('page-highlight-remove');

                            }, 500);

                        }, 3000);

                    }

                }, 100);

            }

        }



        // ç¼–è¾‘å¡ç‰‡å­—æ®µ

        function modalEditCardField(element, type, index, field) {

            element.contentEditable = 'true';

            element.classList.add('border-primary-400', 'ring-2', 'ring-primary-100', 'bg-white');

            element.focus();



            element.onblur = function() {

                this.contentEditable = 'false';

                this.classList.remove('border-primary-400', 'ring-2', 'ring-primary-100', 'bg-white');

                const value = this.textContent.trim();

                if (value) {

                    modalStoryData.core_elements[type][index][field] = value;

                    if (type === 'settings' && field === 'name') {

                        modalRenderOutline();

                    }

                } else {

                    this.textContent = modalStoryData.core_elements[type][index][field];

                }

            };

        }



        // æ·»åŠ è§’è‰²

        function modalAddCharacter() {

            modalStoryData.core_elements.characters.push({

                name: 'æ–°è§’è‰²',

                description: 'è¯·è¾“å…¥è§’è‰²æè¿°...'

            });

            modalRenderCharacters();

            showToast('å·²æ·»åŠ æ–°è§’è‰²');

        }



        // åˆ é™¤è§’è‰²

        async function modalDeleteCharacter(index) {

            const char = modalStoryData.core_elements.characters[index];

            const confirmed = await showConfirm(

                `ç¡®å®šè¦åˆ é™¤è§’è‰²"${char.name}"å—ï¼Ÿ`,

                'åˆ é™¤è§’è‰²'

            );

            if (confirmed) {

                modalStoryData.core_elements.characters.splice(index, 1);

                modalRenderCharacters();

                showToast('å·²åˆ é™¤è§’è‰²');

            }

        }



        // æ·»åŠ åœºæ™¯

        function modalAddSetting() {

            modalStoryData.core_elements.settings.push({

                name: 'æ–°åœºæ™¯',

                description: 'è¯·è¾“å…¥åœºæ™¯æè¿°...'

            });

            modalRenderSettings();

            showToast('å·²æ·»åŠ æ–°åœºæ™¯');

        }



        // åˆ é™¤åœºæ™¯

        async function modalDeleteSetting(index) {

            const setting = modalStoryData.core_elements.settings[index];

            const sceneName = setting.name;

            

            const usedInPages = modalStoryData.outline.filter(page => page.scene === sceneName);

            

            let confirmed;

            if (usedInPages.length > 0) {

                confirmed = await showConfirm(

                    `åœºæ™¯"${sceneName}"æ­£åœ¨è¢« ${usedInPages.length} ä¸ªé¡µé¢ä½¿ç”¨ï¼Œåˆ é™¤åè¿™äº›é¡µé¢çš„åœºæ™¯å°†è¢«æ¸…ç©ºã€‚ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ`,

                    'åˆ é™¤åœºæ™¯'

                );

                if (!confirmed) return;

                

                modalStoryData.outline.forEach(page => {

                    if (page.scene === sceneName) page.scene = '';

                });

            } else {

                confirmed = await showConfirm(

                    `ç¡®å®šè¦åˆ é™¤åœºæ™¯"${sceneName}"å—ï¼Ÿ`,

                    'åˆ é™¤åœºæ™¯'

                );

                if (!confirmed) return;

            }

            

            modalStoryData.core_elements.settings.splice(index, 1);

            modalRenderSettings();

            showToast('å·²åˆ é™¤åœºæ™¯');

        }



        // æ›´æ–°åœºæ™¯

        function modalUpdateScene(index, scene) {

            modalStoryData.outline[index].scene = scene;

        }



        // æ›´æ–°æƒ…èŠ‚

        function modalUpdatePlot(index, plot) {

            modalStoryData.outline[index].plot_summary = plot.trim();

        }



        // å¤„ç†æ’å…¥ç¦ç”¨çŠ¶æ€

        function handleInsertDisabled() {

            showToast('æœ€å¤šåªèƒ½æ·»åŠ 20é¡µï¼', 'error');

        }



        // åœ¨æŒ‡å®šä½ç½®ä¹‹å‰æ’å…¥æ–°é¡µ

        function modalInsertPageBefore(index) {

            const pageCount = modalStoryData.outline.length;

            

            if (pageCount >= 20) {

                showToast('æœ€å¤šåªèƒ½æ·»åŠ 20é¡µï¼', 'error');

                return;

            }

            

            const newPage = {

                page_number: index + 1,

                scene: '',

                plot_summary: 'è¯·è¾“å…¥æƒ…èŠ‚å†…å®¹...'

            };

            

            modalStoryData.outline.splice(index, 0, newPage);

            

            // é‡æ–°ç¼–å·

            modalStoryData.outline.forEach((page, idx) => {

                page.page_number = idx + 1;

            });

            

            // æ¸²æŸ“å¹¶é«˜äº®æ–°æ’å…¥çš„é¡µé¢

            modalRenderOutline(index);

            modalUpdatePageCount();

            showToast('å·²æ’å…¥æ–°é¡µ');

        }



        // åœ¨æŒ‡å®šä½ç½®ä¹‹åæ’å…¥æ–°é¡µï¼ˆæœ«å°¾æ·»åŠ ï¼‰

        function modalInsertPageAfter(index) {

            const pageCount = modalStoryData.outline.length;

            

            if (pageCount >= 20) {

                showToast('æœ€å¤šåªèƒ½æ·»åŠ 20é¡µï¼', 'error');

                return;

            }

            

            const newPage = {

                page_number: index + 2,

                scene: '',

                plot_summary: 'è¯·è¾“å…¥æƒ…èŠ‚å†…å®¹...'

            };

            

            modalStoryData.outline.splice(index + 1, 0, newPage);

            

            // é‡æ–°ç¼–å·

            modalStoryData.outline.forEach((page, idx) => {

                page.page_number = idx + 1;

            });

            

            // æ¸²æŸ“å¹¶é«˜äº®æ–°æ’å…¥çš„é¡µé¢

            modalRenderOutline(index + 1);

            modalUpdatePageCount();

            showToast('å·²æ·»åŠ æ–°é¡µ');

        }



        // åˆ é™¤é¡µ

        async function modalDeletePage(index) {

            const pageCount = modalStoryData.outline.length;

            

            if (pageCount <= 6) {

                await showAlert('è‡³å°‘éœ€è¦ä¿ç•™6é¡µï¼');

                return;

            }

            

            const confirmed = await showConfirm(

                `ç¡®å®šè¦åˆ é™¤ç¬¬ ${modalStoryData.outline[index].page_number} é¡µå—ï¼Ÿ`,

                'åˆ é™¤é¡µé¢'

            );

            

            if (confirmed) {

                modalStoryData.outline.splice(index, 1);

                

                // é‡æ–°ç¼–å·

                modalStoryData.outline.forEach((page, idx) => {

                    page.page_number = idx + 1;

                });

                

                modalRenderOutline();

                modalUpdatePageCount();

                showToast('å·²åˆ é™¤é¡µé¢');

            }

        }



        // ä¿å­˜è‰ç¨¿

        function saveOutlineDraft() {

            if (!modalStoryData.core_elements.title.trim()) {

                showToast('è¯·è¾“å…¥æ•…äº‹æ ‡é¢˜ï¼', 'error');

                return;

            }

            

            // ä¿å­˜æ•°æ®åˆ°æœåŠ¡å™¨/æ•°æ®åº“

            console.log('ä¿å­˜è‰ç¨¿æ•°æ®ï¼š', JSON.stringify(modalStoryData, null, 2));

            

            // å…³é—­å¼¹çª—

            document.getElementById('outlineModal').classList.add('hidden');

            document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨

            

            // æ˜¾ç¤ºæˆåŠŸæç¤º

            showToast('âœ… è‰ç¨¿å·²ä¿å­˜åˆ°æˆ‘çš„ç»˜æœ¬');

            

            // å®é™…é¡¹ç›®ä¸­åº”è¯¥è·³è½¬åˆ°"æˆ‘çš„ç»˜æœ¬"é¡µé¢

            // setTimeout(() => {

            //     window.location.href = 'my-books.html';

            // }, 1000);

        }



        // ç”Ÿæˆç»˜æœ¬

        function generateStorybookFromModal() {

            if (!modalStoryData.core_elements.title.trim()) {

                showToast('è¯·è¾“å…¥æ•…äº‹æ ‡é¢˜ï¼', 'error');

                return;

            }

            if (modalStoryData.core_elements.characters.length === 0) {

                showToast('è‡³å°‘éœ€è¦ä¸€ä¸ªè§’è‰²ï¼', 'error');

                return;

            }

            if (modalStoryData.core_elements.settings.length === 0) {

                showToast('è‡³å°‘éœ€è¦ä¸€ä¸ªåœºæ™¯ï¼', 'error');

                return;

            }



            for (let i = 0; i < modalStoryData.outline.length; i++) {

                const page = modalStoryData.outline[i];

                if (!page.scene) {

                    showToast(`ç¬¬ ${page.page_number} é¡µæœªé€‰æ‹©åœºæ™¯ï¼`, 'error');

                    return;

                }

                if (!page.plot_summary.trim()) {

                    showToast(`ç¬¬ ${page.page_number} é¡µæœªå¡«å†™æƒ…èŠ‚å†…å®¹ï¼`, 'error');

                    return;

                }

            }



            console.log('ç”Ÿæˆç»˜æœ¬ï¼Œæ•°æ®ï¼š', JSON.stringify(modalStoryData, null, 2));

            // å…³é—­å¤§çº²å¼¹çª—
            document.getElementById('outlineModal').classList.add('hidden');
            document.body.style.overflow = '';

            // æ˜¾ç¤ºç”Ÿæˆè¿›åº¦å¼¹çª—å¹¶å¼€å§‹æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
            simulateGeneration();

        }



        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯

        function showToast(message, type = 'success') {

            const toast = document.getElementById('toast');

            toast.textContent = message;

            

            // é‡ç½®ç±»åå¹¶æ˜¾ç¤º

            toast.className = `fixed top-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[100] transition-opacity ${

                type === 'error' ? 'bg-red-500' : 'bg-gray-900'

            } text-white opacity-100`;

            

            // ç§»é™¤ pointer-events-none ä»¥ç¡®ä¿å¯è§

            toast.classList.remove('pointer-events-none');

            

            // 3ç§’åè‡ªåŠ¨éšè—

            setTimeout(() => {

                toast.classList.remove('opacity-100');

                toast.classList.add('opacity-0');

                

                // å®Œå…¨éšè—åæ·»åŠ  pointer-events-none

                setTimeout(() => {

                    toast.classList.add('pointer-events-none');

                }, 300);

            }, 3000);

        }



        // ESCé”®å…³é—­å¼¹çª—

        document.addEventListener('keydown', function(e) {

            if (e.key === 'Escape') {

                const modal = document.getElementById('outlineModal');

                if (!modal.classList.contains('hidden')) {

                    closeOutlineModal();

                }

            }

        });

    </script>

<!-- Code injected by live-server -->

<script>

	// <![CDATA[  <-- For SVG support

	if ('WebSocket' in window) {

		(function () {

			function refreshCSS() {

				var sheets = [].slice.call(document.getElementsByTagName("link"));

				var head = document.getElementsByTagName("head")[0];

				for (var i = 0; i < sheets.length; ++i) {

					var elem = sheets[i];

					var parent = elem.parentElement || head;

					parent.removeChild(elem);

					var rel = elem.rel;

					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {

						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');

						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());

					}

					parent.appendChild(elem);

				}

			}

			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';

			var address = protocol + window.location.host + window.location.pathname + '/ws';

			var socket = new WebSocket(address);

			socket.onmessage = function (msg) {

				if (msg.data == 'reload') window.location.reload();

				else if (msg.data == 'refreshcss') refreshCSS();

			};

			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {

				console.log('Live reload enabled.');

				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);

			}

		})();

	}

	else {

		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');

	}

        // è¿›åº¦å¼¹çª—ç®¡ç†
        let generationState = {
            isGenerating: false,
            currentStep: 0,
            totalImages: 0,
            completedImages: 0
        };

        // æ˜¾ç¤ºè¿›åº¦å¼¹çª—
        function showProgressModal() {
            document.getElementById('progressModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            generationState.isGenerating = true;
            generationState.currentStep = 1;
            updateProgressDisplay();
        }

        // å…³é—­è¿›åº¦å¼¹çª—
        function closeProgressModal() {
            document.getElementById('progressModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        // å–æ¶ˆç”Ÿæˆ
        function cancelGeneration() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç”Ÿæˆå—ï¼Ÿ')) {
                generationState.isGenerating = false;
                closeProgressModal();
                showToast('å·²å–æ¶ˆç”Ÿæˆ', 'error');
            }
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNumber, status) {
            const stepElement = document.getElementById(`step${stepNumber}`);
            const iconContainer = stepElement.querySelector('.flex-shrink-0');
            const iconElement = document.getElementById(`step${stepNumber}-icon`);
            const titleElement = stepElement.querySelector('.font-medium');
            const descElement = document.getElementById(`step${stepNumber}-detail`);
            const statusElement = document.getElementById(`step${stepNumber}-status`);

            // æ­¥éª¤æè¿°æ–‡æœ¬
            const stepDescriptions = {
                1: {
                    pending: 'å‡†å¤‡è§£ææ•…äº‹ç»“æ„å’Œè§’è‰²å…³ç³»...',
                    active: 'æ­£åœ¨æ·±åº¦åˆ†ææ•…äº‹ç»“æ„å’Œè§’è‰²å…³ç³»...',
                    completed: 'âœ“ å·²è§£ææ•…äº‹ç»“æ„å’Œè§’è‰²å…³ç³»'
                },
                2: {
                    pending: 'ç­‰å¾…ç¼–å†™è¯¦ç»†çš„æ•…äº‹å†…å®¹...',
                    active: 'æ­£åœ¨ç¼–å†™è¯¦ç»†çš„æ•…äº‹å†…å®¹...',
                    completed: 'âœ“ å·²ç¼–å†™å®Œæ•´çš„æ•…äº‹è„šæœ¬'
                },
                3: {
                    pending: 'ç­‰å¾…é¡µé¢å¸ƒå±€è®¾è®¡...',
                    active: 'æ­£åœ¨è®¾è®¡é¡µé¢å¸ƒå±€...',
                    completed: 'âœ“ å·²å®Œæˆé¡µé¢å¸ƒå±€è®¾è®¡'
                },
                4: {
                    pending: 'ç­‰å¾…AIç»˜åˆ¶ç²¾ç¾æ’å›¾...',
                    active: 'æ­£åœ¨ç”Ÿæˆç²¾ç¾æ’å›¾...',
                    completed: 'âœ“ å·²ç”Ÿæˆæ‰€æœ‰æ’å›¾'
                }
            };

            // å›¾æ ‡æ˜ å°„
            const stepIcons = {
                1: 'search',
                2: 'file-text', 
                3: 'layout',
                4: 'image'
            };

            // æ›´æ–°å®¹å™¨æ ·å¼å’Œå›¾æ ‡ - ä¸å¤§çº²ç”Ÿæˆå¼¹çª—ä¿æŒä¸€è‡´
            if (status === 'pending') {
                stepElement.className = 'flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300';
                iconContainer.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center';
                iconElement.outerHTML = '<i id="step' + stepNumber + '-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>';
                statusElement.textContent = 'ç­‰å¾…ä¸­';
                statusElement.className = 'text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full';
                titleElement.className = 'font-medium text-gray-700 mb-1';
                descElement.className = 'text-sm text-gray-500';
                descElement.textContent = stepDescriptions[stepNumber].pending;
            } else if (status === 'active') {
                stepElement.className = 'flex items-center gap-4 p-4 rounded-xl bg-blue-50 border border-blue-300 transition-all duration-300';
                iconContainer.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center';
                iconElement.outerHTML = '<i id="step' + stepNumber + '-icon" data-lucide="loader-2" class="w-5 h-5 text-white animate-spin"></i>';
                statusElement.textContent = 'è¿›è¡Œä¸­';
                statusElement.className = 'text-sm font-medium text-blue-600 px-3 py-1 bg-blue-200 rounded-full';
                titleElement.className = 'font-medium text-blue-800 mb-1';
                descElement.className = 'text-sm text-blue-600';
                descElement.textContent = stepDescriptions[stepNumber].active;
            } else if (status === 'completed') {
                stepElement.className = 'flex items-center gap-4 p-4 rounded-xl bg-green-50 border border-green-300 transition-all duration-300';
                iconContainer.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-green-500 flex items-center justify-center';
                iconElement.outerHTML = '<i id="step' + stepNumber + '-icon" data-lucide="check-circle" class="w-5 h-5 text-white"></i>';
                statusElement.textContent = 'å·²å®Œæˆ';
                statusElement.className = 'text-sm font-medium text-green-600 px-3 py-1 bg-green-200 rounded-full';
                titleElement.className = 'font-medium text-green-800 mb-1';
                descElement.className = 'text-sm text-green-600';
                descElement.textContent = stepDescriptions[stepNumber].completed;
            }

            // é‡æ–°åˆå§‹åŒ–Lucideå›¾æ ‡
            lucide.createIcons();
        }


        // æ›´æ–°æ•´ä½“è¿›åº¦æ˜¾ç¤º
        function updateProgressDisplay() {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤ä¸ºpendingçŠ¶æ€
            for (let i = 1; i <= 4; i++) {
                updateStep(i, 'pending');
            }

            // è®¾ç½®å½“å‰æ­¥éª¤ä¸ºactive
            if (generationState.currentStep <= 4) {
                updateStep(generationState.currentStep, 'active');
            }

            // è®¾ç½®å·²å®Œæˆçš„æ­¥éª¤
            for (let i = 1; i < generationState.currentStep; i++) {
                updateStep(i, 'completed');
            }

            // æ›´æ–°çŠ¶æ€æ–‡å­— - ç°åœ¨é€šè¿‡æ­¥éª¤çŠ¶æ€æ˜¾ç¤ºï¼Œä¸éœ€è¦é¢å¤–çš„çŠ¶æ€æ–‡å­—
        }

        // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
        function simulateGeneration() {
            showProgressModal();

            // ç¬¬1æ­¥ï¼šåˆ†ææ•…äº‹å¤§çº² (3ç§’)
            setTimeout(() => {
                generationState.currentStep = 2;
                updateProgressDisplay();

                // ç¬¬2æ­¥ï¼šç”Ÿæˆæ•…äº‹è„šæœ¬ (5ç§’)
                setTimeout(() => {
                    generationState.currentStep = 3;
                    updateProgressDisplay();

                    // ç¬¬3æ­¥ï¼šä¼˜åŒ–å›¾ç‰‡æè¿° (3ç§’)
                    setTimeout(() => {
                        generationState.currentStep = 4;
                        updateProgressDisplay();

                        // ç¬¬4æ­¥ï¼šç”Ÿæˆæ’å›¾ (æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹)
                        setTimeout(() => {
                            updateStep(4, 'completed');
                            // ç”Ÿæˆå®Œæˆ
                            setTimeout(() => {
                                closeProgressModal();
                                showToast('ç»˜æœ¬ç”Ÿæˆå®Œæˆï¼');
                                // è‡ªåŠ¨æ‰“å¼€ç»˜æœ¬æŸ¥çœ‹çª—å£
                                setTimeout(() => {
                                    openStorybookViewer();
                                }, 500);
                            }, 2000);
                        }, 4000);

                    }, 3000);
                }, 5000);
            }, 3000);
        }

	// ]]>

</script>

</body>

</html>