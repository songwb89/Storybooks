

<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>AI绘本 - 奕兆科技</title>

    

    <!-- Tailwind CSS -->

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- 绘本阅读器模块 -->
    <script src="js/storybook-reader.js"></script>
    
    <!-- 大纲确认模态窗口组件 -->
    <link rel="stylesheet" href="css/outline-modal.css">
    <script src="js/outline-modal.js"></script>
    
    <!-- 生成进度窗口组件 -->
    <script src="js/generation-progress.js"></script>

    

    <script>

        tailwind.config = {

            theme: {

                extend: {

                    colors: {

                        primary: {

                            50: '#f0f3ff',

                            100: '#e0e7ff',

                            200: '#c7d2fe',

                            300: '#a5b4fc',

                            400: '#818cf8',

                            500: '#6366f1',

                            600: '#4f46e5',

                            700: '#4338ca',

                            800: '#3730a3',

                            900: '#312e81',

                        },

                    }

                }

            }

        }

    </script>

    

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        

        body {

            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;

        }



        /* 新页面高亮动画 */

        @keyframes slideInAndPulse {

            0% {

                transform: translateY(-10px);

                opacity: 0;

            }

            100% {

                transform: translateY(0);

                opacity: 1;

            }

        }



        .page-highlight {

            background-color: #dbeafe !important;

            border-color: #60a5fa !important;

            animation: slideInAndPulse 0.4s ease-out;

            transition: background-color 0.5s ease, border-color 0.5s ease;

        }



        .page-highlight-remove {

            background-color: white !important;

            border-color: #e5e7eb !important;

        }


        /* AI加载动画 */
        @keyframes spin-slow {
            to {
                transform: rotate(360deg);
            }
        }

        .animate-spin-slow {
            animation: spin-slow 3s linear infinite;
        }

        /* 绘本翻页过渡动画 */
        .storybook-fade-enter {
            opacity: 0;
            transform: scale(0.98);
        }

        .storybook-fade-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }

        .storybook-fade-exit {
            opacity: 1;
            transform: scale(1);
        }

        .storybook-fade-exit-active {
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.3s ease-in, transform 0.3s ease-in;
        }

        /* 图片加载指示器 */
        .image-loading {
            position: relative;
        }

        .image-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin: -20px 0 0 -20px;
            border: 3px solid #e5e7eb;
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 进度弹窗样式 */
        .step-icon {
            display: inline-block;
            width: 20px;
            text-align: center;
        }

        .rotating {
            animation: spin 1s linear infinite;
        }

        .step-completed {
            color: #10B981;
        }

        .step-active {
            color: #3B82F6;
        }

        .step-pending {
            color: #6B7280;
        }

        /* 输入框抖动动画 */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .shake-animation {
            animation: shake 0.3s ease-in-out;
            border-color: #f59e0b !important; /* 琥珀色 */
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }

        /* 输入框错误状态 */
        .input-error {
            border-color: #f59e0b !important; /* 琥珀色 */
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
        }
    </style>

</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">

    <!-- 顶部导航栏 -->

    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">

        <div class="px-6 py-3 flex justify-between items-center">

            <div class="flex items-center gap-3">

                <div class="w-9 h-9 bg-gradient-to-br from-primary-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold shadow-lg">

                    <i data-lucide="sparkles" class="w-4 h-4"></i>

                </div>

                <span class="text-base font-semibold text-gray-800">奕兆科技</span>

            </div>

            <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 px-3 py-1.5 rounded-lg transition-colors">

                <div class="w-7 h-7 bg-gray-100 rounded-full flex items-center justify-center">

                    <i data-lucide="user" class="w-3.5 h-3.5 text-gray-600"></i>

                </div>

                <span class="text-sm text-gray-600 font-medium">Admin</span>

                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>

            </div>

        </div>

    </header>



    <!-- 返回按钮和我的绘本按钮 -->

    <div class="fixed left-6 top-20 z-40">

        <button onclick="goBack()" class="w-11 h-11 bg-primary-500 hover:bg-primary-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:-translate-x-1 flex items-center justify-center group">

            <i data-lucide="arrow-left" class="w-4 h-4"></i>

        </button>

    </div>

    <div class="fixed right-6 top-20 z-40">

        <button onclick="goToMyBooks()" title="我的绘本" class="w-11 h-11 bg-amber-500 hover:bg-amber-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all hover:scale-105 flex items-center justify-center">

            <i data-lucide="book-open" class="w-4 h-4"></i>

        </button>

    </div>



    <!-- 主容器 -->

    <div class="max-w-6xl mx-auto px-6 py-4 relative">



        <!-- 页面标题 -->

        <div class="text-center mt-4 mb-6">

            <h1 class="text-4xl font-bold text-gray-800 mb-2 bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">

                AI绘本

            </h1>

            <p class="text-gray-500 text-sm">用AI创造属于你的精彩故事</p>

        </div>



        <!-- 输入区域 -->

        <div class="max-w-4xl mx-auto mb-5">

            <div class="relative">

                <textarea 

                    id="storyInput"

                    class="w-full h-28 px-5 py-3 border-2 border-gray-200 rounded-2xl focus:border-primary-400 focus:ring-4 focus:ring-primary-50 outline-none transition-all resize-none text-gray-700 placeholder-gray-400 shadow-sm hover:border-gray-300"

                    placeholder="输入您想创作的绘本故事（如：一只寻找星星的勇敢小狐狸）"

                    maxlength="2000"

                ></textarea>

                <!-- 底部信息栏 -->
                <div class="mt-2 px-1">
                    <!-- 错误提示 -->
                    <div id="storyInputError" class="text-amber-600 text-sm flex items-center gap-1 invisible">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i>
                        <span id="storyInputErrorText"></span>
                    </div>
                </div>

            </div>

        </div>



        <!-- 生成按钮 -->

        <div class="text-center mb-8">

            <button onclick="generateOutline()" class="px-10 py-3 bg-gradient-to-r from-primary-500 to-purple-600 hover:from-primary-600 hover:to-purple-700 text-white rounded-full font-medium shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5 inline-flex items-center gap-2">

                <i data-lucide="wand-2" class="w-5 h-5"></i>

                <span>生成大纲</span>

            </button>

        </div>



        <!-- 精选绘本区域 -->

        <div class="mt-6 max-w-[1400px] mx-auto">

            <div class="flex items-center gap-2 mb-5">

                <i data-lucide="star" class="w-5 h-5 text-amber-500"></i>

                <h2 class="text-xl font-semibold text-gray-800">精选绘本</h2>

            </div>

            

            <div class="grid grid-cols-5 gap-6">

                <!-- 故事卡片 - 真实图片 4:3比例 -->

                <div onclick="selectStory('丑小鸭的春天')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/丑小鸭的春天.png" alt="丑小鸭的春天" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">丑小鸭的春天</h3>

                </div>



                <div onclick="selectStory('狼来了')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/狼来了.png" alt="狼来了" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">狼来了</h3>

                </div>



                <div onclick="selectStory('青蛙王子')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/青蛙王子.png" alt="青蛙王子" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">青蛙王子</h3>

                </div>



                <div onclick="selectStory('亡羊补牢')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/亡羊补牢.png" alt="亡羊补牢" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">亡羊补牢</h3>

                </div>



                <div onclick="selectStory('守株待兔')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/守株待兔.png" alt="守株待兔" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">守株待兔</h3>

                </div>



                <div onclick="selectStory('灰姑娘')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/灰姑娘.png" alt="灰姑娘" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">灰姑娘</h3>

                </div>



                <div onclick="selectStory('卖火柴的小女孩')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/卖火柴的小女孩.png" alt="卖火柴的小女孩" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">卖火柴的小女孩</h3>

                </div>



                <div onclick="selectStory('海的女儿')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/海的女儿.png" alt="海的女儿" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">海的女儿</h3>

                </div>



                <div onclick="selectStory('狐假虎威')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/狐假虎威.png" alt="狐假虎威" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">狐假虎威</h3>

                </div>



                <div onclick="selectStory('龟兔赛跑')" class="group cursor-pointer">

                    <div class="w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-300 hover:-translate-y-2">

                        <img src="images/龟兔赛跑.png" alt="龟兔赛跑" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">

                    </div>

                    <h3 class="mt-3 text-base font-semibold text-gray-800 group-hover:text-primary-600 transition-colors">龟兔赛跑</h3>

                </div>

            </div>

        </div>

    </div>






    <!-- Toast 提示 -->

    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-xl shadow-2xl z-[100] opacity-0 transition-all duration-300 pointer-events-none flex items-center gap-3">
        <i id="toastIcon" data-lucide="check-circle" class="w-5 h-5"></i>
        <span id="toastMessage">操作成功</span>
    </div>

    

    <!-- 生成状态弹窗 -->


    <!-- Confirm 确认对话框 -->

    <div id="confirmModal" class="fixed inset-0 bg-black/50 z-[300] hidden flex items-center justify-center">

        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="confirmDialog">

            <div class="p-6">

                <div class="flex items-start gap-4">

                    <div class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">

                        <i data-lucide="alert-circle" class="w-6 h-6 text-amber-600"></i>

                    </div>

                    <div class="flex-1">

                        <h3 class="text-lg font-semibold text-gray-900 mb-2" id="confirmTitle">确认操作</h3>

                        <p class="text-gray-600 text-sm leading-relaxed" id="confirmMessage">确定要执行此操作吗？</p>

                    </div>

                </div>

            </div>

            <div class="border-t border-gray-100 p-4 flex gap-3 justify-end">

                <button onclick="closeConfirm(false)" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all">

                    取消

                </button>

                <button onclick="closeConfirm(true)" class="px-5 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all" id="confirmButton">

                    确定

                </button>

            </div>

        </div>

    </div>



    <!-- Alert 提示对话框 -->

    <div id="alertModal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center">

        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all scale-95 opacity-0" id="alertDialog">

            <div class="p-6">

                <div class="flex items-start gap-4">

                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">

                        <i data-lucide="info" class="w-6 h-6 text-blue-600"></i>

                    </div>

                    <div class="flex-1">

                        <h3 class="text-lg font-semibold text-gray-900 mb-2">提示</h3>

                        <p class="text-gray-600 text-sm leading-relaxed" id="alertMessage">这是一条提示信息</p>

                    </div>

                </div>

            </div>

            <div class="border-t border-gray-100 p-4 flex justify-end">

                <button onclick="closeAlert()" class="px-6 py-2.5 bg-primary-500 hover:bg-primary-600 text-white rounded-lg font-medium transition-all">

                    确定

                </button>

            </div>

        </div>

    </div>



    <!-- AI生成加载遮罩 -->
    <div id="aiLoadingModal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[150] hidden flex items-center justify-center">
        <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-full mx-4 p-8 transform transition-all scale-95 opacity-0" id="aiLoadingCard">
            

            <!-- 主标题 -->
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">AI正在生成故事大纲</h2>

            <!-- 四阶段状态区 -->
            <div class="space-y-4 mb-8">
                <!-- 阶段1 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage1-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage1-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">分析故事主题</div>
                        <p id="stage1-detail" class="text-sm text-gray-500">准备分析您的故事创意和核心主题...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage1-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">等待中</span>
                    </div>
                </div>

                <!-- 阶段2 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage2-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage2-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">生成角色设定</div>
                        <p id="stage2-detail" class="text-sm text-gray-500">等待创建故事中的主要角色...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage2-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">等待中</span>
                    </div>
                </div>

                <!-- 阶段3 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage3-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage3-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">生成场景设定</div>
                        <p id="stage3-detail" class="text-sm text-gray-500">等待构建故事发生的场景...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage3-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">等待中</span>
                    </div>
                </div>

                <!-- 阶段4 -->
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300" id="stage4-container">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i id="stage4-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-medium text-gray-700 mb-1">生成故事大纲</div>
                        <p id="stage4-detail" class="text-sm text-gray-500">等待编写完整的故事大纲...</p>
                    </div>
                    <div class="flex-shrink-0">
                        <span id="stage4-status" class="text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full">等待中</span>
                    </div>
                </div>
            </div>

            <!-- 总体进度条 -->
            <div class="mb-6">
                <div class="flex items-center justify-center">
                    <div class="text-lg font-medium text-gray-600" id="overall-status">准备开始创作...</div>
                </div>
            </div>

            <!-- 底部提示 -->
            <div class="text-center">
                <p id="loading-tip" class="text-sm text-gray-500 flex items-center justify-center gap-2">
                    <i data-lucide="lightbulb" class="w-4 h-4"></i>
                    <span>AI正在发挥创意，请稍候...</span>
                </p>
            </div>

        </div>

    </div>



    <script>

        // 初始化 Lucide 图标

        lucide.createIcons();



        // ========== 自定义对话框组件 ==========

        

        let confirmCallback = null;

        

        // 自定义 Confirm 对话框

        function showConfirm(message, title = '确认操作', confirmText = '确定') {

            return new Promise((resolve) => {

                const modal = document.getElementById('confirmModal');

                const dialog = document.getElementById('confirmDialog');

                const titleEl = document.getElementById('confirmTitle');

                const messageEl = document.getElementById('confirmMessage');

                const confirmBtn = document.getElementById('confirmButton');

                

                titleEl.textContent = title;

                messageEl.textContent = message;

                confirmBtn.textContent = confirmText;

                

                confirmCallback = resolve;

                

                modal.classList.remove('hidden');

                setTimeout(() => {

                    dialog.classList.remove('scale-95', 'opacity-0');

                    dialog.classList.add('scale-100', 'opacity-100');

                }, 10);

                

                lucide.createIcons();

            });

        }

        

        function closeConfirm(result) {

            const modal = document.getElementById('confirmModal');

            const dialog = document.getElementById('confirmDialog');

            

            dialog.classList.add('scale-95', 'opacity-0');

            dialog.classList.remove('scale-100', 'opacity-100');

            

            setTimeout(() => {

                modal.classList.add('hidden');

                if (confirmCallback) {

                    confirmCallback(result);

                    confirmCallback = null;

                }

            }, 200);

        }

        

        // 自定义 Alert 对话框

        function showAlert(message, title = '提示') {

            return new Promise((resolve) => {

                const modal = document.getElementById('alertModal');

                const dialog = document.getElementById('alertDialog');

                const messageEl = document.getElementById('alertMessage');

                

                messageEl.textContent = message;

                

                window.alertCallback = resolve;

                

                modal.classList.remove('hidden');

                setTimeout(() => {

                    dialog.classList.remove('scale-95', 'opacity-0');

                    dialog.classList.add('scale-100', 'opacity-100');

                }, 10);

                

                lucide.createIcons();

            });

        }

        

        function closeAlert() {

            const modal = document.getElementById('alertModal');

            const dialog = document.getElementById('alertDialog');

            

            dialog.classList.add('scale-95', 'opacity-0');

            dialog.classList.remove('scale-100', 'opacity-100');

            

            setTimeout(() => {

                modal.classList.add('hidden');

                if (window.alertCallback) {

                    window.alertCallback();

                    window.alertCallback = null;

                }

            }, 200);

        }



        // 返回项目入口页

        function goBack() {

            // 点击无反应

        }



        // 进入我的绘本页面

        async function goToMyBooks() {

            window.location.href = 'my-books.html';

        }



        // ========== 故事输入框校验 ==========
        
        // 校验故事输入框
        function validateStoryInput(showError = true) {
            const input = document.getElementById('storyInput');
            const value = input.value.trim();
            const errorDiv = document.getElementById('storyInputError');
            const errorText = document.getElementById('storyInputErrorText');
            
            // 清除之前的错误状态
            input.classList.remove('input-error', 'shake-animation');
            errorDiv.classList.add('invisible');
            
            // 1. 必填校验
            if (!value) {
                if (showError) {
                    errorText.textContent = '请输入故事内容';
                    errorDiv.classList.remove('invisible');
                    input.classList.add('input-error', 'shake-animation');
                    input.focus();
                    setTimeout(() => input.classList.remove('shake-animation'), 500);
                }
                return false;
            }
            
            // 2. 最小长度校验
            if (value.length < 5) {
                if (showError) {
                    errorText.textContent = '至少需要5个字符';
                    errorDiv.classList.remove('invisible');
                    input.classList.add('input-error');
                }
                return false;
            }
            
            // 3. 格式校验：必须包含有效字符（中文、英文或数字）
            if (!/[\u4e00-\u9fa5a-zA-Z0-9]/.test(value)) {
                if (showError) {
                    errorText.textContent = '必须包含文字或数字';
                    errorDiv.classList.remove('invisible');
                    input.classList.add('input-error');
                }
                return false;
            }
            
            return true;
        }
        
        
        // 生成大纲

        async function generateOutline() {
            // 校验输入
            if (!validateStoryInput(true)) {
                return;
            }

            // 显示AI加载动画
            showAILoading();
        }

        // 显示AI加载动画
        function showAILoading() {
            const modal = document.getElementById('aiLoadingModal');
            const card = document.getElementById('aiLoadingCard');
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // 禁止背景滚动
            
            setTimeout(() => {
                card.classList.remove('scale-95', 'opacity-0');
                card.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            lucide.createIcons();
            
            // 开始进度模拟
            startAILoadingProgress();
        }

        // 关闭AI加载动画
        function closeAILoading() {
            const modal = document.getElementById('aiLoadingModal');
            const card = document.getElementById('aiLoadingCard');
            
            card.classList.add('scale-95', 'opacity-0');
            card.classList.remove('scale-100', 'opacity-100');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // 更新阶段状态
        function updateStageStatus(stage, status, detail = '') {
            const container = document.getElementById(`stage${stage}-container`);
            const icon = document.getElementById(`stage${stage}-icon`);
            const statusText = document.getElementById(`stage${stage}-status`);
            const detailText = document.getElementById(`stage${stage}-detail`);
            
            // 更新容器样式和图标
            if (status === 'waiting') {
                container.className = 'flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-200 transition-all duration-300';
                container.querySelector('.w-10').className = 'flex-shrink-0 w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center';
                icon.outerHTML = '<i id="stage' + stage + '-icon" data-lucide="clock" class="w-5 h-5 text-gray-500"></i>';
                statusText.textContent = '等待中';
                statusText.className = 'text-sm font-medium text-gray-500 px-3 py-1 bg-gray-200 rounded-full';
            } else if (status === 'processing') {
                container.className = 'flex items-center gap-4 p-4 rounded-xl bg-blue-50 border border-blue-300 transition-all duration-300';
                container.querySelector('.w-10').className = 'flex-shrink-0 w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center';
                icon.outerHTML = '<i id="stage' + stage + '-icon" data-lucide="loader-2" class="w-5 h-5 text-white animate-spin"></i>';
                statusText.textContent = '进行中';
                statusText.className = 'text-sm font-medium text-blue-600 px-3 py-1 bg-blue-200 rounded-full';
            } else if (status === 'completed') {
                container.className = 'flex items-center gap-4 p-4 rounded-xl bg-green-50 border border-green-300 transition-all duration-300';
                container.querySelector('.w-10').className = 'flex-shrink-0 w-10 h-10 rounded-full bg-green-500 flex items-center justify-center';
                icon.outerHTML = '<i id="stage' + stage + '-icon" data-lucide="check-circle" class="w-5 h-5 text-white"></i>';
                statusText.textContent = '已完成';
                statusText.className = 'text-sm font-medium text-green-600 px-3 py-1 bg-green-200 rounded-full';
            }
            
            // 更新详细信息
            if (detail) {
                detailText.textContent = detail;
            }
            
            lucide.createIcons();
        }

        // 更新总体状态
        function updateOverallStatus(message) {
            const statusElement = document.getElementById('overall-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // 更新提示文案
        function updateLoadingTip(tip) {
            const tipElement = document.getElementById('loading-tip');
            tipElement.innerHTML = `<i data-lucide="lightbulb" class="w-4 h-4"></i><span>${tip}</span>`;
            lucide.createIcons();
        }

        // 开始进度模拟（10秒演示版）
        function startAILoadingProgress() {
            const totalDuration = 10000; // 总时长10秒
            const startTime = Date.now();
            
            const tips = [
                'AI正在发挥创意，为您量身定制故事...',
                '生成的大纲完全可以自由编辑和调整',
                '精彩的角色和情节即将诞生...',
                '您可以随时修改故事的任何细节',
                '每个故事都是独一无二的创作'
            ];
            
            let currentTipIndex = 0;
            
            // 提示文案轮播（每2.5秒切换）
            const tipInterval = setInterval(() => {
                currentTipIndex = (currentTipIndex + 1) % tips.length;
                updateLoadingTip(tips[currentTipIndex]);
            }, 2500);
            
            // 使用setInterval代替requestAnimationFrame，每50ms更新一次
            const updateInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                
                // 阶段1: 0-1s
                if (elapsed < 1000) {
                    updateStageStatus(1, 'processing', '正在深入分析您的故事创意和核心主题...');
                    updateOverallStatus('正在分析主题内容...');
                } 
                // 阶段1完成
                else if (elapsed >= 1000 && elapsed < 1050) {
                    updateStageStatus(1, 'completed', '已识别核心主题和情感基调');
                    updateOverallStatus('主题分析完成，开始创建角色...');
                }
                
                // 阶段2: 1-3.5s
                else if (elapsed >= 1050 && elapsed < 3500) {
                    updateStageStatus(2, 'processing', '正在精心设计主要角色的性格和背景...');
                    updateOverallStatus('正在设计主要角色...');
                }
                // 阶段2完成
                else if (elapsed >= 3500 && elapsed < 3550) {
                    updateStageStatus(2, 'completed', '已创建生动的角色形象和丰富背景');
                    updateOverallStatus('角色创建完成，开始设计场景...');
                }
                
                // 阶段3: 3.5-6s
                else if (elapsed >= 3550 && elapsed < 6000) {
                    updateStageStatus(3, 'processing', '正在构建引人入胜的故事场景...');
                    updateOverallStatus('正在构建故事场景...');
                }
                // 阶段3完成
                else if (elapsed >= 6000 && elapsed < 6050) {
                    updateStageStatus(3, 'completed', '已构建详细而富有想象力的场景');
                    updateOverallStatus('场景设计完成，开始编写故事...');
                }
                
                // 阶段4: 6-10s - 主要时间
                else if (elapsed >= 6050 && elapsed < 10000) {
                    const stage4Progress = ((elapsed - 6050) / 3950) * 100;
                    
                    // 计算当前章节进度
                    const currentChapter = Math.min(Math.ceil(stage4Progress / 100 * 8), 8);
                    updateStageStatus(4, 'processing', `正在编写故事大纲第 ${currentChapter} 章节...`);
                    updateOverallStatus(`正在编写故事大纲... (第 ${currentChapter} 章节)`);
                }
                // 阶段4完成
                else if (elapsed >= 10000) {
                    updateStageStatus(4, 'completed', '已生成完整的故事大纲和章节安排');
                    updateOverallStatus('大纲创作完成！');
                    
                    clearInterval(tipInterval);
                    clearInterval(updateInterval); // 停止更新
                    
                    // 延迟500ms后关闭加载动画，打开大纲确认弹窗
                    setTimeout(() => {
                        closeAILoading();
            setTimeout(() => {

                openOutlineModal();

                        }, 300);
            }, 500);

                }
            }, 50); // 每50ms更新一次
        }



        // 选择精选故事

        async function selectStory(storyName) {

            // 如果是"丑小鸭的春天"，直接打开阅读器
            if (storyName === '丑小鸭的春天') {
                window.storybookReader.open(window.defaultStorybookData);
                return;
            }
            
            // 其他绘本暂时没有效果（原型阶段）
            return;
        }

        // 监听Enter键（Ctrl+Enter提交）

        document.getElementById('storyInput').addEventListener('keydown', function(e) {

            if (e.ctrlKey && e.key === 'Enter') {

                generateOutline();

            }

        });

        // 监听失焦事件，进行校验
        document.getElementById('storyInput').addEventListener('blur', function() {
            const value = this.value.trim();
            // 只有在有内容时才校验（避免刚进入页面就报错）
            if (value.length > 0) {
                validateStoryInput(true);
            }
        });

        // 监听获得焦点事件，清除错误提示
        document.getElementById('storyInput').addEventListener('focus', function() {
            const errorDiv = document.getElementById('storyInputError');
            errorDiv.classList.add('invisible');
            this.classList.remove('input-error');
        });



        // ========== 大纲弹窗相关功能 ==========

        // 故事数据
        let modalStoryData = {
            "core_elements": {
                "title": "丑小鸭的春天",
                "characters": [
                    {"name": "丑小鸭（小鸭子）", "description": "外表与众不同，羽毛灰扑扑，性格敏感善良，渴望被接纳，最终发现自己是一只美丽的天鹅。"},
                    {"name": "农场动物们（鸡、鸭、鹅等）", "description": "起初嘲笑和排挤丑小鸭，代表外界的偏见和不理解。"},
                    {"name": "天鹅群", "description": "优雅友善，最终接纳丑小鸭，象征真正的归属与自我认同。"}
                ],
                "theme": "接纳自我，发现内在价值，真正的美丽源于身份认同与成长。",
                "settings": [
                    {"name": "农场池塘", "description": "故事开端，充满喧闹与排斥，是丑小鸭最初被误解的地方。"},
                    {"name": "荒野沼泽", "description": "丑小鸭流浪的孤独之地，经历寒冷与寂寞，象征成长的考验。"},
                    {"name": "春日湖泊", "description": "故事结局，宁静美丽，丑小鸭在此遇见天鹅群并认出自己的真实身份。"}
                ],
                "page_count": 10
            },
            "outline": [
                {"page_number": 1, "scene": "农场池塘", "plot_summary": "在一个阳光明媚的农场池塘边，鸭妈妈孵出了一窝小鸭，其中一只灰扑扑的小鸭格外与众不同。"},
                {"page_number": 2, "scene": "农场池塘", "plot_summary": "鸡、鸭和鹅都嘲笑他'丑'，不愿和他玩耍，丑小鸭感到伤心又孤单。"},
                {"page_number": 3, "scene": "农场池塘", "plot_summary": "无论他怎么努力融入，大家还是排斥他，丑小鸭决定离开农场，去寻找属于自己的地方。"},
                {"page_number": 4, "scene": "荒野沼泽", "plot_summary": "丑小鸭独自流浪到寒冷的沼泽，风吹雨打，他只能躲在芦苇丛中瑟瑟发抖。"},
                {"page_number": 5, "scene": "荒野沼泽", "plot_summary": "野鸭和大雁对他好奇却冷漠，他依然找不到朋友，冬天来了，他几乎冻僵。"},
                {"page_number": 6, "scene": "荒野沼泽", "plot_summary": "一位农夫好心收留他，但家里的猫和母鸡也嫌弃他，丑小鸭再次选择离开。"},
                {"page_number": 7, "scene": "荒野沼泽", "plot_summary": "漫长的冬天过去，丑小鸭在雪地里挣扎求生，心中始终怀着一丝希望。"},
                {"page_number": 8, "scene": "春日湖泊", "plot_summary": "春天来临，冰雪融化，丑小鸭来到一片清澈宁静的湖泊，水面倒映出他修长的脖颈和洁白的羽毛。"},
                {"page_number": 9, "scene": "春日湖泊", "plot_summary": "一群优雅的天鹅游向他，热情地欢迎他加入，丑小鸭终于明白自己不是丑小鸭，而是一只天鹅。"},
                {"page_number": 10, "scene": "春日湖泊", "plot_summary": "丑小鸭在天鹅群中快乐地游泳、飞翔，他不再自卑，因为他找到了真正的自己和温暖的家。"}
            ]
        };

        // 初始化大纲模态窗口组件
        let indexOutlineModal = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            indexOutlineModal = initOutlineModal({
                onSave: saveOutlineDraft,
                onGenerate: generateStorybookFromModal,
                onClose: () => {
                    console.log('大纲模态窗口已关闭');
                }
            });
        });



        // 打开弹窗
        function openOutlineModal() {
            if (indexOutlineModal) {
                indexOutlineModal.open(modalStoryData, 'create'); // 首页创建模式
            }
        }



























        // 保存草稿
        function saveOutlineDraft(storyData) {
            const data = storyData || modalStoryData;
            
            if (!data.core_elements.title.trim()) {
                showToast('请输入故事标题！', 'error');
                return;
            }
            
            // 保存数据到服务器/数据库
            console.log('保存草稿数据：', JSON.stringify(data, null, 2));
            
            // 注意：不需要手动关闭弹窗，saveDraft()方法会自动关闭
            // 也不需要显示提示，saveDraft()方法已经显示了"草稿已保存"
            
            // 实际项目中应该跳转到"我的绘本"页面
            // setTimeout(() => {
            //     window.location.href = 'my-books.html';
            // }, 1000);
        }



        // 生成绘本
        function generateStorybookFromModal(storyData) {
            const data = storyData || modalStoryData;
            
            if (!data.core_elements.title.trim()) {
                showToast('请输入故事标题！', 'error');
                return;
            }
            if (data.core_elements.characters.length === 0) {
                showToast('至少需要一个角色！', 'error');
                return;
            }
            if (data.core_elements.settings.length === 0) {
                showToast('至少需要一个场景！', 'error');
                return;
            }

            for (let i = 0; i < data.outline.length; i++) {
                const page = data.outline[i];
                if (!page.scene) {
                    showToast(`第 ${page.page_number} 页未选择场景！`, 'error');
                    return;
                }
                if (!page.plot_summary.trim()) {
                    showToast(`第 ${page.page_number} 页未填写情节内容！`, 'error');
                    return;
                }
            }

            console.log('生成绘本，数据：', JSON.stringify(data, null, 2));
            
            // 关闭大纲弹窗
            if (indexOutlineModal) {
                indexOutlineModal.closeDirectly();
            }

            // 显示生成进度弹窗并开始模拟生成过程
            simulateGeneration();
        }



        // 显示提示消息

        function showToast(message, type = 'success') {

            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            // 根据类型设置图标和背景色
            let bgColor = 'bg-green-500'; // 默认成功是绿色
            let iconName = 'check-circle';
            
            if (type === 'error') {
                bgColor = 'bg-amber-500';
                iconName = 'alert-circle';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
                iconName = 'info';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-500';
                iconName = 'alert-triangle';
            }

            // 重置类名并显示
            toast.className = `fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl z-[100] transition-all duration-300 ${bgColor} text-white opacity-100 transform translate-y-0 flex items-center gap-3`;

            // 更新图标
            toastIcon.setAttribute('data-lucide', iconName);
            lucide.createIcons();

            // 移除 pointer-events-none 以确保可见

            toast.classList.remove('pointer-events-none');

            

            // 3秒后自动隐藏

            setTimeout(() => {

                toast.classList.remove('opacity-100', 'translate-y-0');

                toast.classList.add('opacity-0', '-translate-y-2');

                

                // 完全隐藏后添加 pointer-events-none

                setTimeout(() => {

                    toast.classList.add('pointer-events-none');

                }, 300);

            }, 3000);

        }




    </script>

<!-- Code injected by live-server -->

<script>

	// <![CDATA[  <-- For SVG support

	if ('WebSocket' in window) {

		(function () {

			function refreshCSS() {

				var sheets = [].slice.call(document.getElementsByTagName("link"));

				var head = document.getElementsByTagName("head")[0];

				for (var i = 0; i < sheets.length; ++i) {

					var elem = sheets[i];

					var parent = elem.parentElement || head;

					parent.removeChild(elem);

					var rel = elem.rel;

					if (elem.href && typeof rel != "string" || rel.length == 0 || rel.toLowerCase() == "stylesheet") {

						var url = elem.href.replace(/(&|\?)_cacheOverride=\d+/, '');

						elem.href = url + (url.indexOf('?') >= 0 ? '&' : '?') + '_cacheOverride=' + (new Date().valueOf());

					}

					parent.appendChild(elem);

				}

			}

			var protocol = window.location.protocol === 'http:' ? 'ws://' : 'wss://';

			var address = protocol + window.location.host + window.location.pathname + '/ws';

			var socket = new WebSocket(address);

			socket.onmessage = function (msg) {

				if (msg.data == 'reload') window.location.reload();

				else if (msg.data == 'refreshcss') refreshCSS();

			};

			if (sessionStorage && !sessionStorage.getItem('IsThisFirstTime_Log_From_LiveServer')) {

				console.log('Live reload enabled.');

				sessionStorage.setItem('IsThisFirstTime_Log_From_LiveServer', true);

			}

		})();

	}

	else {

		console.error('Upgrade your browser. This Browser is NOT supported WebSocket for Live-Reloading.');

	}

        // 初始化生成进度组件
        const generationProgress = new GenerationProgress();
        
        // 设置取消回调
        generationProgress.onCancel((bookId) => {
            showToast('已取消生成', 'error');
        });

        // 模拟生成过程（使用新组件）
        function simulateGeneration() {
            const bookId = 'index-story-' + Date.now();
            
            // 显示进度窗口
            generationProgress.show(bookId, 1);
            
            // 第1步：分析故事大纲 (3秒)
            setTimeout(() => {
                if (!generationProgress.isInProgress() || generationProgress.getCurrentBookId() !== bookId) return;
                generationProgress.completeStep(1);
                generationProgress.setCurrentStep(2);

                // 第2步：生成故事脚本 (5秒)
                setTimeout(() => {
                    if (!generationProgress.isInProgress() || generationProgress.getCurrentBookId() !== bookId) return;
                    generationProgress.completeStep(2);
                    generationProgress.setCurrentStep(3);

                    // 第3步：生成插图 (7秒)
                    setTimeout(() => {
                        if (!generationProgress.isInProgress() || generationProgress.getCurrentBookId() !== bookId) return;
                        generationProgress.completeStep(3);
                        
                        // 生成完成
                        generationProgress.complete(() => {
                            showToast('✅ 绘本生成完成！', 'success');
                            // 自动打开绘本查看窗口
                            setTimeout(() => {
                                window.storybookReader.open(window.defaultStorybookData);
                            }, 500);
                        });
                    }, 7000);
                }, 5000);
            }, 3000);
        }

	// ]]>

</script>

</body>

</html>